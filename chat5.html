<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ú†Øªâ€ŒØ¨Ø§Øª</title>
  <style>
    @font-face{
      font-family: "IRANYekanX";
      src: url("./IRANYekanX-Light.woff2") format("woff2");
      font-weight: 300; font-style: normal; font-display: swap;
    }

    :root{
      --bg:#f8f9fb; --card:#fff; --ink:#111; --muted:#6b7280; --radius:18px; --fz:16px;
      --bubble-user:#8b5cf6; --bubble-user-ink:#fff; --bubble-bot:#fff; --bubble-bot-bd:#eef2f7;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --tool:.86rem; --snack-bg:#111; --snack-ink:#fff;
      --green:#22c55e; --green-ink:#fff; --chip:#0f172a; --chip-ink:#fff;
    }
    .dark{
      --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#9aa4b2;
      --bubble-user:#1f2937; --bubble-user-ink:#e5e7eb;
      --bubble-bot:#0b1220; --bubble-bot-bd:#1f2937;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --snack-bg:#0b1220; --snack-ink:#e5e7eb;
      --chip:#334155; --chip-ink:#e5e7eb;
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:IRANYekanX, Tahoma, Arial, sans-serif;color:var(--ink);font-size:var(--fz)}
    .wrap{max-width:1000px;margin:24px auto;padding:0 14px}
    .head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select, textarea, input, button{border:1px solid #e5e7eb;border-radius:10px;padding:8px;font-family:IRANYekanX, Tahoma, Arial, sans-serif}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:0}
    .msgs{height:60vh;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
    .bubble{max-width:68%;padding:12px 14px;border-radius:14px;line-height:1.9;position:relative}
    .user{align-self:flex-end;background:var(--bubble-user);color:var(--bubble-user-ink);border-bottom-right-radius:8px}
    .bot{align-self:flex-start;background:var(--bubble-bot);border:1px solid var(--bubble-bot-bd);border-bottom-left-radius:8px}
    .foot{display:flex;gap:10px;padding:10px;border-top:1px solid #eef2f7}
    .foot input{flex:1;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;outline:none;background:transparent;color:var(--ink)}
    .btn{border:0;background:#111;color:#fff;border-radius:12px;padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:6px}
    .dark .btn{background:#334155}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .pill{font-size:12px;color:#475569;background:#eef2ff;padding:2px 8px;border-radius:999px}
    .dark .pill{background:#1f2937;color:#cbd5e1}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size:12px;color:#0f172a}
    .dark .mono{color:#cbd5e1}
    .err{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d}
    .dark .err{background:#3f1d1d;border-color:#6b1d1d;color:#fecaca}
    .rendered :is(h1,h2,h3){margin:8px 0}
    .rendered h2{font-size:18px}
    .rendered ul{padding-inline-start:22px}
    .rendered code{background:#f1f5f9;padding:1px 4px;border-radius:6px}
    .dark .rendered code{background:#1f2937;color:#e5e7eb}
    .rendered pre{background:#0f172a;color:#e2e8f0;padding:10px;border-radius:10px;overflow:auto;position:relative;margin-top:8px}
    .dark .rendered pre{background:#111827;color:#e5e7eb}
    .rendered pre code{background:transparent !important}

    /* Ø§Ú©Ø´Ù† Ø¨ÛŒØ±ÙˆÙ† Ø­Ø¨Ø§Ø¨ (Ø¯Ùˆ Ø³ØªÙˆÙ†Ù‡ØŒ Ù…Ø«Ù„ Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª) */
    .msg-row{display:flex;gap:8px;align-items:flex-start}
    .msg-actions{
  display:flex;
  flex-direction:column;     /* Ø¹Ù…ÙˆØ¯ÛŒ */
  gap:8px;
  opacity:.9;
  min-width:28px;
  align-items:center;
  margin-top:4px;
}
.inline-tools{
  display:flex;
  align-items:center;
  gap:14px;
  padding-top:6px;           /* Ú©Ù…ÛŒ ÙØ§ØµÙ„Ù‡ Ø§Ø² Ù…ØªÙ† */
  opacity:.95;
  font-size:0;               /* ÙÙ‚Ø· Ø¢ÛŒÚ©Ù† */
}
.inline-tools .tool-btn svg{ /* Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¢ÛŒÚ©Ù†â€ŒÙ‡Ø§ Ø¯Ø§Ø®Ù„ Ø±Ø¯ÛŒÙ */
  width: var(--tool);
  height: var(--tool);
}


    .tool-btn{background:transparent;border:0;cursor:pointer;padding:0;display:inline-flex;align-items:center;justify-content:center}
    .tool-btn svg{width:var(--tool);height:var(--tool);fill:currentColor}
    .liked .thumb-up{color:#16a34a}
    .disliked .thumb-down{color:#dc2626}

    .code-copy{position:absolute; top:6px; inset-inline-end:6px;background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25);color:#e2e8f0; border-radius:8px; padding:3px 6px; font-size:12px; cursor:pointer;display:flex; align-items:center; gap:6px; backdrop-filter: blur(2px)}
    .dark .code-copy{background:rgba(0,0,0,.25);border-color:rgba(255,255,255,.15)}
    .code-copy svg{width:12px;height:12px}

    .gear{cursor:pointer;font-size:0;user-select:none;border:none;background:transparent;padding:6px;display:inline-flex;align-items:center;justify-content:center}
    .gear svg{width:20px;height:20px;fill:var(--ink)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:90}
    .modal.show{display:flex}
    .modal-card{background:#fff;border-radius:16px;max-width:520px;width:100%;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .dark .modal-card{background:#0b1220;color:#e5e7eb}
    .modal-card h3{margin:0 0 10px 0;font-size:18px}
    .modal-row{display:grid;gap:8px;margin:12px 0}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end}
    .link{background:#0f172a;color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;font-family:IRANYekanX, Tahoma, Arial, sans-serif}
    .dark .link{background:#334155}
    .ghost{background:#eef2f7;color:#111}
    .dark .ghost{background:#1f2937;color:#e5e7eb}

    /* ÙÙ‡Ø±Ø³Øª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ */
    .chats{display:flex;gap:6px;align-items:center}
    .icon-btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:6px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .dark .icon-btn{background:#0f172a;border-color:#1f2937}
    .icon-btn svg{width:16px;height:16px;fill:var(--ink)}
    .chat-list{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:95}
    .chat-list.show{display:flex}
    .chat-panel{background:#fff;border-radius:16px;max-width:700px;width:100%;padding:16px;max-height:80vh;display:flex;flex-direction:column}
    .dark .chat-panel{background:#0b1220;color:#e5e7eb}
    .chat-list-header{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .chat-search{display:flex;gap:8px;align-items:center}
    .chat-items{overflow:auto}
    .chat-item{padding:10px;border:1px solid #e5e7eb;border-radius:10px;cursor:pointer;margin-bottom:8px;display:flex;justify-content:space-between;gap:8px}
    .dark .chat-item{border-color:#1f2937}
    .chat-item h4{margin:0 0 4px 0;font-size:15px}
    .chat-item small{color:var(--muted)}
    .chat-del{border:0;background:transparent;cursor:pointer}
    .chat-del svg{width:16px;height:16px;fill:#b91c1c}

    /* Ø§Ø³Ù†Ú©â€ŒØ¨Ø§Ø± ÙˆØ§Ú¯Ø±Ø¯ */
    .snack{position:fixed;inset-inline:0;bottom:12px;display:flex;justify-content:center;z-index:100}
    .snack-inner{background:var(--snack-bg);color:var(--snack-ink);padding:10px 14px;border-radius:12px;display:flex;gap:12px;align-items:center;box-shadow:var(--shadow)}
    .snack button{background:#fff;color:#111;border:0;border-radius:8px;padding:6px 10px;cursor:pointer;font-family:IRANYekanX}

    /* Ú†ÛŒÙ¾ Ù…Ø¯Ù„ Ùˆ Ù…Ø¯ (Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡) */
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--chip); color:var(--chip-ink);
      border-radius:999px; padding:6px 12px; cursor:pointer; user-select:none;
    }
    .chip .badge{font-size:12px; background:rgba(255,255,255,.12); padding:2px 8px; border-radius:999px}
    .chip .sep{opacity:.4}

    /* Ù…ÙˆØ¯Ø§Ù„ ØªØ¹ÛŒÛŒÙ† Ù…Ø¯Ù„ (Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª 2) */
    .model-card{background:var(--card); color:var(--ink); border-radius:16px; width:min(860px,96vw); box-shadow:var(--shadow); padding:16px}
    .model-grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
    .model-left{
      border:1px solid #e5e7eb; border-radius:12px; overflow:hidden
    }
    .dark .model-left{border-color:#1f2937}
    .model-row{display:grid; grid-template-columns: 1fr 1fr; border-bottom:1px solid #e5e7eb}
    .dark .model-row{border-color:#1f2937}
    .model-cell{padding:10px 12px; cursor:pointer}
    .model-cell:not(.disabled):hover{background:#eef2ff}
    .dark .model-cell:not(.disabled):hover{background:#1f2937}
    .selected{background:var(--green); color:var(--green-ink) !important}
    .model-right{border:1px dashed #cbd5e1; border-radius:12px; padding:12px; font-size:14px; color:var(--muted)}
    .mode-toggle{display:flex; align-items:center; gap:12px; margin-bottom:10px}
    .mode-pill{padding:4px 10px; border-radius:999px; border:1px solid #e5e7eb; cursor:pointer}
    .dark .mode-pill{border-color:#1f2937}
    .mode-pill.active{background:var(--green); color:var(--green-ink); border-color:transparent}
    /* Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ Ø¯Ø± Ø­Ø§Ù„Øª Ø´Ø¨ */
.dark .tool-btn svg,
.dark .inline-tools .tool-btn svg {
  fill: #fff;     /* Ø±Ù†Ú¯ Ø³ÙÛŒØ¯ Ø¨Ø±Ø§ÛŒ SVG */
  color: #fff;    /* Ø¨Ø±Ø§ÛŒ Ø¢ÛŒÚ©Ù†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ color Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù† */
}

  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
  
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="row">
      <div class="chats">
        <button id="openChatList" class="icon-btn" title="ÙÙ‡Ø±Ø³Øª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§" aria-label="Chats">
          <svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm0 5h12v2H3v-2zm0 5h18v2H3v-2z"/></svg>
        </button>
        <button id="newChat" class="icon-btn" title="Ú¯ÙØªâ€ŒÙˆÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯" aria-label="New Chat">
          <svg viewBox="0 0 24 24"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
        </button>
      </div>

      <!-- Ú†ÛŒÙ¾ Ù†Ù…Ø§ÛŒØ´ Ù…Ø¯Ù„/Ø­Ø§Ù„Øª - ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´Ø› Ú©Ù„ÛŒÚ© = Ø¨Ø§Ø²Ú©Ø±Ø¯Ù† Ù¾Ù†Ø¬Ø±Ù‡ ØªØ¹ÛŒÛŒÙ† Ù…Ø¯Ù„ -->
      <div id="modelChip" class="chip" title="ØªØ¹ÛŒÛŒÙ† Ù…Ø¯Ù„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ">
        <span class="badge" id="chipMode">Ø®ÙˆØ¯Ú©Ø§Ø±</span>
        <span class="sep">|</span>
        <span id="chipModel">gpt-5</span>
      </div>

      <span id="status" class="pill">Ø¢Ù…Ø§Ø¯Ù‡</span>
    </div>
    <div class="row">
      <small class="mono" id="probe"></small>
      <button id="openSettings" class="gear" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª" aria-label="Settings">
        <svg viewBox="0 0 24 24"><path d="M19.14,12.94a7.73,7.73,0,0,0,.05-.94,7.73,7.73,0,0,0-.05-.94l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.28,7.28,0,0,0-1.63-.94l-.38-2.65A.5.5,0,0,0,13.8,1H10.2a.5.5,0,0,0-.5.42L9.32,4.07a7.28,7.28,0,0,0-1.63.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L4.86,11.06a7.73,7.73,0,0,0-.05.94,7.73,7.73,0,0,0,.05.94L2.75,14.59a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.28,7.28,0,0,0,1.63.94l.38,2.65a.5.5,0,0,0,.5.42h3.6a.5.5,0,0,0,.5-.42l.38-2.65a7.28,7.28,0,0,0,1.63-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64Zm-7.14,2.56A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
      </button>
    </div>
  </div>

  <div class="card" style="position:relative">
    <div id="msgs" class="msgs"></div>
    <div class="foot">
      <input id="inp" placeholder="Ø§ÛŒÙ†Ø¬Ø§ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯" />
      <button class="btn" id="sendBtn" title="Ø§Ø±Ø³Ø§Ù„">
        <span id="sendIcon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="#fff"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
        </span>
        <span id="stopIcon" style="display:none">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="#fff"><path d="M6 6h12v12H6z"/></svg>
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Ù¾Ù†Ø¬Ø±Ù‡ ÙÙ‡Ø±Ø³Øª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ -->
<div id="chatList" class="chat-list" aria-hidden="true">
  <div class="chat-panel">
    <div class="chat-list-header">
      <h3 style="margin:0">Ú¯ÙØªâ€ŒÙˆÚ¯ÙˆÙ‡Ø§ÛŒ Ù…Ù†</h3>
      <div class="chat-search">
        <input id="chatSearch" placeholder="Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§â€¦" style="min-width:280px">
        <button id="closeChatList" class="icon-btn" title="Ø¨Ø³ØªÙ†">
          <svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" fill="none"/></svg>
        </button>
      </div>
    </div>
    <div id="chatItems" class="chat-items"></div>
  </div>
</div>

<!-- Ù¾Ù†Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø³Ø§Ø®ØªØ§Ø±ÛŒ) -->
<div id="settings" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>
    <div class="modal-row">
      <label>Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø®ØªØµØ§ØµÛŒ (System):</label>
      <textarea id="rulesSettings" rows="4" style="width:100%"></textarea>
    </div>
    <div class="modal-row">
      <label>Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù†ÙˆØ´ØªÙ‡â€ŒÙ‡Ø§: <span id="fzVal">16</span>px</label>
      <input id="fzRange" type="range" min="12" max="22" value="16">
    </div>
    <div class="modal-row">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="typewriterToggle" checked>
        Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ù‡ Ú©Ø§Ø±Ø§Ú©ØªØ± Ù¾Ø§Ø³Ø®
      </label>
    </div>
    <div class="modal-row">
      <label>Ù…ÛŒØ§Ù†Ø¨Ø± Ø§Ø±Ø³Ø§Ù„:</label>
      <select id="sendShortcut">
        <option value="enter">Enter</option>
        <option value="ctrlenter">Ctrl + Enter</option>
      </select>
    </div>
    <div class="modal-row">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="animToggle" checked>
        Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø±Ø§Ø¨Ø· ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯
      </label>
    </div>
    <div class="modal-row">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="autoTheme" checked>
        Ø­Ø§Ù„Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø±ÙˆØ²/Ø´Ø¨ (Û±Û¹ ØªØ§ Ûµ:Û³Û° Ø´Ø¨ = ØªÛŒØ±Ù‡)
      </label>
      <div style="display:flex;gap:8px">
        <button id="forceLight" class="ghost link">Ø±ÙˆØ´Ù†</button>
        <button id="forceDark" class="ghost link">ØªØ§Ø±ÛŒÚ©</button>
      </div>
    </div>
    <div class="actions">
      <button id="closeSettings" class="link ghost">Ø¨Ø³ØªÙ†</button>
      <button id="saveSettings" class="link">Ø°Ø®ÛŒØ±Ù‡</button>
    </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹ÛŒÛŒÙ† Ù…Ø¯Ù„ (Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª Ø¯ÙˆÙ…) -->
<div id="modelModal" class="modal" aria-hidden="true">
  <div class="model-card">
    <h3 style="margin-top:0">ØªØ¹ÛŒÛŒÙ† Ù…Ø¯Ù„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</h3>
    <div class="mode-toggle">
      <span class="mode-pill" id="autoModePill">ØªØ¹ÛŒÛŒÙ† Ø®ÙˆØ¯Ú©Ø§Ø±</span>
      <span class="mode-pill" id="manualModePill">ØªØ¹ÛŒÛŒÙ† Ø¯Ø³ØªÛŒ</span>
    </div>

    <div class="model-grid">
      <div class="model-left" id="modelTable">
        <!-- Ø¯Ùˆ Ø³ØªÙˆÙ†Ù Ù†Ø§Ù…â€ŒÙ‡Ø§ Ù…Ø«Ù„ ØªØµÙˆÛŒØ± -->
        <div class="model-row">
          <div class="model-cell" data-model="gpt-5">gpt Ûµ</div>
          <div class="model-cell" data-model="gpt-4.1-mini">gpt Û´.Û± mini</div>
        </div>
        <div class="model-row">
          <div class="model-cell" data-model="gpt-5-chat">gpt Ûµ-chat</div>
          <div class="model-cell" data-model="gpt-4o-mini">gpt Û´o mini</div>
        </div>
        <div class="model-row">
          <div class="model-cell" data-model="gpt-5-mini">gpt Ûµ-mini</div>
          <div class="model-cell" data-model="gemini-1.5-flash-latest">gemini-1.5-flash</div>
        </div>
        <div class="model-row" style="border-bottom:0">
          <div class="model-cell" data-model="gpt-5-nano">gpt Ûµ-nano</div>
          <div class="model-cell disabled" style="opacity:.35;cursor:not-allowed">â€”</div>
        </div>
      </div>

      <div class="model-right">
        <b>ØªØ¹ÛŒÛŒÙ† Ø®ÙˆØ¯Ú©Ø§Ø±</b><br/>
        Ú†Øªâ€ŒØ¨Ø§Øª Ù‡Ù…ÛŒØ´Ù‡ Ù‚ÙˆÛŒâ€ŒØªØ±ÛŒÙ† Ù…Ø¯Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø§Ú¯Ø± Ø¨Ù‡ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù†Ø²Ø¯ÛŒÚ© Ø´Ø¯ ÛŒØ§ Ø®Ø·Ø§ÛŒ Ù…ÙˆÙ‚ØªÛŒ Ø¯ÛŒØ¯ØŒ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø±ÙˆÛŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ø¯Ù„Ù Ø¨Ø¹Ø¯ÛŒ Ø³ÙˆÛŒÛŒÚ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ØªØ§ Ø´Ù…Ø§ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±Ø§ Ø­Ø³ Ù†Ú©Ù†ÛŒØ¯.
        <br/><br/>
        <small>Ø¯Ø± Ø­Ø§Ù„Øª Ø¯Ø³ØªÛŒØŒ Ù…Ø¯Ù„ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ ÙÙ‚Ø· ØªÙˆØ³Ø· Ø®ÙˆØ¯ Ø´Ù…Ø§ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø¯Ø± ØµÙˆØ±Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØªØŒ Ø®Ø·Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</small>
      </div>
    </div>

    <div class="actions" style="margin-top:12px">
      <button id="closeModel" class="link ghost">Ù„ØºÙˆ</button>
      <button id="saveModel" class="link">Ø°Ø®ÛŒØ±Ù‡</button>
    </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Â«Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾ÛŒØ§Ù…Â» -->
<div id="msgInfo" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h3>Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾ÛŒØ§Ù…</h3>
    <div id="msgInfoBody" class="modal-row"></div>
    <div class="actions" id="msgInfoActions"></div>
  </div>
</div>

<!-- Ø§Ø³Ù†Ú©â€ŒØ¨Ø§Ø± ÙˆØ§Ú¯Ø±Ø¯ -->
<div id="snack" class="snack" style="display:none">
  <div class="snack-inner">
    <span id="snackText"></span>
    <button id="snackUndo">ÙˆØ§Ú¯Ø±Ø¯</button>
  </div>
</div>

<script>
const API = "https://mioo-chat.mohamadgpt19.workers.dev/api/chat";
const $ = id => document.getElementById(id);

// UI nodes
const msgsEl = $("msgs");
const inp = $("inp");
const btn = $("sendBtn");
const sendIcon = $("sendIcon");
const stopIcon = $("stopIcon");
const statusEl = $("status");
const probe = $("probe");

// settings
const openSettingsBtn = $("openSettings");
const settingsModal = $("settings");
const rulesSettings = $("rulesSettings");
const saveSettings = $("saveSettings");
const closeSettings = $("closeSettings");
const fzRange = $("fzRange");
const fzVal = $("fzVal");
const typewriterToggle = $("typewriterToggle");
const sendShortcutSel = $("sendShortcut");
const animToggle = $("animToggle");
const autoTheme = $("autoTheme");
const forceLight = $("forceLight");
const forceDark  = $("forceDark");

// chats UI
const openChatList = $("openChatList");
const chatList = $("chatList");
const closeChatList = $("closeChatList");
const chatItems = $("chatItems");
const chatSearch = $("chatSearch");
const newChatBtn = $("newChat");

// snackbar
const snack = $("snack");
const snackText = $("snackText");
const snackUndo = $("snackUndo");

// model chip + modal
const modelChip = $("modelChip");
const chipMode = $("chipMode");
const chipModel = $("chipModel");
const modelModal = $("modelModal");
const autoModePill = $("autoModePill");
const manualModePill = $("manualModePill");
const modelTable = $("modelTable");
const closeModel = $("closeModel");
const saveModel = $("saveModel");

// message info modal
const msgInfo = $("msgInfo");
const msgInfoBody = $("msgInfoBody");
const msgInfoActions = $("msgInfoActions");

let busy=false, controller=null, stoppedByUser=false, shouldStopStreaming=false;

// KEYS
const KEY_RULES="custom_rules_v1";
const KEY_FZ="ui_font_size_v1";
const KEY_TW="typewriter_v1";
const KEY_CHATS="chats_v2";
const KEY_ACTIVE_CHAT="active_chat_v1";
const KEY_SHORTCUT="send_shortcut_v1";
const KEY_ANIM="ui_anim_v1";
const KEY_THEME_AUTO="ui_theme_auto_v1";
const KEY_THEME_FORCE="ui_theme_force_v1";
const KEY_MODEL_MODE="model_mode_v1";      // 'auto' | 'manual'
const KEY_MODEL_MANUAL="model_manual_v1";  // string model id
const KEY_RATINGS="message_ratings_v1";    // { [msgId]: 'up' | 'down' }

// Ù‚ÙˆØ§Ù†ÛŒÙ† Ú©Ù„ÛŒ
const GLOBAL_RULES = `
# Ù‚ÙˆØ§Ù†ÛŒÙ† Ú©Ù„ÛŒ (Ø³Ø±Ø§Ø³Ø±ÛŒ)
- Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø±Ø§ ÙØ§Ø±Ø³ÛŒ Ùˆ Ø¨Ø§ Markdown ØªÙ…ÛŒØ² Ø¨Ù†ÙˆÛŒØ³.
- ØªÛŒØªØ±Ù‡Ø§ Ø±Ø§ **Ø¨ÙˆÙ„Ø¯** Ú©Ù† Ùˆ Ø²ÛŒØ± Ù‡Ø± ØªÛŒØªØ± ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ø¨Ø¯Ù‡.
- Ø¨Ø±Ø§ÛŒ Ú©Ø¯ØŒ ÙÙ‚Ø· Ø¨Ù„Ø§Ú© Ú©Ø¯ Ø¨Ø¯Ù‡Ø› Ø§Ø² ØªÙˆØ¶ÛŒØ­ Ø§Ø¶Ø§ÙÛŒ Ù¾Ø±Ù‡ÛŒØ² Ú©Ù† Ù…Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯.
`;

// ØªÙ…
function applyTheme(){
  const force = localStorage.getItem(KEY_THEME_FORCE) || "";
  const auto = localStorage.getItem(KEY_THEME_AUTO)!=="0";
  let dark=false;
  if (force==="dark") dark=true;
  else if (force==="light") dark=false;
  else if (auto){
    const now=new Date(); const h=now.getHours()+now.getMinutes()/60;
    dark=(h>=19 || h<5.5);
  }
  document.documentElement.classList.toggle("dark", dark);
}
autoTheme.checked = localStorage.getItem(KEY_THEME_AUTO)!=="0";
applyTheme();
forceLight.onclick=()=>{ localStorage.setItem(KEY_THEME_FORCE,"light"); localStorage.setItem(KEY_THEME_AUTO,"0"); autoTheme.checked=false; applyTheme(); };
forceDark.onclick =()=>{ localStorage.setItem(KEY_THEME_FORCE,"dark");  localStorage.setItem(KEY_THEME_AUTO,"0"); autoTheme.checked=false; applyTheme();  };

// init settings
rulesSettings.value = localStorage.getItem(KEY_RULES) || "";
const storedFz = parseInt(localStorage.getItem(KEY_FZ)||"16",10);
document.documentElement.style.setProperty('--fz', storedFz+"px");
document.documentElement.style.setProperty('--tool', (Math.max(12, storedFz-4))+"px");
fzRange.value=storedFz; fzVal.textContent=storedFz;
const storedTW = localStorage.getItem(KEY_TW);
if (storedTW!==null) typewriterToggle.checked = storedTW==="1";
sendShortcutSel.value = localStorage.getItem(KEY_SHORTCUT) || "enter";
animToggle.checked = localStorage.getItem(KEY_ANIM)!=="0";
fzRange.oninput=()=>{ const v=parseInt(fzRange.value,10)||16; fzVal.textContent=String(v);
  document.documentElement.style.setProperty('--fz', v+"px");
  document.documentElement.style.setProperty('--tool', (Math.max(12, v-4))+"px");
};

// dialogs open/close
openSettingsBtn.onclick=()=>{ settingsModal.classList.add("show"); settingsModal.setAttribute("aria-hidden","false"); };
closeSettings.onclick = closeModal;
function closeModal(){ settingsModal.classList.remove("show"); settingsModal.setAttribute("aria-hidden","true"); }
saveSettings.onclick=()=>{ localStorage.setItem(KEY_RULES, rulesSettings.value||"");
  const v=parseInt(fzRange.value,10);
  document.documentElement.style.setProperty('--fz', v+"px");
  document.documentElement.style.setProperty('--tool', (Math.max(12, v-4))+"px");
  localStorage.setItem(KEY_FZ, String(v));
  localStorage.setItem(KEY_TW, typewriterToggle.checked ? "1":"0");
  localStorage.setItem(KEY_SHORTCUT, sendShortcutSel.value);
  localStorage.setItem(KEY_ANIM, animToggle.checked ? "1":"0");
  localStorage.setItem(KEY_THEME_AUTO, autoTheme.checked ? "1":"0");
  if (autoTheme.checked) localStorage.setItem(KEY_THEME_FORCE,"");
  applyTheme(); closeModal();
};
settingsModal.addEventListener("click",(e)=>{ if(e.target===settingsModal) closeModal(); });

// chat storage helpers
const uid=()=> "c_"+Math.random().toString(36).slice(2,9);
const mid=()=> "m_"+Math.random().toString(36).slice(2,10);
const loadChats=()=>{ try{return JSON.parse(localStorage.getItem(KEY_CHATS)||"[]")}catch{return[]} };
const saveChats=(chs)=> localStorage.setItem(KEY_CHATS, JSON.stringify(chs));
function createNewActiveChat(){
  const id=uid(); const chs=loadChats();
  chs.unshift({id, title:"Ú¯ÙØªâ€ŒÙˆÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯", messages:[], updatedAt:Date.now()});
  saveChats(chs); localStorage.setItem(KEY_ACTIVE_CHAT, id);
  msgsEl.innerHTML="";
}
function currentChat(){ const id=localStorage.getItem(KEY_ACTIVE_CHAT); return loadChats().find(c=>c.id===id); }
function updateCurrentChat(up){ const id=localStorage.getItem(KEY_ACTIVE_CHAT); const chs=loadChats(); const i=chs.findIndex(c=>c.id===id); if(i>=0){ up(chs[i]); chs[i].updatedAt=Date.now(); saveChats(chs);} }
function setActiveChat(id){ localStorage.setItem(KEY_ACTIVE_CHAT, id); renderActiveChat(); }

// Ø±Ù†Ø¯Ø±
function renderActiveChat(){
  msgsEl.innerHTML="";
  const chat=currentChat(); if(!chat) return;
  chat.messages.forEach(m=>{
    if(m.role==="user"){
      const row=makeRow(); const b=document.createElement("div"); b.className="bubble user"; b.textContent=m.versions[m.active].content; row.appendChild(b); msgsEl.appendChild(row); row.dataset.id=m.id; attachActions(row,b,m);
    } else {
      const row=makeRow(); const b=document.createElement("div"); b.className="bubble bot"; const r=document.createElement("div"); r.className="rendered"; r.innerHTML=marked.parse(m.versions[m.active].content); b.appendChild(r); msgsEl.appendChild(row); row.appendChild(b); row.dataset.id=m.id; attachActions(row,b,m); normalizeLinks(r);
      r.querySelectorAll("pre").forEach(pre=>{
        const btn=document.createElement("button"); btn.className="code-copy";
        btn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"/></svg><span style="font-family:IRANYekanX">copy code</span>`;
        btn.onclick=async()=>{ const code=pre.querySelector("code")?.innerText||""; await navigator.clipboard.writeText(code); btn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M9 16.17l-3.5-3.5L4 14.17l5 5 12-12-1.41-1.41z"/></svg><span style="font-family:IRANYekanX">Ú©Ù¾ÛŒ Ø´Ø¯</span>`; setTimeout(()=>btn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"/></svg><span style="font-family:IRANYekanX">copy code</span>`,1200); };
        pre.appendChild(btn);
      });
    }
  });
  msgsEl.scrollTop=msgsEl.scrollHeight;
  scrollChatToBottom();

  try{ hljs.highlightAll(); }catch{}
}

// first start
createNewActiveChat();

// chat list modal
openChatList.onclick=()=>{ renderChatList(); chatList.classList.add("show"); chatList.setAttribute("aria-hidden","false"); };
closeChatList.onclick=()=>{ chatList.classList.remove("show"); chatList.setAttribute("aria-hidden","true"); };
chatList.addEventListener("click",(e)=>{ if(e.target===chatList){ closeChatList.onclick(); } });

function renderChatList(filter=""){
  const chs=loadChats();
  const fmt=new Intl.DateTimeFormat('fa-IR-u-ca-persian',{dateStyle:"medium", timeStyle:"short"});
  const q=filter.trim();
  chatItems.innerHTML="";
  chs.forEach(c=>{
    const hay = (c.title+" "+(c.messages||[]).map(m=>m.versions?.[m.active||0]?.content||"").join(" ")).toLowerCase();
    if(q && !hay.includes(q.toLowerCase())) return;

    const div=document.createElement("div"); div.className="chat-item";
    const last= c.updatedAt? fmt.format(new Date(c.updatedAt)) : "-";
    div.innerHTML=`<div><h4>${c.title}</h4><small>Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: ${last}</small></div>`;
    const delBtn=document.createElement("button"); delBtn.className="chat-del"; delBtn.title="Ø­Ø°Ù";
    delBtn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v8h-2V9zm4 0h2v8h-2V9z"/></svg>`;
    delBtn.onclick=(ev)=>{ ev.stopPropagation(); deleteChatWithUndo(c.id, c.title); renderChatList(chatSearch.value); };
    div.appendChild(delBtn);
    div.onclick=()=>{ setActiveChat(c.id); closeChatList.onclick(); };
    chatItems.appendChild(div);
  });
}
chatSearch.oninput=()=> renderChatList(chatSearch.value);
newChatBtn.onclick=()=>{ createNewActiveChat(); renderChatList(chatSearch.value); };

// snackbar undo
let undoTimer=null;
function showSnack(text, onUndo){
  snackText.textContent=text;
  snack.style.display="flex";
  snackUndo.onclick=()=>{ clearTimeout(undoTimer); snack.style.display="none"; onUndo && onUndo(); };
  clearTimeout(undoTimer);
  undoTimer=setTimeout(()=>{ snack.style.display="none"; },5000);
}
function deleteChatWithUndo(id, title){
  const chs=loadChats(); const idx=chs.findIndex(c=>c.id===id);
  if(idx<0) return;
  const removed = chs.splice(idx,1)[0];
  saveChats(chs);
  if(localStorage.getItem(KEY_ACTIVE_CHAT)===id){
    if(!chs.length) createNewActiveChat(); else localStorage.setItem(KEY_ACTIVE_CHAT, chs[0].id);
    renderActiveChat();
  }
  showSnack(`Ø´Ù…Ø§ Ú¯ÙØªÚ¯ÙˆÛŒ Â«${title}Â» Ø±Ø§ Ø­Ø°Ù Ù†Ù…ÙˆØ¯ÛŒØ¯ |`, ()=>{ const chs2=loadChats(); chs2.unshift(removed); saveChats(chs2); });
}

// probe
(async function probeKeys(){
  const okGithub = await check("github","gpt-5-mini"); // ÛŒÚ©ÛŒ Ø§Ø² Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
  const okGemini = await check("gemini","gemini-1.5-flash-latest");
  if (probe) probe.textContent=`GitHub ${okGithub?"âœ…":"âš ï¸"} | Gemini ${okGemini?"âœ…":"âš ï¸"}`;
})();
async function check(provider, model){
  try{
    const r=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider,model,messages:[{role:"user",content:"Ù¾ÛŒÙ†Ú¯"}]})});
    const j=await r.json(); return !!j?.content;
  }catch{return false;}
}

// ====== Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„: ÙˆØ¶Ø¹ÛŒØª Ùˆ UI ======
const PREFERRED_AUTO = ["gpt-5","gpt-5-chat","gpt-5-mini","gpt-5-nano","gpt-4.1-mini","gpt-4o-mini"];
function getMode(){ return localStorage.getItem(KEY_MODEL_MODE) || "auto"; }
function setMode(m){ localStorage.setItem(KEY_MODEL_MODE, m); }
function getManualModel(){ return localStorage.getItem(KEY_MODEL_MANUAL) || "gpt-4.1-mini"; }
function setManualModel(m){ localStorage.setItem(KEY_MODEL_MANUAL, m); }
function getActiveModelLabel(){ // Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù‡Ø¯Ø±
  const mode=getMode();
  if(mode==="manual") return getManualModel();
  // Ø­Ø§Ù„Øª Ø®ÙˆØ¯Ú©Ø§Ø±: Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø² Ù¾Ø§Ø³Ø® Ù…Ø¯Ù„ ÙˆØ§Ù‚Ø¹ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ØŒ Ù‡Ù…Ø§Ù†Ø› ÙˆÚ¯Ø±Ù†Ù‡ Ø§ÙˆÙ„ÙˆÛŒØª Ø§ÙˆÙ„
  return localStorage.getItem("auto_last_model") || PREFERRED_AUTO[0];
}
function setAutoLastModel(m){ localStorage.setItem("auto_last_model", m); }

// Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„
modelChip.onclick=()=>{ openModelChooser(); };
function openModelChooser(){
  const mode=getMode();
  updateModePills(mode);
  // Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÛŒ
  const manual=getManualModel();
  [...modelTable.querySelectorAll(".model-cell")].forEach(cell=>{
    cell.classList.remove("selected");
    if(mode==="manual" && cell.dataset.model===manual) cell.classList.add("selected");
    cell.classList.toggle("disabled", mode==="auto");
  });
  modelModal.classList.add("show"); modelModal.setAttribute("aria-hidden","false");
}
closeModel.onclick=()=>{ closeModelModal(); };
modelModal.addEventListener("click",(e)=>{ if(e.target===modelModal) closeModelModal(); });
function closeModelModal(){ modelModal.classList.remove("show"); modelModal.setAttribute("aria-hidden","true"); }
autoModePill.onclick=()=>{ updateModePills("auto"); };
manualModePill.onclick=()=>{ updateModePills("manual"); };
function updateModePills(mode){
  autoModePill.classList.toggle("active", mode==="auto");
  manualModePill.classList.toggle("active", mode==="manual");
  // ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„â€ŒÙ‡Ø§
  [...modelTable.querySelectorAll(".model-cell")].forEach(cell=>{
    cell.classList.toggle("disabled", mode==="auto");
  });
  // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª Ø±ÙˆÛŒ dataset Ù…ÙˆØ¯Ø§Ù„
  modelModal.dataset.mode = mode;
}
// Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÛŒØªÙ…Ù Ù…Ø¯Ù„ Ø¯Ø± Ø­Ø§Ù„Øª Ø¯Ø³ØªÛŒ
modelTable.addEventListener("click",(e)=>{
  const t=e.target.closest(".model-cell"); if(!t || t.classList.contains("disabled")) return;
  [...modelTable.querySelectorAll(".model-cell")].forEach(c=>c.classList.remove("selected"));
  t.classList.add("selected");
  modelModal.dataset.manual = t.dataset.model;
});
saveModel.onclick=()=>{
  const mode = modelModal.dataset.mode || getMode();
  setMode(mode);
  if(mode==="manual"){
    const chosen = modelModal.dataset.manual || getManualModel();
    setManualModel(chosen);
  }
  refreshModelChip();
  closeModelModal();
};

// Ù‡Ù…ÙˆØ§Ø±Ù‡ Ú†ÛŒÙ¾ Ø±Ø§ ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†
function refreshModelChip(){
  const mode=getMode();
  chipMode.textContent = (mode==="auto") ? "Ø®ÙˆØ¯Ú©Ø§Ø±" : "Ø¯Ø³ØªÛŒ";
  chipModel.textContent = getActiveModelLabel() + (mode==="auto" ? "" : "");
}

// helpers (Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø¯Ø± ØªØ¨ Ø¬Ø¯ÛŒØ¯)
function normalizeLinks(root){ root.querySelectorAll("a[href]").forEach(a=>{ a.target="_blank"; a.rel="noopener noreferrer"; }); }
function providerFromModel(m){ return m.startsWith("gemini-") ? "gemini" : "github"; }
function scrollChatToBottom() {
  const el = document.getElementById("msgs");
  if (!el) return;
  // Ú†Ù†Ø¯ Ø¨Ø§Ø± Ù¾Ø´Øªâ€ŒØ³Ø±Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ù…Ø·Ù…Ø¦Ù†â€ŒØ´Ø¯Ù† Ù¾Ø³ Ø§Ø² Ø±Ù†Ø¯Ø±
  requestAnimationFrame(() => { el.scrollTop = el.scrollHeight; });
  setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50);
  setTimeout(() => { el.scrollTop = el.scrollHeight; }, 150);
}

// Ù¾ÛŒØ§Ù…/Ú©Ø§Ù†ØªÚ©Ø³Øª
function pushMsg(role, content, meta={}){ const id=mid(); updateCurrentChat(c=>{ c.messages.push({id, role, versions:[{content, meta, ts:Date.now()}], active:0}); }); return id; }
function appendVersion(id, content, meta={}){ updateCurrentChat(c=>{ const m=c.messages.find(x=>x.id===id); if(!m) return; m.versions.push({content,meta,ts:Date.now()}); m.active=m.versions.length-1; }); }
function contextLast(n=16){ const ch=currentChat(); if(!ch) return []; return ch.messages.slice(-n).map(m=>({role:m.role, content:m.versions[m.active].content})); }

// Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§
const SVGs={
  copy:`<svg viewBox="0 0 24 24"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"/></svg>`,
  check:`<svg viewBox="0 0 24 24"><path d="M9 16.17l-3.5-3.5L4 14.17l5 5 12-12-1.41-1.41z"/></svg>`,
  retry:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4a8 8 0 1 0 7.446 5.032 1 1 0 1 0-1.888.662A6 6 0 1 1 12 6v2a1 1 0 0 0 2 0V4a1 1 0 0 0-1-1h-4a1 1 0 1 0 0 2h2Z"/></svg>`,
  info:`<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>`, /* Ø¢ÛŒÚ©ÙˆÙ† Ø¬Ø²Ø¦ÛŒØ§Øª Ø¬Ø¯ÛŒØ¯ */
  left:`<svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>`,
  right:`<svg viewBox="0 0 24 24"><path d="M8.59 16.59 10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>`,
  edit:`<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42L18.37 3.29a1.003 1.003 0 0 0-1.42 0L15.13 5.1l3.75 3.75 1.83-1.81z"/></svg>`,
  thumbUp:`<svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h4v11zm12-9a3 3 0 0 0-3-3h-4.31l.95-4.57.03-.32a1 1 0 0 0-.29-.7L13 2 7.59 7.41A2 2 0 0 0 7 8.83V20a2 2 0 0 0 2 2h7a3 3 0 0 0 3-3v-7z"/></svg>`,
  thumbDown:`<svg viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-4V3zM3 12a3 3 0 0 0 3 3h4.31l-.95 4.57-.03.32c0 .26.1.51.29.7L11 22l5.41-5.41A2 2 0 0 0 17 15.17V4a2 2 0 0 0-2-2H8a3 3 0 0 0-3 3v7z"/></svg>`
};

// Ø±Ø£ÛŒâ€ŒÙ‡Ø§
function loadRatings(){ try{return JSON.parse(localStorage.getItem(KEY_RATINGS)||"{}")}catch{return{}} }
function saveRatings(x){ localStorage.setItem(KEY_RATINGS, JSON.stringify(x||{})); }

// Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§
function makeRow(){ const r=document.createElement("div"); r.className="msg-row"; return r; }
function actionsCol(){ const c=document.createElement("div"); c.className="msg-actions"; return c; }
function estimateTokens(text){ return Math.max(1, Math.round((text||"").length/4)); }

function attachActions(row, bubbleEl, msgObj){
  // Ø³ØªÙˆÙ† Ú©Ù†Ø§Ø±ÛŒ (Ø¨ÛŒØ±ÙˆÙ† Ø­Ø¨Ø§Ø¨)
  const col = document.createElement("div");
  col.className = "msg-actions";
  row.appendChild(col);

  // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø±Ø¯ÛŒÙ Ø¯Ø§Ø®Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ Ù¾Ø§Ú©Ø´ Ú©Ù†
  bubbleEl.querySelector(".inline-tools")?.remove();
  const inline = document.createElement("div");
  inline.className = "inline-tools";

  // util Ø³Ø§Ø®Øª Ø¯Ú©Ù…Ù‡
  const btn = (title, svg, on) => {
    const b = document.createElement("button");
    b.className = "tool-btn";
    b.title = title;
    b.innerHTML = svg;
    b.onclick = on;
    return b;
  };

  // --- Ù…Ø´ØªØ±Ú©â€ŒÙ‡Ø§
  const openInfo = () => openMsgInfo ? openMsgInfo(msgObj, bubbleEl) : null;

  // --- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÛŒØ§Ø±
  if (msgObj.role === "assistant"){
    // 1) Ø¨ÛŒØ±ÙˆÙ† Ø­Ø¨Ø§Ø¨: ğŸ‘ / ğŸ‘ Ø¹Ù…ÙˆØ¯ÛŒ
    const upBtn = btn("Ù¾Ø§Ø³Ø® Ø®ÙˆØ¨", SVGs.thumbUp, ()=> rateMessage(msgObj.id, +1));
    const downBtn = btn("Ù¾Ø§Ø³Ø® Ø¨Ø¯", SVGs.thumbDown, ()=> rateMessage(msgObj.id, -1));
    col.appendChild(upBtn);
    col.appendChild(downBtn);

    // 2) Ø¯Ø§Ø®Ù„ Ø­Ø¨Ø§Ø¨ Ù¾Ø§ÛŒÛŒÙ†: ğŸ“‹ / â„¹ï¸ / â†»
    const copyBtn = btn("Ú©Ù¾ÛŒ Ù…ØªÙ† Ù¾Ø§Ø³Ø®", SVGs.copy, async()=>{
      const t = bubbleEl.querySelector(".rendered")?.innerText || "";
      await navigator.clipboard.writeText(t);
      copyBtn.innerHTML = SVGs.check;
      setTimeout(()=>copyBtn.innerHTML = SVGs.copy, 1200);
    });

    const infoBtn = btn("Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾ÛŒØ§Ù…", SVGs.info, openInfo);

    const retryBtn = btn("Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¬Ø¯Ø¯", SVGs.retry, ()=>{
      retryAssistant(msgObj, row, bubbleEl);
    });

    inline.appendChild(copyBtn);
    inline.appendChild(infoBtn);
    inline.appendChild(retryBtn);
    bubbleEl.appendChild(inline); // Ø±Ø¯ÛŒÙ Ø§Ø¨Ø²Ø§Ø± ÙˆØ§Ø±Ø¯ Ø­Ø¨Ø§Ø¨ Ø´ÙˆØ¯
  }

  // --- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
  else {
    // Ø·Ø¨Ù‚ Ø®ÙˆØ§Ø³ØªÙ‡â€ŒØª: Ù†Ù‡ Â«Ù¾Ø§Ø³Ø® Ø®ÙˆØ¨/Ø¨Ø¯Â»ØŒ Ù†Ù‡ Â«Ú©Ù¾ÛŒÂ» Ø¨ÛŒØ±ÙˆÙ†ÛŒ
    // ÙÙ‚Ø· Â«Ø¬Ø²Ø¦ÛŒØ§ØªÂ» Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù¾Ù†Ø¬Ø±Ù‡â€ŒÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾ÛŒØ§Ù…
    const infoBtn = btn("Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾ÛŒØ§Ù…", SVGs.info, openInfo);

    // Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ù…Ø«Ù„ Ø¹Ú©Ø³ Â«â„¹ï¸Â» Ù†Ø²Ø¯ÛŒÚ© Ø¨Ø§Ù„Ø§ÛŒ Ø­Ø¨Ø§Ø¨ Ø¯ÛŒØ¯Ù‡ Ø´ÙˆØ¯:
    // ÛŒÚ© Ø±Ø¯ÛŒÙ Ú©ÙˆÚ†Ú© Ø¯Ø§Ø®Ù„ Ø­Ø¨Ø§Ø¨ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (ÙÙ‚Ø· Ø¢ÛŒÚ©Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª)
    inline.appendChild(infoBtn);
    bubbleEl.appendChild(inline);
  }
}

// Ø¬Ø²ÛŒÛŒØ§Øª Ù¾ÛŒØ§Ù…
function openMsgInfo(msgObj, bubbleEl){
  const v=msgObj.versions[msgObj.active];
  const fmt=new Intl.DateTimeFormat('fa-IR-u-ca-persian',{dateStyle:"medium",timeStyle:"short"});
  const model=v.meta?.model||"-";
  const text = (msgObj.role==="assistant" ? bubbleEl.querySelector(".rendered")?.innerText||v.content : v.content)||"";
  const tokenEst = estimateTokens(text);

  msgInfoBody.innerHTML =
    `<div>Ø´Ù†Ø§Ø³Ù‡ Ù¾ÛŒØ§Ù…: <b>${msgObj.id}</b></div>`+
    `<div>ØªØ§Ø±ÛŒØ®/Ø³Ø§Ø¹Øª: <b>${fmt.format(new Date(v.ts))}</b></div>`+
    (msgObj.role==="assistant" ? `<div>Ù…Ø¯Ù„: <b>${model}</b></div>` : ``)+
    `<div>ØªØ®Ù…ÛŒÙ† ØªÙˆÚ©Ù†: <b>${tokenEst}</b></div>`;

  // Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØµÙˆØµ
  msgInfoActions.innerHTML="";
  const copyBtn=document.createElement("button");
  copyBtn.className="link ghost"; copyBtn.textContent="Ú©Ù¾ÛŒ Ù¾ÛŒØ§Ù…";
  copyBtn.onclick=async()=>{ await navigator.clipboard.writeText(text); };
  msgInfoActions.appendChild(copyBtn);

  if(msgObj.role==="user"){
    const editBtn=document.createElement("button");
    editBtn.className="link"; editBtn.textContent="ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…";
    editBtn.onclick=()=>{ editUserMessage(msgObj, bubbleEl.parentElement, bubbleEl); };
    msgInfoActions.appendChild(editBtn);
  }

  const ok=document.createElement("button");
  ok.className="link"; ok.textContent="Ø¨Ø³ØªÙ†";
  ok.onclick=()=>{ msgInfo.classList.remove("show"); msgInfo.setAttribute("aria-hidden","true"); };
  msgInfoActions.appendChild(ok);

  msgInfo.classList.add("show"); msgInfo.setAttribute("aria-hidden","false");
}

// Ù…ØªÙˆÙ‚Ùâ€ŒØ´Ø¯Ù†
function showStopped(){ addBot("Ù…ØªÙˆÙ‚Ù Ø´Ø¯"); }
function setBusy(b){
  busy=b;
  btn.disabled=false;
  sendIcon.style.display = b ? "none" : "inline";
  stopIcon.style.display = b ? "inline" : "none";
  statusEl.textContent=b?"Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø§Ø³Ø®â€¦":"Ø¢Ù…Ø§Ø¯Ù‡";
}
btn.onclick=()=> { if(busy){ stop(); } else send(); };
inp.addEventListener("keydown",(e)=>{
  const mode=localStorage.getItem(KEY_SHORTCUT)||"enter";
  const isEnter=e.key==="Enter"&&!e.shiftKey, isCtrl=e.key==="Enter"&&(e.ctrlKey||e.metaKey);
  if( (mode==="enter"&&isEnter) || (mode==="ctrlenter"&&isCtrl) ){ e.preventDefault(); busy?stop():send(); }
});
function stop(){ shouldStopStreaming=true; if(controller) controller.abort("user_stop"); stoppedByUser=true; setBusy(false); }

// ØªØ§ÛŒÙ¾Ø±
async function typewriter(container, text){
  const twOn = (localStorage.getItem(KEY_TW)!=="0");
  if(!twOn){ container.innerHTML=marked.parse(text); normalizeLinks(container); try{hljs.highlightAll();}catch{}; return; }
  container.innerHTML=""; let acc="";
  for(let i=0;i<text.length;i++){
    if(shouldStopStreaming) break;
    acc+=text[i];
    container.innerHTML=marked.parse(acc); normalizeLinks(container);
    try{hljs.highlightAll();}catch{};
    await new Promise(r=>setTimeout(r,8));
  }
}

// Ø¹Ù†ÙˆØ§Ù† Ø®ÙˆØ¯Ú©Ø§Ø±
async function maybeSetTitle(){
  const ch=currentChat(); if(!ch) return;
  const uCount=ch.messages.filter(m=>m.role==="user").length;
  if (ch.title==="Ú¯ÙØªâ€ŒÙˆÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯" && uCount>=2){
    try{
      const {provider, model} = getProviderAndModel();
      const r = await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider,model,messages:[
        {role:"system",content:"ÛŒÚ© Ø¹Ù†ÙˆØ§Ù† Ø¨Ø³ÛŒØ§Ø± Ú©ÙˆØªØ§Ù‡ØŒ ÙØ§Ø±Ø³ÛŒ Ùˆ ØªÛŒØªØ±â€ŒÙˆØ§Ø± Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…ÙˆØ¶ÙˆØ¹ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†. ÙÙ‚Ø· Ø®ÙˆØ¯ Ø¹Ù†ÙˆØ§Ù† Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†."},
        {role:"user",content: ch.messages.find(m=>m.role==="user")?.versions[0]?.content || ""}
      ]})});
      const j=await r.json(); const title=(j?.content||"Ú¯ÙØªâ€ŒÙˆÚ¯Ùˆ").slice(0,80);
      const id=localStorage.getItem(KEY_ACTIVE_CHAT);
      const chs=loadChats(); const i=chs.findIndex(x=>x.id===id); if(i>=0){ chs[i].title=title; saveChats(chs); }
    }catch{}
  }
}

// Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¯Ù„ Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
function getProviderAndModel(){
  let model;
  if(getMode()==="manual"){
    model = getManualModel();
  }else{
    // Ø®ÙˆØ¯Ú©Ø§Ø±: Ù‚ÙˆÛŒâ€ŒØªØ±ÛŒÙ† Ú©Ø§Ù†Ø¯ÛŒØ¯
    model = PREFERRED_AUTO[0];
  }
  return { model, provider: providerFromModel(model) };
}

// Ø§Ø±Ø³Ø§Ù„
async function send(){
  const text=inp.value.trim(); if(!text||busy) return;

  addUser(text); inp.value=""; inp.focus();
  maybeSetTitle();

  setBusy(true); stoppedByUser=false; shouldStopStreaming=false; controller=new AbortController();

  try{
    const {provider, model} = getProviderAndModel();
    const payload=[
      {role:"system", content:GLOBAL_RULES.trim()},
      ...( (localStorage.getItem(KEY_RULES)||"").trim() ? [{role:"system", content:(localStorage.getItem(KEY_RULES)||"").trim()}] : []),
      ...contextLast(16),
      {role:"user", content:text}
    ];
    const r=await fetch(API,{
  method:"POST",
  signal:controller.signal,
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({provider,model,messages:payload, auto:(getMode()==="auto")})
});

    const raw=await r.text(); let j=null; try{j=JSON.parse(raw)}catch{ addBot(`Raw: ${raw}`,true); setBusy(false); return;}
    if(j?.content){
      const usedModel = j.model || model;
      if(getMode()==="auto"){ setAutoLastModel(usedModel); refreshModelChip(); } // Ù†Ù…Ø§ÛŒØ´ Ù…Ø¯Ù„ ÙˆØ§Ù‚Ø¹ÛŒ
      const meta={model: usedModel};
      const res=addBot("",false,meta);
      await typewriter(res.bubble.querySelector(".rendered"), j.content);
      appendVersion(res.id, j.content, meta);
      res.row.ensureArrows && res.row.ensureArrows?.();
    }else addBot(`Ø®Ø·Ø§: ${j?.error||"unknown"}\n\nRaw: ${JSON.stringify(j?.detail??j)}`,true);
  }catch(e){
    if(stoppedByUser) showStopped(); else addBot("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ù…Ø±ÙˆØ±Ú¯Ø±: "+(e?.message||e), true);
  }finally{ setBusy(false); controller=null; }
}

// Ù…Ø¬Ø¯Ø¯
async function retryAssistant(msgObj, row, bubbleEl){
  setBusy(true); stoppedByUser=false; shouldStopStreaming=false; controller=new AbortController();
  try{
    const {provider, model} = getProviderAndModel();
    const ctx=contextLast(16);
    const r=await fetch(API,{
  method:"POST",
  signal:controller.signal,
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({provider,model,messages:ctx, auto:(getMode()==="auto")})
});

    const raw=await r.text(); let j=null; try{j=JSON.parse(raw)}catch{ addBot(`Raw: ${raw}`,true); setBusy(false); return;}
    if(j?.content){
      const usedModel = j.model || model;
      if(getMode()==="auto"){ setAutoLastModel(usedModel); refreshModelChip(); }
      const rendered=bubbleEl.querySelector(".rendered");
      await typewriter(rendered, j.content);
      appendVersion(msgObj.id, j.content, {model: usedModel});
      row.ensureArrows && row.ensureArrows();
    }else addBot(`Ø®Ø·Ø§: ${j?.error||"unknown"}\n\nRaw: ${JSON.stringify(j?.detail??j)}`,true);
  }catch(e){ if(e?.name==="AbortError") showStopped(); else addBot("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ù…Ø±ÙˆØ±Ú¯Ø±: "+(e?.message||e),true); }
  finally{ setBusy(false); controller=null; }
}

// ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø± (Ø§Ø² Ø¯Ø§Ø®Ù„ Ø¬Ø²Ø¦ÛŒØ§Øª)
function editUserMessage(msgObj, row, bubbleEl){
  const current = msgObj.versions[msgObj.active].content;
  const next = prompt("ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…:", current);
  if (next===null || next.trim()===current.trim()) { msgInfo.classList.remove("show"); msgInfo.setAttribute("aria-hidden","true"); return; }
  appendVersion(msgObj.id, next.trim(), {edited:true});
  bubbleEl.textContent = next.trim();
  // Ù¾Ø§Ø³Ø® Ø¬Ø¯ÛŒØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø§Ù†ØªÚ©Ø³Øª ØªØ§ Ù‡Ù…ÛŒÙ† Ù¾ÛŒØ§Ù…:
  const ch=currentChat();
  const idx = ch.messages.findIndex(m=>m.id===msgObj.id);
  const ctx = ch.messages.slice(0, idx+1).map(m=>({role:m.role, content:m.versions[m.active].content}));

  (async ()=>{
    setBusy(true); stoppedByUser=false; shouldStopStreaming=false; controller=new AbortController();
    try{
      const {provider, model} = getProviderAndModel();
      const payload=[{role:"system",content:GLOBAL_RULES.trim()}, ...((localStorage.getItem(KEY_RULES)||"").trim()?[{role:"system",content:(localStorage.getItem(KEY_RULES)||"").trim()}]:[]), ...ctx];
      const r=await fetch(API,{
  method:"POST",
  signal:controller.signal,
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({provider,model,messages:payload, auto:(getMode()==="auto")})
});

      const raw=await r.text(); let j=null; try{j=JSON.parse(raw)}catch{ addBot(`Raw: ${raw}`,true); setBusy(false); return;}
      if(j?.content){
        const usedModel = j.model || model;
        if(getMode()==="auto"){ setAutoLastModel(usedModel); refreshModelChip(); }
        const meta={model: usedModel}; const res=addBot("",false,meta);
        await typewriter(res.bubble.querySelector(".rendered"), j.content);
        appendVersion(res.id, j.content, meta);
        res.row.ensureArrows && res.row.ensureArrows();
      }else addBot(`Ø®Ø·Ø§: ${j?.error||"unknown"}\n\nRaw: ${JSON.stringify(j?.detail??j)}`,true);
    }catch(e){ if(e?.name==="AbortError") showStopped(); else addBot("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ù…Ø±ÙˆØ±Ú¯Ø±: "+(e?.message||e),true); }
    finally{ setBusy(false); controller=null; }
  })();

  msgInfo.classList.remove("show"); msgInfo.setAttribute("aria-hidden","true");
}

// Ø§ÙØ²ÙˆØ¯Ù† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
function addUser(text){
  const row=makeRow(); const b=document.createElement("div"); b.className="bubble user"; b.textContent=text; row.appendChild(b); msgsEl.appendChild(row); msgsEl.scrollTop=msgsEl.scrollHeight;
  scrollChatToBottom();

  const id=pushMsg("user", text); row.dataset.id=id; const msg=currentChat().messages.find(m=>m.id===id); attachActions(row,b,msg); return id;
}
function addBot(markdown, asError=false, meta={}, existingRow=null, existingId=null){
  const row= existingRow || makeRow(); const b=document.createElement("div");
  b.className="bubble bot"+(asError?" err":"");
  const r=document.createElement("div"); r.className="rendered"; r.innerHTML=marked.parse(markdown||""); b.appendChild(r);
  normalizeLinks(r);
  r.querySelectorAll("pre").forEach(pre=>{
    const btn=document.createElement("button"); btn.className="code-copy"; btn.innerHTML=`${SVGs.copy}<span style="font-family:IRANYekanX">copy code</span>`;
    btn.onclick=async()=>{ const code=pre.querySelector("code")?.innerText||""; await navigator.clipboard.writeText(code); btn.innerHTML=`${SVGs.check}<span style="font-family:IRANYekanX">Ú©Ù¾ÛŒ Ø´Ø¯</span>`; setTimeout(()=>btn.innerHTML=`${SVGs.copy}<span style="font-family:IRANYekanX">copy code</span>`,1200); };
    pre.appendChild(btn);
  });
  if(!existingRow){ row.appendChild(b); msgsEl.appendChild(row); }
  msgsEl.scrollTop=msgsEl.scrollHeight;
  scrollChatToBottom();

  let id=existingId; if(!id){ id=pushMsg("assistant", markdown, meta); row.dataset.id=id; }
  const msg=currentChat().messages.find(m=>m.id===id);
  attachActions(row,b,msg);
  try{ hljs.highlightAll(); }catch{}
  return {row,id,bubble:b};
}

// Ø¢ØºØ§Ø²
addBot("ğŸ˜ºØ³Ù„Ø§Ù…! Ú†Ù‡ Ú©Ù…Ú©ÛŒ Ù…ÛŒØªÙˆÙ†Ù… Ø¨Ù‡Øª Ø¨Ú©Ù†Ù…ØŸ");
renderActiveChat();
refreshModelChip();

// Ù‡Ø§ÛŒâ€ŒÙ„Ø§ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡
try{ hljs.highlightAll(); }catch{}
</script>
</body>
</html>
