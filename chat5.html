<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ú†Øªâ€ŒØ¨Ø§Øª (On-Device)</title>
  <style>
    @font-face{
      font-family:'IRANYekanX';
      src:url('https://s34.picofile.com/file/8486538992/IRANYekanX_Light_woff2.html') format('woff2');
      font-weight:300;font-style:normal;font-display:swap;
    }
    :root{--bg:#f6f7fb;--card:#fff;--muted:#6b7280;--ink:#111;--radius:20px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:'IRANYekanX',Tahoma,sans-serif}
    .wrap{max-width:920px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border-radius:22px;box-shadow:0 12px 34px rgba(0,0,0,.06);overflow:hidden}
    .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eef2f7}
    .title{font-weight:700}
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
    .status{font-size:12px;color:#64748b}
    .msgs{height:62vh;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px;background:#fafbff}
    .m{max-width:75%;padding:12px 14px;border-radius:14px;line-height:1.9;white-space:pre-wrap;word-wrap:break-word}
    .user{align-self:flex-end;background:#111;color:#fff;border-bottom-right-radius:6px}
    .bot{align-self:flex-start;background:#fff;border:1px solid #eef2f7;border-bottom-left-radius:6px}
    .foot{display:flex;gap:10px;padding:12px;border-top:1px solid #eef2f7;background:#fff}
    .foot input{flex:1;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;outline:none}
    .foot button{padding:12px 16px;border:0;border-radius:12px;background:#111;color:#fff;cursor:pointer}
    .foot button[disabled]{opacity:.6;cursor:not-allowed}
    .spinner{width:16px;height:16px;border:3px solid #e5e7eb;border-top-color:#111;border-radius:50%;animation:spin .9s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hint{font-size:12px;color:#6b7280;margin:10px 14px 0}
    .progress{font-size:12px;color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="title">Ú†Øªâ€ŒØ¨Ø§Øª</div>
          <span class="badge">On-Device</span>
        </div>
        <div id="status" class="status">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¯Ù„â€¦</div>
      </div>

      <div id="msgs" class="msgs"></div>

      <div class="foot">
        <input id="inp" placeholder="Ø¨Ù†ÙˆÛŒØ³â€¦ (Enter = Ø§Ø±Ø³Ø§Ù„)" />
        <button id="sendBtn" disabled>Ø§Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
    <div class="hint">
      Ø¨Ø§Ø± Ø§ÙˆÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø¯Ù„ Ú©Ù…ÛŒ Ø·ÙˆÙ„ Ù…ÛŒâ€ŒÚ©Ø´Ù‡ (Ø¨Ø¹Ø¯Ø§Ù‹ Ú©Ø´ Ù…ÛŒâ€ŒØ´Ù‡). Ø§Ú¯Ø± Ù¾Ø§Ø³Ø®ÛŒ Ù†ÛŒÙˆÙ…Ø¯ØŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ WebGPU Ù…Ø±ÙˆØ±Ú¯Ø± Ø±Ùˆ Ú†Ú© Ú©Ù†.
    </div>
  </div>

  <!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§ØµÙ„ÛŒ: WebLLM Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² CDN Ù…ÛŒâ€ŒØ¢ÙˆØ±ÛŒÙ… -->
  <script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

    // âš™ï¸ ÛŒÚ© Ù…Ø¯Ù„ Ø³Ø¨Ú© Ùˆ Ú†Ù†Ø¯Ø²Ø¨Ø§Ù†Ù‡ (ÙØ§Ø±Ø³ÛŒâ€ŒØ¯ÙˆØ³Øª) â€“ Ø§Ú¯Ø± Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ØªØ± Ø®ÙˆØ§Ø³ØªÛŒØŒ Ø¨Ú¯Ùˆ Ø¹ÙˆØ¶Ø´ Ú©Ù†Ù….
    const MODEL = "Qwen2-1.5B-Instruct-q4f16_1-MLC";

    const msgsEl = document.getElementById("msgs");
    const inp = document.getElementById("inp");
    const btn = document.getElementById("sendBtn");
    const statusEl = document.getElementById("status");

    // Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ù‡ Ø³Ø¨Ú© OpenAI
    const messages = [
      { role: "system", content: "ØªÙˆ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± ÙØ§Ø±Ø³ÛŒâ€ŒØ¨Ù„Ø¯ Ùˆ Ú©Ù…Ú©â€ŒØ­Ø§Ù„ÛŒ. Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø±Ùˆ Ú©ÙˆØªØ§Ù‡ØŒ Ø´ÙØ§Ù Ùˆ Ù…ÙˆØ¯Ø¨Ø§Ù†Ù‡ Ø¨Ø¯Ù‡." }
    ];

    // Ù¾ÛŒØ§Ù… Ú©Ù…Ú©ÛŒ UI
    function addMsg(role, text){
      const div = document.createElement("div");
      div.className = "m " + (role==="user"?"user":"bot");
      div.textContent = text;
      msgsEl.appendChild(div);
      msgsEl.scrollTop = msgsEl.scrollHeight;
      return div;
    }
    function setBusy(b){ btn.disabled = b; statusEl.innerHTML = b ? '<span class="spinner"></span> Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†â€¦' : 'Ø¢Ù…Ø§Ø¯Ù‡'; }

    // ğŸ”„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…ÙˆØªÙˆØ± + Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø§Ù†Ù„ÙˆØ¯
    let engine;
    const initProgressCallback = (p)=>{
      // p: { progress, text, timeElapsed, timeRemaining, ... }
      statusEl.textContent = `Ø¯Ø§Ù†Ù„ÙˆØ¯/Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø¯Ù„: ${Math.round((p.progress||0)*100)}% - ${p.text||""}`;
    };
    (async ()=>{
      try{
        engine = await CreateMLCEngine(MODEL, { initProgressCallback });
        statusEl.textContent = "Ù…Ø¯Ù„ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª";
        btn.disabled = false;
      }catch(err){
        statusEl.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„: " + err.message;
        console.error(err);
      }
    })();

    // âœ‰ï¸ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
    async function send(){
      const text = inp.value.trim();
      if(!text || !engine) return;
      inp.value = "";
      const u = addMsg("user", text);
      const b = addMsg("assistant", ""); // Ø¸Ø±Ù Ù¾Ø§Ø³Ø®
      setBusy(true);

      try{
        const stream = await engine.chat.completions.create({
          messages: [...messages, { role: "user", content: text }],
          stream: true,
          temperature: 0.7
        });
        let reply = "";
        for await (const chunk of stream){
          const delta = chunk.choices?.[0]?.delta?.content || "";
          reply += delta;
          b.textContent = reply;
        }
        // Ù¾ÛŒØ§Ù… Ú©Ø§Ù…Ù„Ù Ø¨Ø§Øª
        messages.push({ role:"user", content:text });
        messages.push({ role:"assistant", content:reply });
      }catch(err){
        b.textContent = "Ø®Ø·Ø§: " + err.message;
        console.error(err);
      }finally{
        setBusy(false);
      }
    }

    btn.addEventListener("click", send);
    inp.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }});

    // Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯
    addMsg("assistant","Ø³Ù„Ø§Ù…! Ù…Ù† Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù… ğŸ™‚ Ù‡Ø± Ú†ÛŒ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ø¨Ù¾Ø±Ø³.");
  </script>
</body>
</html>
