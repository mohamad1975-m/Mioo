<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ú†Øªâ€ŒØ¨Ø§Øª</title>
  <style>
    :root { --bg:#f8f9fb; --card:#fff; --ink:#111; --muted:#6b7280; --radius:18px; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Tahoma, Arial, sans-serif;color:var(--ink)}
    .wrap{max-width:1000px;margin:24px auto;padding:0 14px}
    .head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select, textarea{border:1px solid #e5e7eb;border-radius:10px;padding:8px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.06);padding:0}
    .msgs{height:60vh;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
    .bubble{max-width:80%;padding:12px 14px;border-radius:14px;line-height:1.9}
    .user{align-self:flex-end;background:#111;color:#fff;border-bottom-right-radius:8px}
    .bot{align-self:flex-start;background:#fff;border:1px solid #eef2f7;border-bottom-left-radius:8px}
    .foot{display:flex;gap:10px;padding:10px;border-top:1px solid #eef2f7}
    .foot input{flex:1;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;outline:none}
    .btn{border:0;background:#111;color:#fff;border-radius:12px;padding:12px 16px;cursor:pointer;display:flex;align-items:center;gap:6px}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .pill{font-size:12px;color:#475569;background:#eef2ff;padding:2px 8px;border-radius:999px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size:12px;color:#0f172a}
    .sys{border-top:1px dashed #e5e7eb;padding:10px;display:grid;gap:6px}
    .sys label{font-size:12px;color:#64748b}
    .err{background:#fee2e2;border:1px solid #fecaca;color:#7f1d1d}
    .rendered :is(h1,h2,h3){margin:8px 0}
    .rendered h2{font-size:18px}
    .rendered ul{padding-inline-start:22px}
    .rendered code{background:#f1f5f9;padding:1px 4px;border-radius:6px}
    .rendered pre{background:#0f172a;color:#e2e8f0;padding:10px;border-radius:10px;overflow:auto}
  </style>
  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="row">
      <select id="model">
        <option value="gpt-4.1-mini">gpt-4.1-mini</option>
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <option value="phi-3.5-mini-instruct">phi-3.5-mini-instruct</option>
        <option value="gemini-1.5-flash-latest">gemini-1.5-flash-latest</option>
        <option value="gemini-1.5-pro-latest">gemini-1.5-pro-latest</option>
      </select>
      <select id="provider">
        <option value="github">GitHub Models</option>
        <option value="gemini">Gemini</option>
      </select>
      <span id="status" class="pill">Ø¢Ù…Ø§Ø¯Ù‡</span>
    </div>
    <div class="row">
      <small class="mono" id="probe"></small>
    </div>
  </div>

  <div class="card">
    <div id="msgs" class="msgs"></div>
    <div class="sys">
      <div>
        <label>Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø®ØªØµØ§ØµÛŒ (System):</label>
        <textarea id="rules" rows="2" placeholder="(Ø§Ø®ØªÛŒØ§Ø±ÛŒ) Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Paste Ú©Ù†ÛŒØ¯."></textarea>
      </div>
    </div>
    <div class="foot">
      <input id="inp" placeholder="Ø¨Ù†ÙˆÛŒØ³â€¦ (Enter = Ø§Ø±Ø³Ø§Ù„)" />
      <button class="btn" id="sendBtn" title="Ø§Ø±Ø³Ø§Ù„"><span id="sendIcon">â¤</span><span id="stopIcon" style="display:none">â–  ØªÙˆÙ‚Ù</span></button>
    </div>
  </div>
</div>

<script>
const API = "https://mioo-chat.mohamadgpt19.workers.dev/api/chat";
const el = (id)=>document.getElementById(id);
const msgsEl = el("msgs");
const modelSel = el("model");
const providerSel = el("provider");
const inp = el("inp");
const btn = el("sendBtn");
const sendIcon = el("sendIcon");
const stopIcon = el("stopIcon");
const rulesTA = el("rules");
const statusEl = el("status");
const probe = el("probe");

let busy = false;
let controller = null;
const KEY_RULES = "custom_rules_v1";

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø®ØªØµØ§ØµÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² localStorage
rulesTA.value = localStorage.getItem(KEY_RULES) || "";
rulesTA.addEventListener("change", ()=> localStorage.setItem(KEY_RULES, rulesTA.value));

// Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯
addBot(`Ø³Ù„Ø§Ù…! ğŸ‘‹
- Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ **Ù‡Ù…ÛŒØ´Ù‡ ÙØ§Ø±Ø³ÛŒ** Ùˆ Ø¨Ù‡ **Markdown ØªÙ…ÛŒØ²** Ù‡Ø³ØªÙ†Ø¯.
- Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ØŒ ØªÛŒØªØ±Ù‡Ø§ **Ø¨ÙˆÙ„Ø¯** Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ø²ÛŒØ± Ù‡Ø± ØªÛŒØªØ± ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ Ù…ÛŒâ€ŒØ¢ÛŒØ¯.
- Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø®ØªØµØ§ØµÛŒ Ø®ÙˆØ¯ØªØ§Ù† Ø±Ø§ Ø¯Ø± Ø¨Ø®Ø´ Ø¨Ø§Ù„Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯.
`);

// Ø±Ù†Ø¯Ø± Ø­Ø¨Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±/Ø¨Ø§Øª
function addUser(text){
  const d=document.createElement("div");
  d.className="bubble user";
  d.textContent=text;
  msgsEl.appendChild(d);
  msgsEl.scrollTop=msgsEl.scrollHeight;
}
function addBot(markdown, asError=false){
  const d=document.createElement("div");
  d.className="bubble bot" + (asError?" err":"");
  const rendered = document.createElement("div");
  rendered.className="rendered";
  if (asError) rendered.innerText = markdown;
  else rendered.innerHTML = marked.parse(markdown || "");
  d.appendChild(rendered);
  msgsEl.appendChild(d);
  msgsEl.scrollTop=msgsEl.scrollHeight;
  return d;
}
function setBusy(b){
  busy = b;
  btn.disabled = false; // ÙÙ‚Ø· Ø¢ÛŒÚ©ÙˆÙ† Ø±Ø§ Ø¹ÙˆØ¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
  sendIcon.style.display = b ? "none" : "inline";
  stopIcon.style.display = b ? "inline" : "none";
  statusEl.textContent = b ? "Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø§Ø³Ø®â€¦" : "Ø¢Ù…Ø§Ø¯Ù‡";
}
btn.addEventListener("click", ()=> busy ? stop() : send());
inp.addEventListener("keydown", (e)=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); busy?stop():send(); }
});

function stop(){
  if (controller) controller.abort();
  setBusy(false);
}

// ØªØ³Øª Ú©Ù„ÛŒØ¯Ù‡Ø§ ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø±
(async function probeKeys(){
  const okGithub = await check("github", "gpt-4.1-mini");
  const okGemini = await check("gemini", "gemini-1.5-flash-latest");
  probe.textContent = `GitHub ${okGithub?"âœ…":"âš ï¸"}  |  Gemini ${okGemini?"âœ…":"âš ï¸"}`;
})();
async function check(provider, model){
  try{
    const r = await fetch(API, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ provider, model, messages:[{role:"user", content:"Ù¾ÛŒÙ†Ú¯"}] })
    });
    const j = await r.json();
    return !!j?.content;
  }catch{ return false; }
}

async function send(){
  const text = inp.value.trim();
  if(!text || busy) return;
  addUser(text);
  inp.value = ""; inp.focus();

  setBusy(true);
  controller = new AbortController();
  try{
    const r = await fetch(API, {
      method: "POST",
      signal: controller.signal,
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        provider: providerSel.value,
        model: modelSel.value,
        // Ù‡Ù…ÛŒØ´Ù‡ ÛŒÚ© Ù¾ÛŒØ§Ù… system Ú©Ù„ÛŒ Ù‡Ù… Ø¯Ø± Worker ØªØ²Ø±ÛŒÙ‚ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        user_rules: rulesTA.value || "",
        messages: [
          { role:"user", content:text }
        ]
      })
    });
    const t = await r.text();
    let j = null;
    try { j = JSON.parse(t) } catch {
      addBot(`Raw: ${t}`, true); setBusy(false); return;
    }
    if (j?.content){
      addBot(j.content);
    }else{
      addBot(`Ø®Ø·Ø§: ${j?.error || "unknown"}\n\nRaw: ${JSON.stringify(j?.detail ?? j)}`, true);
    }
  }catch(e){
    addBot("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ù…Ø±ÙˆØ±Ú¯Ø±: " + (e?.message || e), true);
  }finally{
    setBusy(false); controller = null;
  }
}
</script>
</body>
</html>

