<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>چت‌بات (Multi-Provider)</title>
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--muted:#6b7280;--ink:#111;--radius:20px;
      --brand:#111;--border:#e5e7eb;--bubble:#fafbff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Tahoma, sans-serif}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border-radius:22px;box-shadow:0 12px 34px rgba(0,0,0,.06);overflow:hidden}
    .head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;border-bottom:1px solid #eceff4;flex-wrap:wrap}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#111}
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;background:#ecfdf5;color:#065f46}
    .badge.err{background:#fee2e2;color:#991b1b}
    .msgs{height:66vh;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px;background:var(--bubble)}
    .m{max-width:75%;padding:12px 14px;border-radius:14px;line-height:1.9;white-space:pre-wrap;word-wrap:break-word}
    .user{align-self:flex-end;background:#111;color:#fff;border-bottom-right-radius:6px}
    .bot{align-self:flex-start;background:#fff;border:1px solid #eef2f7;border-bottom-left-radius:6px}
    .foot{display:flex;gap:10px;padding:12px;border-top:1px solid #eef2f7;background:#fff}
    .inp{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:12px;outline:none}
    .sendBtn,.stopBtn{
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      padding:10px 14px;border:0;border-radius:12px;background:var(--brand);color:#fff;cursor:pointer;
    }
    .sendBtn[disabled],.stopBtn[disabled]{opacity:.6;cursor:not-allowed}
    .stopBtn{background:#ef4444}
    .hint{font-size:12px;color:#6b7280;margin:10px 14px 0;text-align:center}
    .icon{width:16px;height:16px;display:inline-block}
    .icon-send{background:conic-gradient(from 45deg, transparent 0 25%, #fff 0 100%), linear-gradient(#fff,#fff);
      width:0; height:0;border-left:8px solid #fff;border-top:6px solid transparent;border-bottom:6px solid transparent;transform:translateY(1px)}
    .status{font-size:12px;color:#64748b;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .ok{color:#065f46}.bad{color:#b91c1c}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="head">
      <div class="row">
        <select id="modelSel"></select>
        <select id="providerSel"></select>
        <span class="badge" id="readyGit">GitHub Models آماده است.</span>
        <span class="badge" id="readyGem">Gemini آماده است.</span>
      </div>
      <div class="status" id="status">آماده.</div>
    </div>

    <div id="msgs" class="msgs"></div>

    <div class="foot">
      <button id="stopBtn" class="stopBtn" disabled>توقف</button>
      <input id="inp" class="inp" placeholder="بنویس… (Enter = ارسال)" />
      <button id="sendBtn" class="sendBtn">
        <span class="icon icon-send"></span>
        <span>ارسال</span>
      </button>
    </div>
  </div>
  <div class="hint" id="hint">
    نکته: اگر مدل اشتباه باشد یا مدل با GitHub PAT ست نشده باشد، پیام خطا پایین می‌آید. اگر Gemini برای چند ثانیه overloaded/429 شد، چندبار تلاش می‌کنیم.
  </div>
</div>

<script>
/* ------------------- مدل‌ها/پراوایدرها ------------------- */
const PROVIDERS = [
  { id: 'github', label: 'GitHub Models' },
  { id: 'gemini', label: 'Gemini' },
];

const MODELS = {
  github: [
    { id: 'gpt-4.1-mini', label: 'gpt-4.1-mini' },
    { id: 'gpt-4o-mini', label: 'gpt-4o-mini' },
    { id: 'meta-llama/llama-3.1-70b-instruct', label: 'Llama 3.1 70B Instruct' },
    { id: 'mistralai/mistral-large-2407', label: 'Mistral Large 24.07' },
    { id: 'google/gemma-2-9b-it', label: 'Gemma 2 9B IT' }
  ],
  gemini: [
    { id: 'gemini-1.5-flash-latest', label: 'gemini-1.5-flash-latest' },
    { id: 'gemini-1.5-pro-latest', label: 'gemini-1.5-pro-latest' }
  ]
};

const providerSel = document.getElementById('providerSel');
const modelSel = document.getElementById('modelSel');
const msgsEl = document.getElementById('msgs');
const inp = document.getElementById('inp');
const sendBtn = document.getElementById('sendBtn');
const stopBtn = document.getElementById('stopBtn');
const statusEl = document.getElementById('status');

PROVIDERS.forEach(p=>{
  const o=document.createElement('option'); o.value=p.id; o.textContent=p.label; providerSel.appendChild(o);
});
providerSel.value='github';
fillModels('github');
function fillModels(pid){
  modelSel.innerHTML='';
  MODELS[pid].forEach(m=>{
    const o=document.createElement('option'); o.value=m.id; o.textContent=m.label; modelSel.appendChild(o);
  });
  if(pid==='github') modelSel.value='gpt-4.1-mini';
  if(pid==='gemini') modelSel.value='gemini-1.5-flash-latest';
}
providerSel.addEventListener('change', ()=>fillModels(providerSel.value));

/* ------------------- UI helpers ------------------- */
function addMsg(role, text){
  const div = document.createElement('div');
  div.className = 'm ' + (role === 'user' ? 'user' : 'bot');
  div.textContent = text || '';
  msgsEl.appendChild(div);
  msgsEl.scrollTop = msgsEl.scrollHeight;
  return div;
}
function setBusy(b){ sendBtn.disabled=b; stopBtn.disabled=!b; statusEl.textContent = b ? 'در حال پاسخ...' : 'آماده.'; }
function showErr(msg){ const d=addMsg('assistant', 'خطا: ' + msg); d.style.borderColor='#fecaca'; d.style.background='#fff1f2'; }
function sanitizePersian(s){
  return s.replace(/\s+([،.!؟:؛])/g,'$1').replace(/([،.!؟:؛])([^\s])/g,'$1 $2').replace(/\u200c{2,}/g,'\u200c');
}

/* ---- استریم با بافر برای فارسی ---- */
let buf='', renderTimer=null;
function bufferedAppend(el, chunk){
  buf += chunk || '';
  if(renderTimer) return;
  renderTimer = setTimeout(()=>{
    el.textContent = sanitizePersian(el.textContent + buf);
    buf=''; renderTimer=null;
    msgsEl.scrollTop = msgsEl.scrollHeight;
  }, 80);
}

/* ------------------- ارسال ------------------- */
let abortCtrl = null;
const historyMsgs = [ { role:'system', content:'شما دستیار فارسی هستید و پاسخ را کوتاه و شفاف بده.' } ];

async function send(){
  const provider = providerSel.value;
  const model = modelSel.value;
  const text = inp.value.trim();
  if(!text) return;

  const u = addMsg('user', text);
  const b = addMsg('assistant', '');
  inp.value = ''; setBusy(true);

  // کنترل توقف
  abortCtrl = new AbortController();
  stopBtn.onclick = ()=>abortCtrl?.abort();

  try{
    if(provider === 'github'){
      // اول سعی می‌کنیم استریم + بافر
      const r = await fetch('/api/chat', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ provider, model, messages:[...historyMsgs,{role:'user',content:text}], stream:true }),
        signal: abortCtrl.signal
      });

      const ct = r.headers.get('content-type') || '';
      if(r.ok && ct.includes('text/event-stream')){
        const reader = r.body.getReader();
        const dec = new TextDecoder();
        let full = '';

        while(true){
          const {value, done} = await reader.read();
          if(done) break;
          const chunk = dec.decode(value, {stream:true});
          const lines = chunk.split(/\n/);
          for(const line of lines){
            if(!line.startsWith('data:')) continue;
            const raw = line.slice(5).trim();
            if(raw === '[DONE]') continue;
            let j; try{ j = JSON.parse(raw); }catch{ continue; }
            const delta = j?.choices?.[0]?.delta?.content || '';
            if(delta){ full += delta; bufferedAppend(b, delta); }
          }
        }

        // اگر خروجی خیلی کوتاه بود، fallback بدون استریم
        if(full.trim().length < 3){
          const j = await fetch('/api/chat',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ provider, model, messages:[...historyMsgs,{role:'user',content:text}], stream:false })
          }).then(r=>r.json()).catch(()=>null);
          const c = j?.choices?.[0]?.message?.content || '';
          b.textContent = sanitizePersian(c || '(no content)');
        } else {
          b.textContent = sanitizePersian(b.textContent);
        }

        historyMsgs.push({ role:'user', content:text });
        historyMsgs.push({ role:'assistant', content:b.textContent });
      } else {
        const j = await r.json().catch(()=>null);
        if(j?.error === 'github_error' && j?.detail==='missing_github_pat'){
          showErr('کلید GitHub Models ست نشده. در Worker → Settings → Secrets مقدار GITHUB_MODELS_PAT را اضافه کن.');
        } else {
          showErr('خروجی خالی از سرور دریافت شد. Raw: ' + JSON.stringify(j));
        }
      }
    }

    if(provider === 'gemini'){
      // Gemini non-stream + backoff در Worker
      const j = await fetch('/api/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ provider, model, messages:[...historyMsgs,{role:'user',content:text}], stream:false }),
        signal: abortCtrl.signal
      }).then(r=>r.json());

      if(j?.choices?.[0]?.message?.content){
        b.textContent = sanitizePersian(j.choices[0].message.content);
        historyMsgs.push({ role:'user', content:text });
        historyMsgs.push({ role:'assistant', content:b.textContent });
      } else {
        showErr('Gemini: ' + (j?.detail?.error?.message || j?.error || 'unknown'));
        b.remove();
      }
    }

  } catch(err){
    if(err?.name === 'AbortError'){
      b.textContent = sanitizePersian((b.textContent||'').trim() || '(stopped)');
    } else {
      showErr('شبکه/مرورگر: ' + err.message);
      b.remove();
    }
  } finally {
    setBusy(false);
    abortCtrl = null;
  }
}

sendBtn.addEventListener('click', send);
inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});

/* آماده بودن پراوایدرها: صرفاً پیام نمایشی */
document.getElementById('readyGit').classList.add('ok');
document.getElementById('readyGem').classList.add('ok');
</script>
</body>
</html>
