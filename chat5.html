<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>چت‌بات</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--muted:#6b7280;--ink:#111;--radius:18px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Tahoma,system-ui,sans-serif}
    .wrap{max-width:940px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
    .head{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eef2f7}
    .head .right{display:flex;gap:8px;align-items:center}
    select{padding:6px 8px;border:1px solid #e5e7eb;border-radius:10px}
    .msgs{height:64vh;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px;background:#fafbff}
    .m{max-width:75%;padding:12px 14px;border-radius:14px;line-height:1.9;white-space:normal;word-wrap:break-word}
    .user{align-self:flex-end;background:#111;color:#fff;border-bottom-right-radius:6px}
    .bot{align-self:flex-start;background:#fff;border:1px solid #eef2f7;border-bottom-left-radius:6px}
    .bot h1,.bot h2,.bot h3{margin:.4em 0 .2em}
    .bot ul{margin:.3em 1.2em}
    .foot{display:flex;gap:10px;padding:12px;border-top:1px solid #eef2f7;background:#fff}
    .foot input{flex:1;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;outline:none}
    .iconbtn{width:44px;min-width:44px;height:44px;display:grid;place-items:center;border:0;border-radius:12px;background:#111;color:#fff;cursor:pointer}
    .iconbtn[disabled]{opacity:.6;cursor:not-allowed}
    .hint{font-size:12px;color:#6b7280;margin:8px 12px}
    .err{background:#fee2e2;border:1px solid #fecaca;color:#991b1b;border-radius:10px;padding:10px}
    .ok{color:#16a34a;font-size:12px}
    .spin{width:16px;height:16px;border:3px solid #e5e7eb;border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="head">
      <div class="right">
        <select id="provider">
          <option value="github">GitHub Models</option>
          <option value="gemini">Gemini</option>
        </select>
        <select id="model"></select>
        <span id="ready" class="ok"></span>
      </div>
      <div style="font-weight:700">چت‌بات</div>
    </div>

    <div id="msgs" class="msgs"></div>

    <div class="hint">
      قوانین اختصاصی (System):<br/>
      <textarea id="rules" rows="2" style="width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:8px" placeholder="قوانین دلخواه را اینجا بنویسید (اختیاری)…"></textarea>
    </div>

    <div class="foot">
      <button id="sendBtn" class="iconbtn" title="ارسال">
        <svg id="sendIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        <svg id="stopIcon" style="display:none" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
      </button>
      <input id="inp" placeholder="بنویس… (Enter = ارسال)"/>
    </div>
  </div>
</div>

<script>
  // --- تنظیم آدرس Worker شما (مطلق) ---
  const API_BASE = "https://mioo-chat.mohamadgpt19.workers.dev";

  // مدل‌ها
  const MODELS = {
    github: [
      "gpt-4.1-mini",
      "gpt-4o-mini",
      "deepseek-v3-0324" // اگر سهمیه رایگان مدل دیپ‌سیک محدود بود، کمتر استفاده کنید
    ],
    gemini: [
      "gemini-1.5-flash-latest",
      "gemini-1.5-pro-latest"
    ]
  };

  // رندر Markdown ساده
  function renderMarkdown(text){
    let html = text
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

    // headings
    html = html.replace(/^###\s?(.*)$/gm,'<h3>$1</h3>');
    html = html.replace(/^##\s?(.*)$/gm,'<h2>$1</h2>');
    html = html.replace(/^#\s?(.*)$/gm,'<h1>$1</h1>');

    // bold
    html = html.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');

    // unordered lists
    html = html.replace(/^(?:-|\*)\s+(.*)$/gm,'<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>)(?![\s\S]*<li>)/g, m => `<ul>${m}</ul>`);
    // paragraphs
    html = html.replace(/\n{2,}/g,'</p><p>');
    html = `<p>${html}</p>`;
    // cleanup nested <p> around headings/lists
    html = html.replace(/<p>(\s*<(h[1-3]|ul)>)/g,'$1')
               .replace(/(<\/h[1-3]|<\/ul>)\s*<\/p>/g,'$1');

    return html;
  }

  const providerSel = document.getElementById("provider");
  const modelSel = document.getElementById("model");
  const readyEl = document.getElementById("ready");
  const msgsEl = document.getElementById("msgs");
  const inp = document.getElementById("inp");
  const btn = document.getElementById("sendBtn");
  const sendIcon = document.getElementById("sendIcon");
  const stopIcon = document.getElementById("stopIcon");
  const rulesEl = document.getElementById("rules");

  let abortController = null;

  function fillModels(){
    const prov = providerSel.value;
    modelSel.innerHTML = "";
    MODELS[prov].forEach(m=>{
      const o = document.createElement("option");
      o.value = o.textContent = m;
      modelSel.appendChild(o);
    });
  }
  providerSel.addEventListener("change", fillModels);
  fillModels();

  function addMsg(role, html, isHTML=false){
    const div = document.createElement("div");
    div.className = "m " + (role==="user" ? "user" : "bot");
    if(isHTML) div.innerHTML = html; else div.textContent = html;
    msgsEl.appendChild(div);
    msgsEl.scrollTop = msgsEl.scrollHeight;
    return div;
  }

  function setBusy(b){
    if (b){
      sendIcon.style.display = "none";
      stopIcon.style.display = "block";
    } else {
      stopIcon.style.display = "none";
      sendIcon.style.display = "block";
    }
    btn.dataset.state = b ? "stop" : "send";
  }

  btn.addEventListener("click", ()=>{
    if (btn.dataset.state === "stop"){
      if (abortController) abortController.abort();
      return;
    }
    send();
  });
  inp.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }
  });

  // تست آماده‌بودن
  async function ping(){
    try{
      const r = await fetch(`${API_BASE}/`, {method:"GET"});
      readyEl.textContent = r.ok ? "آماده" : "مشکل در اتصال";
    }catch{
      readyEl.textContent = "مشکل در اتصال";
    }
  }
  ping();

  async function send(){
    const text = inp.value.trim();
    if(!text) return;
    const provider = providerSel.value;
    const model = modelSel.value;
    const rules = rulesEl.value;

    inp.value = "";
    addMsg("user", text);
    const bot = addMsg("assistant", "", true);
    setBusy(true);

    abortController = new AbortController();

    try{
      const resp = await fetch(`${API_BASE}/api/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          provider, model,
          messages: [{role:"user", content:text}],
          rules
        }),
        signal: abortController.signal
      });

      if(!resp.ok){
        let raw;
        try{ raw = await resp.text(); }catch{ raw = null; }
        bot.innerHTML = `<div class="err">خطا: خروجی خالی از سرور دریافت شد.<br/>Raw: ${raw}</div>`;
        return;
      }

      const reader = resp.body.getReader();
      const dec = new TextDecoder();
      let buf = "";

      while(true){
        const {value, done} = await reader.read();
        if(done) break;
        buf += dec.decode(value, {stream:true});

        const parts = buf.split("\n\n");
        buf = parts.pop() || "";

        for(const chunk of parts){
          if(!chunk.startsWith("data:")) continue;
          const payload = chunk.slice(5).trim();
          if(payload === "[DONE]") continue;

          try{
            const obj = JSON.parse(payload);
            const delta = obj.choices?.[0]?.delta?.content ?? null;
            if(delta !== null){
              // رندر تدریجی
              bot.innerHTML = renderMarkdown(bot.textContent + delta);
            }
          }catch(e){
            // پاسخ Gemini در SSE ممکن است ساختار دیگری داشته باشد؛
            // اگر JSON نبود، صرف‌نظر می‌کنیم.
          }
        }
        msgsEl.scrollTop = msgsEl.scrollHeight;
      }
    }catch(err){
      bot.innerHTML = `<div class="err">خطای شبکه/مرورگر: ${err.message}</div>`;
    }finally{
      setBusy(false);
      abortController = null;
    }
  }
</script>
</body>
</html>
