<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>چت‌بات چند-ارائه‌دهنده</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--muted:#6b7280;--ink:#111;--radius:20px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Tahoma, sans-serif}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border-radius:22px;box-shadow:0 12px 34px rgba(0,0,0,.06);overflow:hidden}
    .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eef2f7;gap:8px}
    .left{display:flex;align-items:center;gap:8px}
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}
    .status{font-size:12px;color:#64748b}
    .controls{display:flex;align-items:center;gap:8px}

    select, input[type="text"]{ padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;font-family:inherit }

    .msgs{height:62vh;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px;background:#fafbff}
    .m{max-width:75%;padding:12px 14px;border-radius:14px;line-height:1.9;white-space:pre-wrap;word-wrap:break-word}
    .user{align-self:flex-end;background:#111;color:#fff;border-bottom-right-radius:6px}
    .bot{align-self:flex-start;background:#fff;border:1px solid #eef2f7;border-bottom-left-radius:6px}

    .foot{display:flex;gap:10px;padding:12px;border-top:1px solid #eef2f7;background:#fff;align-items:center}
    .foot input{flex:1;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;outline:none}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:11px 14px;border:0;border-radius:12px;background:#111;color:#fff;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .ghost{background:#f3f4f6;color:#111}
    .hidden{display:none}
    .hint{font-size:12px;color:#6b7280;margin:10px 14px 0}
    .countdown{font-size:12px;color:#b45309;background:#fff7ed;border:1px solid #fed7aa;padding:6px 10px;border-radius:8px}
    .spinner{width:16px;height:16px;border:3px solid #e5e7eb;border-top-color:#111;border-radius:50%;animation:spin .9s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .send-icon{width:18px;height:18px;display:block}
    .err{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:8px 10px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="left">
          <span class="badge">Multi-Provider</span>
          <span class="status" id="status">آماده</span>
        </div>
        <div class="controls">
          <select id="provider">
            <option value="github">GitHub Models</option>
            <option value="gemini">Gemini</option>
            <option value="deepseek">DeepSeek (direct)</option>
          </select>
          <input id="model" type="text" placeholder="نام مدل (مثل gpt-4.1-mini یا deepseek-v3-0324)" style="width:260px" />
        </div>
      </div>

      <div id="msgs" class="msgs"></div>

      <div class="foot">
        <button id="stopBtn" class="btn ghost hidden">❚❚ توقف</button>
        <input id="inp" placeholder="بنویس… (Enter = ارسال)" />
        <button id="sendBtn" class="btn" title="ارسال">
          <svg class="send-icon" viewBox="0 0 24 24" fill="none">
            <path d="M4 12L20 4l-5 8 5 8-16-8z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
          </svg>
          ارسال
        </button>
      </div>
    </div>
    <div class="hint">آدرس API را مطلق گذاشتیم تا از هر دامنه‌ای کار کند.</div>
  </div>

  <script>
    // 1) آدرس مطلق API (دامنه‌ی ورکرِ خودت)
    const API_URL = "https://mioo-chat.mohamadgpt19.workers.dev/api/chat";

    const msgsEl = document.getElementById("msgs");
    const inp = document.getElementById("inp");
    const sendBtn = document.getElementById("sendBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const providerSel = document.getElementById("provider");
    const modelInp = document.getElementById("model");

    const messages = [{ role: "system", content: "تو یک دستیار فارسی‌بلد و کمک‌حالی. پاسخ‌ها را کوتاه و شفاف بده." }];

    providerSel.value = "github";
    modelInp.value = "deepseek-v3-0324";

    let controller = null;

    function addMsg(role, text, cls="") {
      const div = document.createElement("div");
      div.className = "m " + (role === "user" ? "user" : "bot") + (cls ? " "+cls : "");
      div.textContent = text || "";
      msgsEl.appendChild(div);
      msgsEl.scrollTop = msgsEl.scrollHeight;
      return div;
    }

    function setBusy(b, infoText) {
      sendBtn.disabled = b; inp.disabled = b;
      stopBtn.classList.toggle("hidden", !b);
      statusEl.innerHTML = b ? `<span class="spinner"></span> ${infoText || "در حال پاسخ…"}` : "آماده";
    }

    function countdownUI(seconds, onCancel, onNow) {
      const bar = document.createElement("div");
      bar.className = "countdown";
      let s = seconds;
      const render = () => bar.innerHTML = `سقف رایگان GitHub رسیدیم؛ تلاش خودکار تا <b>${s}</b> ثانیه دیگر… 
        <button id="retryNow" style="margin-right:8px">همین الان تلاش کن</button>
        <button id="cancelRetry" class="ghost" style="margin-right:6px">لغو</button>`;
      render();
      const iv = setInterval(() => { s--; if (s <= 0) { clearInterval(iv); bar.remove(); onNow(); } else render(); }, 1000);
      bar.addEventListener("click", (e) => {
        if (e.target.id === "cancelRetry") { clearInterval(iv); bar.remove(); onCancel?.(); }
        if (e.target.id === "retryNow")   { clearInterval(iv); bar.remove(); onNow?.(); }
      });
      msgsEl.appendChild(bar); msgsEl.scrollTop = msgsEl.scrollHeight;
      return () => { clearInterval(iv); bar.remove(); };
    }

    async function send() {
      const text = inp.value.trim();
      if (!text) return;
      inp.value = "";

      addMsg("user", text);
      const botDiv = addMsg("assistant", "");
      setBusy(true, "در حال پاسخ…");
      messages.push({ role: "user", content: text });

      const provider = providerSel.value;
      const model = modelInp.value.trim() || (provider === "github" ? "gpt-4.1-mini" : provider === "deepseek" ? "deepseek-chat" : "gemini-1.5-flash-latest");

      controller = new AbortController();
      let attempts = 0, stopCountdown;

      const tryOnce = async () => {
        attempts++;
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ provider, model, messages, stream: true }),
          signal: controller.signal
        });

        if (resp.status === 429) {
          const data = await safeJSON(resp);
          if (data?.error === "rate_limit" && data?.waitSeconds) {
            return { rateLimit: true, waitSeconds: data.waitSeconds };
          }
          throw new Error("429");
        }

        const ct = resp.headers.get("content-type") || "";
        if (ct.includes("text/event-stream")) {
          const reader = resp.body.getReader();
          const decoder = new TextDecoder("utf-8");
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (!value) continue;
            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split(/\r?\n/);
            for (const ln of lines) {
              if (!ln.startsWith("data:")) continue;
              const payload = ln.slice(5).trim();
              if (!payload || payload === "[DONE]") continue;
              try {
                const obj = JSON.parse(payload);
                const delta = obj?.choices?.[0]?.delta?.content || "";
                if (delta) { botDiv.textContent += delta; msgsEl.scrollTop = msgsEl.scrollHeight; }
              } catch {}
            }
          }
          return { ok: true };
        }

        // non-stream: تلاش برای استخراج متن — اگر نبود، خطا نشان بده
        const data = await safeJSON(resp);
        const txt = data?.choices?.[0]?.message?.content ?? data?.reply ?? "";
        if (!txt) {
          throw new Error("خروجی خالی از سرور دریافت شد. Raw: " + truncate(JSON.stringify(data)));
        }
        botDiv.textContent = txt;
        return { ok: true };
      };

      while (attempts < 3) {
        try {
          const r = await tryOnce();
          if (r?.rateLimit) {
            await new Promise((resolve, reject) => {
              stopCountdown = countdownUI(r.waitSeconds, () => reject(new Error("cancelled")), () => resolve());
            });
            continue; // retry after countdown
          }
          break; // success
        } catch (err) {
          if (String(err?.message) === "cancelled") {
            botDiv.textContent += "\n(لغو شد)";
            break;
          }
          if (attempts >= 3) {
            botDiv.classList.add("err");
            botDiv.textContent = "خطا: " + (err?.message || err);
            console.error(err);
            break;
          } else {
            await new Promise(r => setTimeout(r, 1000));
          }
        } finally {
          if (stopCountdown) { try { stopCountdown(); } catch {} }
        }
      }

      setBusy(false);
      controller = null;
      // تاریخچه را با پاسخ نهایی ذخیره کن
      if (botDiv.textContent) messages.push({ role: "assistant", content: botDiv.textContent });
    }

    stopBtn.addEventListener("click", () => { if (controller) controller.abort(); setBusy(false); });
    sendBtn.addEventListener("click", send);
    inp.addEventListener("keydown", (e)=>{ if (e.key === "Enter" && !e.shiftKey){ e.preventDefault(); send(); } });

    addMsg("assistant", "سلام! Provider/Model را تنظیم کن و پیام بده. اگر به Rate Limit GitHub بخوری، شمارش‌معکوس می‌آید و خودش دوباره تلاش می‌کند.");

    function truncate(s, n=300){ return s && s.length>n ? s.slice(0,n)+" …" : s; }
    async function safeJSON(resp){
      try { return await resp.json(); } catch { return null; }
    }
  </script>
</body>
</html>
