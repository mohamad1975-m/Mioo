<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø§Ø¯Ù…ÛŒÙ† Ú†Øªâ€ŒØ¨Ø§Øª</title>
  <style>
    @font-face{
      font-family: "IRANYekanX";
  src: url("https://s34.picofile.com/d/8486538992/3cb84d2c-b50e-4f3c-b8d9-071a57c8efed/IRANYekanX_Light_woff2") format("woff2");

      font-weight: 300; font-style: normal; font-display: swap;
    }
    :root{
      --bg:#f8f9fb; --card:#fff; --ink:#111; --muted:#6b7280; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.06);
      --accent:#0f172a; --accent-ink:#fff; --bd:#e5e7eb; --chip:#0f172a; --chip-ink:#fff;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);font-family:IRANYekanX, Tahoma, Arial, sans-serif;color:var(--ink)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 14px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .tabs{display:flex;gap:8px;align-items:center}
    .tab{border:1px solid var(--bd);padding:10px 14px;border-radius:12px;cursor:pointer;background:#fff}
    .tab.active{background:var(--accent);color:var(--accent-ink);border-color:transparent}
    .grid{display:grid;gap:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:4px 10px;border-radius:999px;background:#eef2ff}
    .muted{color:var(--muted)}
    input,select,button,textarea{border:1px solid var(--bd);border-radius:10px;padding:8px;font-family:IRANYekanX}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
    .ghost{background:#eef2f7;color:#111}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:right;padding:10px;background:#fff;border:1px solid var(--bd)}
    th{background:#f1f5f9}
    tr td:first-child, tr th:first-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    tr td:last-child, tr th:last-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    .section-title{margin:0 0 8px 0}
    .mono{font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px}
    .hr{height:1px;background:#e5e7eb;margin:12px 0}
    .flex{display:flex;gap:8px;align-items:center}
    .right{justify-content:flex-end}
    .tag{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--chip-ink);padding:4px 10px;border-radius:999px;font-size:12px}
    .good{background:#dcfce7;border:1px solid #86efac}
    .bad{background:#fee2e2;border:1px solid #fecaca}
    .code{white-space:pre-wrap; background:#0f172a;color:#e5e7eb;border-radius:10px;padding:10px}
  </style>
  <style>
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .link { background:#0f172a; color:#fff; border:0; border-radius:10px; padding:8px 12px; cursor:pointer; font-family:IRANYekanX }
    .ghost{ background:#eef2f7; color:#111 }
    .panel { margin-top:14px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:12px }
    .list { max-height:70vh; overflow:auto; display:flex; flex-direction:column; gap:8px }
    .item { border:1px solid #e5e7eb; border-radius:12px; padding:10px; display:flex; justify-content:space-between; align-items:center; gap:10px }
    .meta { color:#64748b; font-size:12px }
    .star { color:#f59e0b; margin-inline-start:6px }
    .badge{ font-size:12px; background:#eef2ff; border-radius:999px; padding:2px 8px; color:#475569 }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .hidden{ display:none }
    .snack{ position:fixed; inset-inline:0; bottom:12px; display:none; justify-content:center; z-index:1000 }
    .snack-inner{ background:#111; color:#fff; padding:10px 14px; border-radius:12px; display:flex; gap:12px; align-items:center }
    .snack button{ background:#fff; color:#111; border:0; border-radius:8px; padding:6px 10px; cursor:pointer; font-family:IRANYekanX }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:1200 }
    .modal.show{ display:flex }
.modal-card{ background:#fff; border-radius:16px; width:min(600px,96vw); padding:16px; max-height:90vh; overflow:auto }

    .modal-card h3{ margin:0 0 10px 0; font-size:18px }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
    .search { display:flex; gap:8px; align-items:center; margin:10px 0 }
    .search input { flex:1; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; }

    #chatModalBody img,
.item img,
.panel img {
  max-width: 100%;
  height: auto;
  display: block;
  border-radius: 12px;
  margin: 6px 0;
}
/* Ø±Ù†Ú¯ Ø¨Ù†ÙØ´ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± ØµÙØ­Ù‡Ù” Ø§Ø¯Ù…ÛŒÙ† */
.item.user {
  background-color: #f3e8ff;       /* Ø¨Ù†ÙØ´ Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† */
  border: 1px solid #d8b4fe;       /* Ø­Ø§Ø´ÛŒÙ‡ Ø¨Ù†ÙØ´ Ù…Ù„Ø§ÛŒÙ… */
}

/* ØªØµØ§ÙˆÛŒØ± Ø¯Ø§Ø®Ù„ Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯ÙØªÚ¯Ùˆ/Ù…ÙˆØ¯Ø§Ù„/Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¯Ø± Ø§Ø¯Ù…ÛŒÙ† */
#chatModalBody img,
.item img,
.panel img {
  max-width: 100%;
  height: auto;
  display: block;
  border-radius: 12px; /* Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø¯ */
  margin: 6px 0;
}

/* ØªØµØ§ÙˆÛŒØ± Ø¯Ø§Ø®Ù„ Ø¬Ø²ÛŒÛŒØ§Øª Ú¯ÙØªÚ¯Ùˆ/Ù…ÙˆØ¯Ø§Ù„/Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø¯Ø± Ø§Ø¯Ù…ÛŒÙ† */
#chatModalBody img,
.item img,
.panel img {
  max-width: 100%;
  height: auto;
  display: block;
  border-radius: 12px; /* Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø¯ */
  margin: 6px 0;
}
.user-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  /* Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ø±ØªÙØ§Ø¹ Ø­Ø¯ÙˆØ¯ Û´ Ú©Ø§Ø±ØªØ› Ø¨Ø±Ø§ÛŒ Ø¨Ù‚ÛŒÙ‡ Ø§Ø³Ú©Ø±ÙˆÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ */
  max-height:260px;
  overflow:auto;
  /* ØªÙ…Ø§Ù…â€ŒØ¹Ø±Ø¶ Ø´Ø¯Ù† Ø¯Ø± Ø±Ø¯ÛŒÙ */
  flex:1;
  width:100%;
}


.user-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:10px;
  background:#fff;
  cursor:pointer;
}
.dark .user-item{ background:#0b1220; border-color:#1f2937; }
.user-item:hover{ background:#f8fafc; }
.dark .user-item:hover{ background:#0f172a; }
.user-item.active{
  background:#eef2ff;
  border-color:#c7d2fe;
}
.dark .user-item.active{
  background:#1f2937;
  border-color:#334155;
}
.user-meta{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.user-meta small{ color:var(--muted); }


  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
  <!-- MathJax config -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']]
    },
    svg: { fontCache: 'global' }
  };
</script>
<!-- MathJax loader -->
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

</head>
<body>
<div class="wrap">
  <div class="head">
    <h2 style="margin:0">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
    <div class="tabs">
      
      <button class="tab active" id="tabChats">Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
      <button class="tab" id="tabAnalytics">Ø¢Ù†Ø§Ù„ÛŒØ²</button>
      <button class="btn ghost" id="btnAll">Ù…Ø´Ø§Ù‡Ø¯Ù‡Ù” Ù‡Ù…Ù‡Ù” Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</button>
      <button class="btn ghost" id="btnLive">ØµÙØ­Ù‡Ù” Ø²Ù†Ø¯Ù‡</button>

    </div>
  </div>
  

  <div class="card" id="viewChats">
    <div class="row">
      <!-- Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù‡â€ŒØ¬Ø§ÛŒ Ù…Ù†ÙˆÛŒ Ú©Ø´ÙˆÛŒÛŒ -->
<!-- Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† + Ø¯Ú©Ù…Ù‡ØŒ ØªÙ…Ø§Ù…â€ŒØ¹Ø±Ø¶ -->
<div style="display:flex; flex-direction:column; gap:8px; flex:1">
  <button class="btn" id="refreshUsers" style="align-self:flex-start">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
  <div id="userList" class="user-list"></div>
</div>

    </div>
    <div class="hr"></div>
<!-- Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± -->
<div id="profileBox" class="panel" style="margin-top:8px; display:none">
  <div class="row" style="justify-content:space-between">
    <div>
      <div><b>Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±</b></div>
      <div class="muted" id="profMeta">â€”</div>
    </div>
    <div class="row">
      <button class="link ghost" id="btnLogins">ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙˆØ±ÙˆØ¯</button>
      <button class="link ghost" id="btnNotes" title="Ù†ÙˆØª Ø®ØµÙˆØµÛŒ (Ø¢ÛŒÚ©ÙˆÙ† Ù†ÙˆØª Ù¾Ø¯)">ğŸ—’ï¸ Ù†ÙˆØª</button>
      <button class="link" id="btnBan">Ø¨Ù† Ú©Ø±Ø¯Ù†</button>
      <button class="link ghost" id="btnUnban">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ù†</button>



      <button class="link ghost" id="btnDevices">Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§</button>

      <button id="btnUserAuth" class="link ghost">Ø­Ø³Ø§Ø¨</button>

    </div>
  </div>
</div>

    <h3 class="section-title">Ù„ÛŒØ³Øª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</h3>
    <div class="row">
      <input id="searchChat" placeholder="Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù†/Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„â€¦" style="min-width:280px">
      <button class="btn ghost" id="refreshChats">Ù†ÙˆØ³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª</button>
      <button class="btn" id="exportUser">Ø§Ú©Ø³Ù¾ÙˆØ±Øª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±</button>
    </div>
    <div id="chatsTableWrap" style="margin-top:10px;overflow:auto"></div>

    <div class="hr"></div>
    <h3 class="section-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯ÙØªÚ¯Ùˆ</h3>
    <div id="chatDetail"></div>
  </div>

  <div class="card" id="viewAnalytics" style="display:none">
    <h3 class="section-title">Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ</h3>
    <div class="row">
      <div class="tag">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯Ø´Ø¯Ù‡: <b id="statChats" style="margin-inline-start:6px">-</b></div>
      <div class="tag">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: <b id="statMsgs" style="margin-inline-start:6px">-</b></div>
      <div class="tag">Ú©Ù„ÛŒÚ© Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§: <b id="statClicks" style="margin-inline-start:6px">-</b></div>
      <div class="tag">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÛŒÚ©ØªØ§ (Ø¨Ø± Ø§Ø³Ø§Ø³ IP): <b id="statUsers" style="margin-inline-start:6px">-</b></div>
      <div class="hr"></div>
<div class="row">
  <div class="tag">Û³Û°â€ŒØ±ÙˆØ² Ø§Ø®ÛŒØ± - Ú¯ÙØªÚ¯Ùˆ: <b id="last30Chats">-</b></div>
  <div class="tag">Û³Û°â€ŒØ±ÙˆØ² Ø§Ø®ÛŒØ± - Ù¾ÛŒØ§Ù…: <b id="last30Msgs">-</b></div>
  <div class="tag">Ø§Ù…Ø±ÙˆØ² - Ú¯ÙØªÚ¯Ùˆ: <b id="todayChats">-</b></div>
  <div class="tag">Ø§Ù…Ø±ÙˆØ² - Ù¾ÛŒØ§Ù…: <b id="todayMsgs">-</b></div>
  <div class="tag">Ø§Ù…Ø±ÙˆØ² - Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: <b id="todayUsers">-</b></div>
  <!-- today (Ø¬Ø¯ÛŒØ¯) -->
<div class="tag">Ø§Ù…Ø±ÙˆØ² - Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯: <b id="newUsersToday">-</b></div>

<!-- week (Ø¬Ø¯ÛŒØ¯) -->
<div class="tag">Ø§ÛŒÙ† Ù‡ÙØªÙ‡ - Ú¯ÙØªÚ¯Ùˆ: <b id="weekChats">-</b></div>
<div class="tag">Ø§ÛŒÙ† Ù‡ÙØªÙ‡ - Ù¾ÛŒØ§Ù…: <b id="weekMsgs">-</b></div>
<div class="tag">Ø§ÛŒÙ† Ù‡ÙØªÙ‡ - Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯: <b id="newUsersWeek">-</b></div>
<div class="tag">Ø§ÛŒÙ† Ù‡ÙØªÙ‡ - Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: <b id="activeWeek">-</b></div>

<!-- month (Ø¬Ø¯ÛŒØ¯) -->
<div class="tag">Ø§ÛŒÙ† Ù…Ø§Ù‡ - Ú¯ÙØªÚ¯Ùˆ: <b id="monthChats">-</b></div>
<div class="tag">Ø§ÛŒÙ† Ù…Ø§Ù‡ - Ù¾ÛŒØ§Ù…: <b id="monthMsgs">-</b></div>
<div class="tag">Ø§ÛŒÙ† Ù…Ø§Ù‡ - Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯: <b id="newUsersMonth">-</b></div>
<div class="tag">Ø§ÛŒÙ† Ù…Ø§Ù‡ - Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: <b id="activeMonth">-</b></div>

<!-- year (Ø¬Ø¯ÛŒØ¯) -->
<div class="tag">Ø§Ù…Ø³Ø§Ù„ - Ú¯ÙØªÚ¯Ùˆ: <b id="yearChats">-</b></div>
<div class="tag">Ø§Ù…Ø³Ø§Ù„ - Ù¾ÛŒØ§Ù…: <b id="yearMsgs">-</b></div>
<div class="tag">Ø§Ù…Ø³Ø§Ù„ - Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯: <b id="newUsersYear">-</b></div>
<div class="tag">Ø§Ù…Ø³Ø§Ù„ - Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: <b id="activeYear">-</b></div>

</div>

<h3 class="section-title" style="margin-top:12px">ØªÙˆØ²ÛŒØ¹ Ù‡ÙØªÚ¯ÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ (Ø´Ù†Ø¨Ù‡â†’Ø¬Ù…Ø¹Ù‡)</h3>
<canvas id="weekChart" width="900" height="240" style="max-width:100%"></canvas>

<h3 class="section-title" style="margin-top:12px">Ø§Ø³ØªÙØ§Ø¯Ù‡Ù” Ù…Ø¯Ù„â€ŒÙ‡Ø§</h3>
<div id="modelsBox" class="mono" style="white-space:pre-wrap"></div>
<!-- ===== Ø¢Ù…Ø§Ø±Ù Ø¨Ø§Ø²Ù‡ Ø¯Ù„Ø®ÙˆØ§Ù‡ (Ø¬Ø¯Ø§ Ø§Ø² Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ) ===== -->
<div class="hr" style="margin:16px 0"></div>
<h3 class="section-title">Ø¢Ù…Ø§Ø± Ø¨Ø§Ø²Ù‡Ù” Ø¯Ù„Ø®ÙˆØ§Ù‡</h3>
<div class="row" style="margin-bottom:8px">
  <button class="btn" id="btnPickRange">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²Ù‡ (ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ)</button>
  <label style="display:flex;align-items:center;gap:6px;">
    <input type="checkbox" id="jSingleDay">
    Ø§Ù†ØªØ®Ø§Ø¨ ÛŒÚ© Ø±ÙˆØ² Ø®Ø§Øµ
  </label>
  <span class="muted" id="rangeLabel">â€” Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ â€”</span>
</div>

<div class="row" id="rangeStats" style="flex-wrap:wrap; gap:8px">
  <div class="tag">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ù‡: <b id="rChats" style="margin-inline-start:6px">-</b></div>
  <div class="tag">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²Ù‡: <b id="rMsgs" style="margin-inline-start:6px">-</b></div>
  <div class="tag">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯: <b id="rNewUsers" style="margin-inline-start:6px">-</b></div>
  <div class="tag">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: <b id="rActive" style="margin-inline-start:6px">-</b></div>
</div>

    </div>

    <div class="hr"></div>
    <div class="row right">
      <button class="btn ghost" id="refreshStats">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      <button class="btn" id="resetAll">Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø¢Ù…Ø§Ø± Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
      <button class="btn" id="exportAll">Ø§Ú©Ø³Ù¾ÙˆØ±Øª Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ² (JSON)</button>
    </div>

    <h3 class="section-title" style="margin-top:16px">Ø®Ø±ÙˆØ¬ÛŒ</h3>
    <div id="exportBox" class="code mono"></div>
  </div>
</div>
<!-- Ø³Ø¨Ú©Ù Ø®ÛŒÙ„ÛŒ Ø³Ø¨Ú© Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÛŒØ¯Ù ØªÙ‚ÙˆÛŒÙ… -->
<style>
  .jalali-modal { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:1400 }
  .jalali-modal.show{ display:flex }
  .jalali-card { background:#fff; border-radius:16px; width:min(640px,96vw); padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.2) }
  .dark .jalali-card{ background:#0b1220; color:#e5e7eb }
  .j-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px }
  .j-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px }
  .j-cell{ border:1px solid #e5e7eb; border-radius:10px; padding:8px 0; text-align:center; cursor:pointer; user-select:none; background:#fff }
  .dark .j-cell{ background:#0f172a; border-color:#1f2937 }
  .j-cell.dim{ opacity:.45 }
  .j-cell.h{ background:#eef2ff }
  .j-cell.sel{ background:#10b981; color:#fff; border-color:#10b981 }
  .j-days{ color:#64748b; font-size:12px; margin-bottom:6px }
  .j-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }
</style>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²Ù‡Ù” Ø´Ù…Ø³ÛŒ -->
<div id="jalaliRangeModal" class="jalali-modal" aria-hidden="true">
  <div class="jalali-card">
    <div class="j-head">
      <b>Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²Ù‡Ù” ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</b>
      <div class="row">
        <button id="jPrev" class="link ghost">Ù‚Ø¨Ù„ÛŒ</button>
        <span id="jTitle" class="pill"></span>
        <button id="jNext" class="link ghost">Ø¨Ø¹Ø¯ÛŒ</button>
      </div>
    </div>

    <div class="j-days j-grid">
      <div>Ø´</div><div>ÛŒ</div><div>Ø¯</div><div>Ø³</div><div>Ú†</div><div>Ù¾</div><div>Ø¬</div>
    </div>
    <div id="jGrid" class="j-grid"></div>

    <div class="j-actions">
      <button id="jCancel" class="link ghost">Ø§Ù†ØµØ±Ø§Ù</button>
      <button id="jOk" class="link">ØªØ£ÛŒÛŒØ¯</button>
    </div>
  </div>
</div>
<script>
/* ==== Jalali Range Picker + Range Stats (self-contained) ==== */
(function(){
  // Ø§Ú¯Ø± Ø¹Ù†Ø§ØµØ± Ù„Ø§Ø²Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù†Ø¨ÙˆØ¯Ù†Ø¯ØŒ Ø®Ø§Ø±Ø¬ Ø´Ùˆ ØªØ§ Ú†ÛŒØ²ÛŒ Ù†Ø´Ú©Ù†Ø¯
  const btnPickRange = document.getElementById("btnPickRange");
  const rangeModal   = document.getElementById("jalaliRangeModal");
  const jGrid        = document.getElementById("jGrid");
  const jTitle       = document.getElementById("jTitle");
  const jPrev        = document.getElementById("jPrev");
  const jNext        = document.getElementById("jNext");
  const jCancel      = document.getElementById("jCancel");
  const jOk          = document.getElementById("jOk");
  const rangeLabel   = document.getElementById("rangeLabel");
  const rChatsEl     = document.getElementById("rChats");
  const rMsgsEl      = document.getElementById("rMsgs");
  const rNewUsersEl  = document.getElementById("rNewUsers");
  const rActiveEl    = document.getElementById("rActive");

  if (!btnPickRange || !rangeModal || !jGrid || !jTitle) return;

  // === Jalali <-> Gregorian helpers (Ú©Ù„Ø§Ø³ÛŒÚ© Ùˆ Ø³Ø¨Ú©) ===
  const div = (a,b)=>Math.floor(a/b);
  function g2d(y,m,d){
    const a = div(14-m,12), y2 = y+4800-a, m2 = m+12*a-3;
    return d + div(153*m2+2,5) + 365*y2 + div(y2,4) - div(y2,100) + div(y2,400) - 32045;
  }
  function d2g(j){
    let j2 = j, f = j2 + 1401 + div(div(4*j2 + 274277,146097)*3,4) - 38;
    let e = 4*f + 3, g = div(e % 1461, 4), h = 5*g + 2;
    let D = div(h%153,5)+1, M = (div(h,153)+2)%12+1, Y = div(e,1461)-4716 + div(12+2-M,12);
    return [Y,M,D];
  }
  function j2d(y,m,d){
    const epbase = y - (y>=0 ? 474 : 473);
    const epyear = 474 + epbase;
    return d + (m<=7 ? (m-1)*31 : (m-1)*30+6) + div((epyear*682-110),2816) + (epyear-1)*365 + (1948320 - 1);
  }
  function d2j(jdn){
    const depoch = jdn - j2d(475,1,1);
    const cycle  = div(depoch,1029983);
    const cyear  = depoch % 1029983;
    let ycycle;
    if (cyear === 1029983) ycycle = 2820;
    else {
      const aux1 = div(cyear,366);
      const aux2 = cyear % 366;
      ycycle = div(2134*aux1 + 2816*aux2 + 2815,1028522) + aux1 + 1;
    }
    const y = ycycle + 2820*cycle + 474;
    const yadj = (y<=0) ? y-1 : y;
    const yday = jdn - j2d(yadj,1,1) + 1;
    const m = (yday<=186) ? Math.ceil(yday/31) : Math.ceil((yday-186)/30)+6;
    const d = jdn - j2d(yadj,m,1) + 1;
    return [yadj,m,d];
  }
  function j2g(y,m,d){ return d2g(j2d(y,m,d)); }

  // === ÙˆØ¶Ø¹ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ ===
  let showing = null; // {jy, jm} Ù…Ø§Ù‡ÛŒ Ú©Ù‡ Ø¯Ø± ØªÙ‚ÙˆÛŒÙ… Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
  let selFrom = null; // {jy, jm, jd}
  let selTo   = null; // {jy, jm, jd}

  // Ø§Ù…Ø±ÙˆØ² Ø¨Ø± Ø§Ø³Ø§Ø³ Ú¯Ø±Ø¬ÛŒ â†’ Ø¬Ù„Ø§Ù„ÛŒ
  (function initMonthToToday(){
    const now = new Date();
    const [jy,jm,jd] = d2j(g2d(now.getFullYear(), now.getMonth()+1, now.getDate()));
    showing = { jy, jm };
  })();

  function fmtJalali(y,m){
    const names = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†","Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª","Ø®Ø±Ø¯Ø§Ø¯","ØªÛŒØ±","Ù…Ø±Ø¯Ø§Ø¯","Ø´Ù‡Ø±ÛŒÙˆØ±","Ù…Ù‡Ø±","Ø¢Ø¨Ø§Ù†","Ø¢Ø°Ø±","Ø¯ÛŒ","Ø¨Ù‡Ù…Ù†","Ø§Ø³ÙÙ†Ø¯"];
    return names[m-1] + " " + y;
  }

  function compareJ(a,b){
    if (a.jy!==b.jy) return a.jy-b.jy;
    if (a.jm!==b.jm) return a.jm-b.jm;
    return a.jd-b.jd;
  }
  function inRangeJ(x, a, b){
    if (!a || !b) return false;
    const lo = compareJ(a,b)<=0 ? a : b;
    const hi = compareJ(a,b)<=0 ? b : a;
    return compareJ(x,lo)>=0 && compareJ(x,hi)<=0;
  }

  function daysInJMonth(y,m){
    if (m<=6) return 31;
    if (m<=11) return 30;
    // Ø§Ø³ÙÙ†Ø¯: Ú©Ø¨ÛŒØ³Ù‡ØŸ
    // Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ…: Ø³Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¬Ù„Ø§Ù„ÛŒ Ø¨Ø§ Ú†Ø±Ø®Ù‡ 33ØªØ§ÛŒÛŒ â€” Ø³Ø§Ø¯Ù‡: Ø§Ø®ØªÙ„Ø§Ù JDN Ø¨ÛŒÙ† 1 ÙØ±ÙˆØ±Ø¯ÛŒÙ† Ø³Ø§Ù„ Ø¨Ø¹Ø¯ Ùˆ Ø§Ù…Ø³Ø§Ù„
    const nextNow = j2d(y+1,1,1), thisNow = j2d(y,1,1);
    const daysYear = nextNow - thisNow;
    return (daysYear===366) ? 30 : 29;
  }

  function renderGrid(){
    if (!showing) return;
    const {jy, jm} = showing;
    jTitle.textContent = fmtJalali(jy,jm);
    jGrid.innerHTML = "";

    // Ø§ÙˆÙ„ÛŒÙ† Ø±ÙˆØ² Ù…Ø§Ù‡ Ø¬Ù„Ø§Ù„ÛŒ Ø±Ø§ Ø¨Ù‡ Ú¯Ø±Ø¬ÛŒ Ø¨Ø¨Ø± ØªØ§ Ø±ÙˆØ² Ù‡ÙØªÙ‡ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒÙ…
    const [gy,gm,gd] = j2g(jy,jm,1);
    const dow = new Date(gy, gm-1, gd).getDay(); // 0=Sunday â€¦ 6=Saturday
    // Ù…Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒÙ… Ø³ØªÙˆÙ† Ø§ÙˆÙ„ Â«Ø´Ù†Ø¨Ù‡Â» Ø¨Ø§Ø´Ø¯Ø› Ù†Ú¯Ø§Ø´Øª:
    const gregToSatIndex = (dow+1)%7; // Ø´Ù†Ø¨Ù‡=0 â€¦ Ø¬Ù…Ø¹Ù‡=6

    const lead = gregToSatIndex;  // Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù…â€ŒØ±Ù†Ú¯ Ø§Ø¨ØªØ¯Ø§ÛŒ Ù…Ø§Ù‡
    const dim = daysInJMonth(jy,jm);
    const total = lead + dim;
    const tail = (total%7) ? (7 - total%7) : 0;

    // Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ (dimmed)
    for (let i=0;i<lead;i++){
      const el = document.createElement("div");
      el.className = "j-cell dim";
      el.textContent = " ";
      jGrid.appendChild(el);
    }

    // Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø®ÙˆØ¯Ù Ù…Ø§Ù‡
    for (let d=1; d<=dim; d++){
      const el = document.createElement("div");
      el.className = "j-cell";
      el.textContent = String(d);

      const cur = {jy, jm, jd:d};
      // Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Â«Ø¨ÛŒÙ†Ù Ø¨Ø§Ø²Ù‡Â»
      if (selFrom && selTo && inRangeJ(cur, selFrom, selTo)) el.classList.add("sel");
      // Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Â«Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§Â»
      if (selFrom && selFrom.jy===jy && selFrom.jm===jm && selFrom.jd===d) el.classList.add("h");
      if (selTo   && selTo.jy===jy   && selTo.jm===jm   && selTo.jd===d)   el.classList.add("h");

      el.onclick = ()=>{
  const single = !!document.getElementById("jSingleDay")?.checked;

  if (single){
    // ØªÚ©â€ŒØ±ÙˆØ²Ù‡: Ù‡Ø± Ú©Ù„ÛŒÚ© Ù‡Ù…Ø§Ù† Ø±ÙˆØ² Ø±Ø§ Ø§Ø²/ØªØ§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    selFrom = cur;
    selTo   = cur;
    renderGrid();
    return;
  }

  // Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ:
  if (!selFrom) { selFrom = cur; selTo=null; renderGrid(); return; }
  if (selFrom && selTo) { selFrom = cur; selTo=null; renderGrid(); return; }
  selTo = cur; renderGrid();
};


      jGrid.appendChild(el);
    }

    // Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ (dimmed)
    for (let i=0;i<tail;i++){
      const el = document.createElement("div");
      el.className = "j-cell dim";
      el.textContent = " ";
      jGrid.appendChild(el);
    }
  }

  // Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† Ù…Ø§Ù‡â€ŒÙ‡Ø§
  jPrev && (jPrev.onclick = ()=>{
    if (!showing) return;
    if (--showing.jm === 0){ showing.jm=12; showing.jy--; }
    renderGrid();
  });
  jNext && (jNext.onclick = ()=>{
    if (!showing) return;
    if (++showing.jm === 13){ showing.jm=1; showing.jy++; }
    renderGrid();
  });

  // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
  btnPickRange.onclick = ()=>{
    // Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ø§Ù…Ø±ÙˆØ² Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Â«Ø§Ø²Â»
    selFrom = null; selTo = null;
    rangeModal.classList.add("show");
    rangeModal.setAttribute("aria-hidden","false");
    renderGrid();
  };
  // Ø¨Ø³ØªÙ†
  function closeRangeModal(){
    rangeModal.classList.remove("show");
    rangeModal.setAttribute("aria-hidden","true");
  }
  jCancel && (jCancel.onclick = closeRangeModal);
  rangeModal.addEventListener("click", (e)=>{ if (e.target===rangeModal) closeRangeModal(); });

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø± Ø¨Ø§Ø²Ù‡ (Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒØ³Ø§ÛŒØ¯ Ø§Ø² /admin/export)
  async function computeRangeStats(fromJ, toJ){
    try{
      // ØªØ¶Ù…ÛŒÙ† ØªØ±ØªÛŒØ¨
      const a = compareJ(fromJ,toJ)<=0 ? fromJ : toJ;
      const b = compareJ(fromJ,toJ)<=0 ? toJ   : fromJ;

      // Ø¨Ù‡ Ú¯Ø±Ø¬ÛŒ (Ù…ÛŒÙ„Ø§Ø¯ÛŒ) ØªØ¨Ø¯ÛŒÙ„ Ùˆ ØªØ§ÛŒÙ…â€ŒØ§Ø³ØªÙ…Ù¾ Ø¨Ú¯ÛŒØ±
      const [aGy,aGm,aGd] = j2g(a.jy,a.jm,a.jd);
      const [bGy,bGm,bGd] = j2g(b.jy,b.jm,b.jd);
      const fromTs = new Date(aGy, aGm-1, aGd, 0,0,0,0).getTime();
      const toTs   = new Date(bGy, bGm-1, bGd, 23,59,59,999).getTime();

      // Ù„ÛŒØ¨Ù„ Ø¨Ø§Ø²Ù‡
// Ù„ÛŒØ¨Ù„ Ø¨Ø§Ø²Ù‡
rangeLabel.textContent = `Ø§Ø² ${a.jy}/${a.jm}/${a.jd} ØªØ§ ${b.jy}/${b.jm}/${b.jd}`;

// Ø¯ÛŒØªØ§ Ø±Ø§ Ø§Ø² Ø§Ú©Ø³Ù¾ÙˆØ±Øª Ø¨Ú¯ÛŒØ± (Ø§ØªÚ©Ø§ Ø¨Ù‡ window.API Ú©Ù‡ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø¯Ø± Ù‡Ù…ÛŒÙ† ÙØ§ÛŒÙ„ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡)
const API_BASE = (window.API || "").trim();
if (!API_BASE) throw new Error("API base not found");
const resp = await fetch(API_BASE + "/admin/export");

      const data = await resp.json().catch(()=> ({}));

      // Ø´Ù…Ø§Ø±Ø´â€ŒÙ‡Ø§
      let chats=0, msgs=0, newUsers=0, active=0;
// Ú†Øªâ€ŒÙ‡Ø§ Ùˆ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ (Ú¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±)
const chArr = Array.isArray(data?.chats) ? data.chats
            : Array.isArray(data?.all?.chats) ? data.all.chats
            : [];

for (const c of chArr){
  const ct = Number(c?.createdAt ?? c?.ts ?? 0);
  if (Number.isFinite(ct) && ct>=fromTs && ct<=toTs) chats++;

  const list = Array.isArray(c?.messages) ? c.messages : [];
  for (const m of list){
    const mt = Number(m?.ts ?? m?.time ?? 0);
    if (Number.isFinite(mt) && mt>=fromTs && mt<=toTs) msgs++;
  }
}

// Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
const uArr = Array.isArray(data?.users) ? data.users
            : Array.isArray(data?.all?.users) ? data.all.users
            : [];
const uniqActive = new Set();
for (const u of uArr){
  const created = Number(u?.createdAt ?? u?.firstSeen ?? 0);
  const seen    = Number(u?.lastSeen ?? 0);

  if (Number.isFinite(created) && created>=fromTs && created<=toTs) newUsers++;
  if (Number.isFinite(seen) && seen>=fromTs && seen<=toTs) {
    uniqActive.add(u?.uid || u?.username || u?.ip || JSON.stringify(u));
  }
}
active = uniqActive.size;


      // Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ù‡ UI
      rChatsEl && (rChatsEl.textContent = String(chats));
      rMsgsEl  && (rMsgsEl.textContent  = String(msgs));
      rNewUsersEl && (rNewUsersEl.textContent = String(newUsers));
      rActiveEl   && (rActiveEl.textContent   = String(active));
    }catch(e){
      console.error(e);
      alert("Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡Ù” Ø¢Ù…Ø§Ø± Ø¨Ø§Ø²Ù‡.");
    }
  }

  // ØªØ£ÛŒÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨
jOk && (jOk.onclick = async ()=>{
  const single = !!document.getElementById("jSingleDay")?.checked;
  if (!selFrom){
    alert(single ? "Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø±ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯." : "Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø¨Ø§Ø²Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯: ÛŒÚ© ØªØ§Ø±ÛŒØ® Ø¨Ø±Ø§ÛŒ Â«Ø§Ø²Â» Ùˆ ÛŒÚ©ÛŒ Ø¨Ø±Ø§ÛŒ Â«ØªØ§Â».");
    return;
  }
  // Ø§Ú¯Ø± ØªÚ©â€ŒØ±ÙˆØ²Ù‡ Ø§Ø³Øª Ùˆ selTo Ù‡Ù†ÙˆØ² Ù†ÛŒØ³ØªØŒ selTo = selFrom
  if (single && !selTo) selTo = selFrom;
  if (!selTo){
    alert("ØªØ§Ø±ÛŒØ® Â«ØªØ§Â» Ø±Ø§ Ù‡Ù… Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
    return;
  }
  await computeRangeStats(selFrom, selTo);
  closeRangeModal();
});


})(); 
</script>

<script>
const API = "https://mioo-chat.mohamadgpt19.workers.dev/api";
window.API = API;

const $  = (id)=>document.getElementById(id);

// Tabs

const tabChats = $("tabChats");
const tabAnalytics = $("tabAnalytics");
const viewChats = $("viewChats");
const viewAnalytics = $("viewAnalytics");
tabChats.onclick = ()=>{ tabChats.classList.add("active"); tabAnalytics.classList.remove("active"); viewChats.style.display="block"; viewAnalytics.style.display="none"; };
tabAnalytics.onclick = ()=>{ tabAnalytics.classList.add("active"); tabChats.classList.remove("active"); viewChats.style.display="none"; viewAnalytics.style.display="block"; };
// Ø§Ø¶Ø§ÙÙ‡: ÛŒÚ© Ù‡ÙÙ„Ù¾Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ† Ù¾Ù†Ù„ Ù‡Ù…Ù‡â€ŒÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§
function hideAllPanel(){
  const p = document.getElementById("allPanel");
  if (!p) return;
  p.style.display = "none";
  p.innerHTML = "";
}

// Ù‚Ø¨Ù„ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ Ø§ÛŒÙ† Ø´Ú©Ù„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†ÛŒØ¯:
tabChats.onclick = ()=>{
  tabChats.classList.add("active");
  tabAnalytics.classList.remove("active");
  viewChats.style.display="block";
  viewAnalytics.style.display="none";
  hideAllPanel();         // â† Ù…Ù‡Ù…
};
tabAnalytics.onclick = ()=>{
  tabAnalytics.classList.add("active");
  tabChats.classList.remove("active");
  viewAnalytics.style.display="block";
  viewChats.style.display="none";
  hideAllPanel();         // â† Ù…Ù‡Ù…
};

// UI nodes
const userList = $("userList");
const refreshUsers = $("refreshUsers");
const userInfo = $("userInfo");
const searchChat = $("searchChat");
const refreshChats = $("refreshChats");
const exportUser = $("exportUser");
const chatsTableWrap = $("chatsTableWrap");
const chatDetail = $("chatDetail");

// --- Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±
const profileBox = document.getElementById("profileBox");
const profMeta   = document.getElementById("profMeta");
const btnLogins  = document.getElementById("btnLogins");
const btnNotes   = document.getElementById("btnNotes");
const btnBan   = document.getElementById("btnBan");
const btnUnban = document.getElementById("btnUnban");

// ... Ø¨Ø¹Ø¯ Ø§Ø²:
// const btnBan    = document.getElementById("btnBan");
// const btnUnban  = document.getElementById("btnUnban");

function __currentUid(){
  // Ø§Ú¯Ø± Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ØŒ uid Ø¯Ø± dataset ÛŒØ§ Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ø®ÙˆØ¯Øª Ú¯Ø°Ø§Ø´ØªÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØŒ Ø§Ø² Ù‡Ù…Ø§Ù† Ø¨Ú¯ÛŒØ±.
  // Ø§ÛŒÙ† fallback Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¬ÙˆØ§Ø¨ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯:
  return (window.__currentUser || document.getElementById("userName")?.textContent || "").trim();
}

if (btnUnban){
  btnUnban.style.display = "inline-flex";
  btnUnban.onclick = async () => {
    const uid = __currentUid();
    if (!uid){ alert("Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯."); return; }
    try{
      const r = await fetch(API.replace("/api/chat","/api/admin/ban"), {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ uid, on:false })
      });
      const j = await r.json().catch(()=> ({}));
      if (j?.ok){
        alert("Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¨Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯.");
        // Ø§Ú¯Ø± ØªØ§Ø¨Ø¹ Ø±ÙØ±Ø´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¯Ø§Ø±ÛŒØŒ ØµØ¯Ø§Ø´ Ø¨Ø²Ù† ØªØ§ ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´ÙˆØ¯:
        try{ await loadUserProfile(uid); }catch{}
      } else {
        alert(j?.error || "Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ù†.");
      }
    }catch(e){
      alert("Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±/Ø´Ø¨Ú©Ù‡ Ø¯Ø± Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ù†.");
    }
  };
}


const btnDevices = document.getElementById("btnDevices");
btnDevices.onclick = async () => {
  const activeUid = window.activeUid;
  if (!activeUid) { alert("Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }

  try {
    const r = await fetch(API + "/admin/devices?uid=" + encodeURIComponent(activeUid));
    const j = await r.json();

    const list = Array.isArray(j?.devices) ? j.devices : [];
    const html = list.length
      ? list.map(d => `
          <div class="item">
            <div class="user-meta">
              <b class="mono" style="direction:ltr">${d.token.slice(0, 10)}â€¦</b>
              <small>Ø¯Ø³ØªÚ¯Ø§Ù‡: ${d.device || "-"}</small>
              <small>Ø§ÛŒØ¬Ø§Ø¯: ${d.createdAt ? new Date(d.createdAt).toLocaleString('fa-IR') : "-"}</small>
              <small>Ø¢Ø®Ø±ÛŒÙ†â€ŒÙØ¹Ø§Ù„ÛŒØª: ${d.lastSeen ? new Date(d.lastSeen).toLocaleString('fa-IR') : "-"}</small>
            </div>
            <div class="row">
              <button class="link ghost" data-revoke="${d.token}">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡</button>
            </div>
          </div>
        `).join("")
      : "<div class='muted'>Ù‡ÛŒÚ† Ø¯Ø³ØªÚ¯Ø§Ù‡ ÙØ¹Ø§Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>";

    openModal("Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±", html);

    document.querySelectorAll("[data-revoke]").forEach(b => {
      b.onclick = async () => {
        const token = b.getAttribute("data-revoke");
        if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ")) return;
        await fetch(API + "/auth/logout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, username: activeUid })
        });
        alert("Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø´Ø¯.");
        btnDevices.click(); // Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ Ù„ÛŒØ³Øª Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§
      };
    });
  } catch (e) {
    console.error(e);
    openModal("Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±", "<div class='muted'>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§</div>");
  }
};




// Analytics nodes
const statChats = $("statChats");
const statMsgs = $("statMsgs");
const statClicks = $("statClicks");
const statUsers = $("statUsers");
const refreshStats = $("refreshStats");
const resetAll = $("resetAll");
const exportAll = $("exportAll");
const exportBox = $("exportBox");

// Helpers
async function jget(path){ const r=await fetch(API+path); return r.json(); }
async function jpost(path, data){ const r=await fetch(API+path,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data||{})}); return r.json(); }
function fmt(ts){ try{ return new Date(ts).toLocaleString("fa-IR") }catch{return "-"} }
function escapeHtml(s=""){ return (s||"").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

// Modal helpers
function openModal(title, html){
  const m = document.getElementById("chatModal");
  const body = document.getElementById("chatModalBody");
  const ttl  = document.getElementById("chatModalTitle");
  ttl.textContent = title || "Ø¬Ø²Ø¦ÛŒØ§Øª";
  body.innerHTML = html || "";
  m.style.display = "flex";
}
function closeModal(){
  const m = document.getElementById("chatModal");
  m.style.display = "none";
}
document.addEventListener("click", (e)=>{
  if (e.target && e.target.id === "chatModalClose") closeModal();
  // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ù‡Ù… Ø¨Ø¨Ù†Ø¯Ù‡
  if (e.target && e.target.id === "chatModal") closeModal();
});



async function loadUserProfile(uid){
  profileBox.style.display = "none";
    // Ú¯Ø±ÙØªÙ† Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ (ÙˆÙ‚ØªÛŒ DOM Ù‚Ø·Ø¹Ø§Ù‹ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª)
    const loginsModal = document.getElementById("loginsModal");
  const loginsBody  = document.getElementById("loginsBody");
  const loginsClose = document.getElementById("loginsClose");
  const notesModal  = document.getElementById("notesModal");
  const notesText   = document.getElementById("notesText");
  const notesCancel = document.getElementById("notesCancel");
  const notesSave   = document.getElementById("notesSave");

  try{
    const r = await fetch(API + "/admin/userProfile?uid=" + encodeURIComponent(uid));
    const j = await r.json();
    const fmtDT = (ts)=> ts? new Date(ts).toLocaleString("fa-IR",{dateStyle:"short",timeStyle:"medium"}): "-";

    profMeta.textContent =
      `Ø¯Ø³ØªÚ¯Ø§Ù‡: ${j.device||"-"} | Ø§ÙˆÙ„ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ: ${fmtDT(j.firstChat)} | Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯: ${fmtDT(j.lastLogin)} | ÙˆØ¶Ø¹ÛŒØª: ${j.banned?"Ø¨Ù†â€ŒØ´Ø¯Ù‡":"Ø¹Ø§Ø¯ÛŒ"}`;
    profileBox.style.display = "block";
    // Ø¯Ú©Ù…Ù‡ Ù„Ø§Ú¯ÛŒÙ†â€ŒÙ‡Ø§
    btnLogins.onclick = ()=>{
      loginsBody.innerHTML = (j.logins||[]).map(ts=>{
        const t = Number(ts);
        return `- ${new Date(t).toLocaleString("fa-IR", { dateStyle: "medium", timeStyle: "medium", hour12: false })}`;
      }).join("<br>") || "â€” Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ â€”";
      loginsModal.classList.add("show"); loginsModal.setAttribute("aria-hidden","false");
    };

    loginsClose.onclick = ()=>{ loginsModal.classList.remove("show"); loginsModal.setAttribute("aria-hidden","true"); };

    // Ù†ÙˆØª Ø®ØµÙˆØµÛŒ Ø§Ø¯Ù…ÛŒÙ†
    btnNotes.onclick = async ()=>{
  try{
    const r  = await fetch(API + "/admin/notes?uid=" + encodeURIComponent(uid));
    const jj = await r.json().catch(()=>({}));
    notesText.value = (jj && typeof jj.note === "string") ? jj.note : (j.notes || "");
  }catch{ notesText.value = j.notes || ""; }
  notesModal.classList.add("show"); notesModal.setAttribute("aria-hidden","false");
};

notesSave.onclick = async ()=>{
  await fetch(API + "/admin/notes", {
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ uid, note: notesText.value || "" })
  });
  notesModal.classList.remove("show"); notesModal.setAttribute("aria-hidden","true");
  alert("Ù†ÙˆØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
  await loadUserProfile(uid);
};

    // Ø¨Ù†/Ø¢Ù†Ø¨Ù† â€” Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù„ Ø¨Ù„Ø§Ú© Ù‚Ø¨Ù„ÛŒ
    btnBan.textContent = j.banned ? "Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ù†" : "Ø¨Ù† Ú©Ø±Ø¯Ù†";
// Ù†Ù…Ø§ÛŒØ´/Ù¾Ù†Ù‡Ø§Ù†â€ŒØ³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡Ù” Â«Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ù†Â»
if (btnUnban) {
  btnUnban.style.display = "inline-flex";


  btnUnban.onclick = async () => {
    // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¨Ù† Ù†ÛŒØ³ØªØŒ Ù¾ÛŒØ§Ù… Ø¨Ø¯Ù‡ Ùˆ Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†
    if (!j.banned) {
      if (typeof showSnack === "function") showSnack("Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù† Ù†ÛŒØ³Øª.");
      else alert("Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù† Ù†ÛŒØ³Øª.");
      return;
    }

    try {
      const rr = await fetch(API + "/admin/ban", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ uid, on: false }) // Ø¢Ù†â€ŒØ¨Ù†
      });
      const jk = await rr.json();
      if (!jk?.ok) {
        if (typeof showSnack === "function") showSnack("Ø®Ø·Ø§ Ø¯Ø± Ø®Ø§Ø±Ø¬ Ú©Ø±Ø¯Ù† Ø§Ø² Ø¨Ù†");
        else alert("Ø®Ø·Ø§ Ø¯Ø± Ø®Ø§Ø±Ø¬ Ú©Ø±Ø¯Ù† Ø§Ø² Ø¨Ù†");
        return;
      }

      // Ù…ÙˆÙÙ‚: ÙˆØ¶Ø¹ÛŒØª Ù„ÙˆÚ©Ø§Ù„ Ùˆ UI Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù†
      j.banned = false;
      btnBan.textContent = "Ø¨Ù† Ú©Ø±Ø¯Ù†";
      btnUnban.style.display = "none";

      // Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø·Ø¹ÛŒØŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ú¯ÛŒØ±
      await loadUserProfile(uid);

      if (typeof showSnack === "function") showSnack("Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¨Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯");
      else alert("Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¨Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯");
    } catch (e) {
      console.error(e);
      if (typeof showSnack === "function") showSnack("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ø³Ø±ÙˆØ± Ø¯Ø± Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ù†");
      else alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ø³Ø±ÙˆØ± Ø¯Ø± Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ù†");
    }
  };
}


    btnBan.onclick = async () => {
      // Ø§Ú¯Ø± Ø§Ù„Ø§Ù† Ø¨Ù† Ø§Ø³ØªØŒ on Ø¨Ø§ÛŒØ¯ false Ø´ÙˆØ¯Ø› Ø§Ú¯Ø± Ø¨Ù† Ù†ÛŒØ³ØªØŒ on Ø¨Ø§ÛŒØ¯ true Ø´ÙˆØ¯
      const on = !j.banned;

      try {
        const rr = await fetch(API + "/admin/ban", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ uid, on })
        });
        const jk = await rr.json();

        if (!jk?.ok) {
          // Ù¾ÛŒØ§Ù… Ø®Ø·Ø§
          if (typeof showSnack === "function") showSnack("Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù†: " + (jk?.error || "Ù†Ø§Ù…Ø´Ø®Øµ"));
          else alert("Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù†");
          return;
        }

        // Ù…ÙˆÙÙ‚: ÙˆØ¶Ø¹ÛŒØª Ù„ÙˆÚ©Ø§Ù„ Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ú©Ù† ØªØ§ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø¹ÙˆØ¶ Ø´ÙˆØ¯
        j.banned = on;
        btnBan.textContent = on ? "Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ù†" : "Ø¨Ù† Ú©Ø±Ø¯Ù†";

        // Ø§Ú¯Ø± Ø¬Ø§ÛŒÛŒ Ø¯Ø± UI Ù†Ø´Ø§Ù†Ù ÙˆØ¶Ø¹ÛŒØª Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ù… Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        // Ù…Ø«Ø§Ù„: badgeBanned?.classList.toggle("show", j.banned);

        // Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ø§ Ø³Ø±ÙˆØ±ØŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ú¯ÛŒØ±
        await loadUserProfile(uid);

        if (typeof showSnack === "function") {
          showSnack(on ? "Ú©Ø§Ø±Ø¨Ø± Ø¨Ù† Ø´Ø¯" : "Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¨Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯");
        } else {
          alert(on ? "Ú©Ø§Ø±Ø¨Ø± Ø¨Ù† Ø´Ø¯" : "Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¨Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯");
        }
      } catch (e) {
        console.error(e);
        if (typeof showSnack === "function") showSnack("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ø³Ø±ÙˆØ± Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù†");
        else alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ø³Ø±ÙˆØ± Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù†");
      }
    };

    btnUnban.onclick = async () => {
  try {
    const rr = await fetch(API + "/admin/ban", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ uid, on: false })
    });
    const jk = await rr.json().catch(() => ({}));

    if (!jk?.ok) {
      if (jk?.error === "not_banned") {
        if (typeof showSnack === "function") showSnack("Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¨Ù† Ù†ÛŒØ³Øª.", "err");
        else alert("Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¨Ù† Ù†ÛŒØ³Øª.");
      } else {
        if (typeof showSnack === "function") showSnack("Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ù†", "err");
        else alert("Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ù†");
      }
      return;
    }

    if (typeof showSnack === "function") showSnack("Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¨Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯");
    else alert("Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¨Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯");

    await loadUserProfile(uid);
  } catch (e) {
    if (typeof showSnack === "function") showSnack("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ø³Ø±ÙˆØ± Ø¯Ø± Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ù†", "err");
    else alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡/Ø³Ø±ÙˆØ±");
  }
};




  }catch{}
}
btnDevices.onclick = async () => {
  const activeUid = window.activeUid;
  if (!activeUid) { alert("Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }

  try {
    const r = await fetch(API + "/admin/devices?uid=" + encodeURIComponent(activeUid));
    const j = await r.json();

    const list = Array.isArray(j?.devices) ? j.devices : [];
    const html = list.length
      ? list.map(d => `
          <div class="item">
            <div class="user-meta">
              <b class="mono" style="direction:ltr">${d.token.slice(0, 10)}â€¦</b>
              <small>Ø¯Ø³ØªÚ¯Ø§Ù‡: ${d.device || "-"}</small>
              <small>Ø§ÛŒØ¬Ø§Ø¯: ${d.createdAt ? new Date(d.createdAt).toLocaleString('fa-IR') : "-"}</small>
              <small>Ø¢Ø®Ø±ÛŒÙ†â€ŒÙØ¹Ø§Ù„ÛŒØª: ${d.lastSeen ? new Date(d.lastSeen).toLocaleString('fa-IR') : "-"}</small>
            </div>
            <div class="row">
              <button class="link ghost" data-revoke="${d.token}">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡</button>
            </div>
          </div>
        `).join("")
      : "<div class='muted'>Ù‡ÛŒÚ† Ø¯Ø³ØªÚ¯Ø§Ù‡ ÙØ¹Ø§Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>";

    openModal("Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±", html);

    document.querySelectorAll("[data-revoke]").forEach(b => {
      b.onclick = async () => {
        const token = b.getAttribute("data-revoke");
        if (!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ")) return;
        await fetch(API + "/auth/logout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, username: activeUid })
        });
        alert("Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø´Ø¯.");
        btnDevices.click(); // Ø¨Ø§Ø²Ø®ÙˆØ§Ù†ÛŒ Ù„ÛŒØ³Øª Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§
      };
    });
  } catch (e) {
    console.error(e);
    openModal("Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±", "<div class='muted'>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§</div>");
  }
};


// Chats table
let currentChats = [];
async function loadChatsFor(uid){
  const data = await jget("/admin/chats?uid="+encodeURIComponent(uid));
  const chats = Array.isArray(data?.chats) ? data.chats : [];

  // Ù‡Ù„Ù¾Ø± Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø§ÛŒÙ†Ú©Ù‡ Â«Ø±Ø£ÛŒÛŒÂ» ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ ÛŒØ§ Ù†Ù‡ (Ú†Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ØŒ Ú†Ù‡ Ø¢Ø¨Ø¬Ú©Øª)
  const hasAnyRating = (r) => {
    if (!r) return false;
    if (Array.isArray(r)) return r.length > 0;
    if (typeof r === "object") return Object.keys(r).length > 0;
    return false;
  };

  // Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú†ØªØŒ Ø±Ø£ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… ØªØ§ hasRatings Ù¾Ø± Ø´ÙˆØ¯
  // (Ø§ÛŒÙ† Ú©Ø§Ø± ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªØ¨ Â«Ú©Ø§Ø±Ø¨Ø±Ø§Ù†Â» Ø§Ø³Øª Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ù†Ø¯Ø§Ø´Øª)
  const enriched = await Promise.all(chats.map(async (c) => {
    try{
      const rr = await jget("/admin/ratings?chatId=" + encodeURIComponent(c.chatId));
      const has = hasAnyRating(rr?.ratings);
      return Object.assign({}, c, { hasRatings: !!has });
    }catch{
      return Object.assign({}, c, { hasRatings:false });
    }
  }));

  currentChats = enriched;
  renderChatsTable(currentChats);
}

function renderChatsTable(list){
  const q=(searchChat.value||"").trim().toLowerCase();
  const filtered = list.filter(c=>{
    const hay = (c.title+" "+(c.preview||"")+" "+(c.chatId||"")).toLowerCase();
    return !q || hay.includes(q);
  });
  const rows = filtered.map(c=>`
    <tr>
      <td class="mono">${escapeHtml(c.chatId)}</td>
      <td>${escapeHtml(c.title||"-")}</td>
      <td class="muted">${escapeHtml(c.preview||"")}</td>
      <td class="mono">${fmt(c.updatedAt||c.createdAt)}</td>
      <td>
  <button class="btn ghost" data-view="${c.chatId}">Ù†Ù…Ø§ÛŒØ´</button>
  ${c.hasRatings ? '<span title="Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø±Ø£ÛŒ Ø¯Ø§Ø±Ø¯">â˜…</span>' : ''}
  <button class="btn" data-del="${c.chatId}">Ø­Ø°Ù</button>
</td>

    </tr>
    
  `).join("");
  
  
  chatsTableWrap.innerHTML = `
    <table>
      <thead><tr><th>Ø´Ù†Ø§Ø³Ù‡</th><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§ÙˆÙ„ÛŒÙ† Ù¾ÛŒØ§Ù…</th><th>Ø¢Ø®Ø±ÛŒÙ†â€ŒØ¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th><th>Ø§Ú©Ø´Ù†</th></tr></thead>
      <tbody>${rows || ""}</tbody>
    </table>`;
  chatsTableWrap.querySelectorAll("[data-view]").forEach(b=> b.onclick=()=> showChat(b.dataset.view));
  chatsTableWrap.querySelectorAll("[data-del]").forEach(b=> b.onclick=()=> delChat(b.dataset.del));
}
searchChat.oninput = ()=> renderChatsTable(currentChats);
function renderAdminContent(s = "") {
  const str = String(s || "");
  const imgRe = /!\[[^\]]*\]\((https?:\/\/[^\s)]+)\)/g;

  // 1) ØªØ¨Ø¯ÛŒÙ„ Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ† ØªØµÙˆÛŒØ± Ø¨Ù‡ <img>
  let out = "";
  let lastIndex = 0;
  let m;
  while ((m = imgRe.exec(str)) !== null) {
    // Ù…ØªÙ† Ù‚Ø¨Ù„ Ø§Ø² ØªØµÙˆÛŒØ± Ø±Ø§ Ø§Ù…Ù† Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
    out += escapeHtml(str.slice(lastIndex, m.index));

    // Ø®ÙˆØ¯ ØªØµÙˆÛŒØ±
    const url = m[1];
    out += `<img src="${escapeHtml(url)}"
                 style="max-width:100%; height:auto; display:block; border-radius:12px; margin:6px 0" />`;
    lastIndex = imgRe.lastIndex;
  }
  // Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡Ù” Ù…ØªÙ†
  out += escapeHtml(str.slice(lastIndex));

  // 2) Ø§ØªÙˆ-Ù„ÛŒÙ†Ú© ÙÙ‚Ø· Ø±ÙˆÛŒ Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ Ø§Ø² ØªÚ¯â€ŒÙ‡Ø§
  const urlRe = /((https?:\/\/)[^\s)]+)\b/g;
  out = out
    .split(/(<[^>]+>)/g) // ØªÙ‚Ø³ÛŒÙ… Ø¨Ù‡ Â«ØªÚ¯Â» Ùˆ Â«ØºÛŒØ±ØªÚ¯Â»
    .map(chunk => {
      if (chunk.startsWith("<")) return chunk;          // Ø¯Ø§Ø®Ù„ ØªÚ¯â€ŒÙ‡Ø§ Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†
      return chunk.replace(
        urlRe,
        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
      );
    })
    .join("");

  return out;
}


async function showChat(chatId){

  // 1) Ø¯ÛŒØªØ§ Ø§Ø² Ø³Ø±ÙˆØ±
  const data = await jget("/admin/chat?chatId=" + encodeURIComponent(chatId));
  const chat = data.chat || {};
  let ratings = data.ratings || null;

  // Ø§Ú¯Ø± Ù‡Ù…Ø±Ø§Ù‡ Ù¾Ø§Ø³Ø® Ù†ÛŒØ§Ù…Ø¯ØŒ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ú¯ÛŒØ±
  if (!ratings) {
    try{
      const r2 = await jget("/admin/ratings?chatId=" + encodeURIComponent(chatId));
      ratings = (r2 && r2.ratings) ? r2.ratings : {};
    }catch{ ratings = {}; }
  }
    ratings = normalizeRatings(ratings);

      // --- ÛŒÚ©Ø³Ø§Ù†â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø±Ø£ÛŒâ€ŒÙ‡Ø§ Ø¨Ù‡ { [key]: "up"|"down" } ---
  function normalizeRatings(raw){
  const out = {};
  if (!raw) return out;

  if (Array.isArray(raw)){
    for (const it of raw){
      const k = it?.key || it?.id || it?.message_id || it?.msg_id;
      const v = it?.value ?? it?.val ?? it?.vote ?? it?.rating ?? it?.r;
      const norm =
        (v===true || v===1 || v==="1" || v==="up" || v==="ğŸ‘") ? "up" :
        (v===false|| v===-1|| v==="-1"|| v==="down"|| v==="ğŸ‘") ? "down" : null;
      if (k && norm) out[String(k)] = norm;
    }
    return out;
  }

  for (const [k,v] of Object.entries(raw)){
    let norm = null;
    if (v && typeof v === "object"){
      const vv = v.value ?? v.val ?? v.vote ?? v.rating ?? (v.up? "up" : (v.down? "down": null));
      if (vv===true || vv===1 || vv==="1" || vv==="up") norm="up";
      else if (vv===false || vv===-1 || vv==="-1" || vv==="down") norm="down";
    } else {
      if (v===true || v===1 || v==="1" || v==="up") norm="up";
      else if (v===false || v===-1 || v==="-1" || v==="down") norm="down";
    }
    if (k && norm) out[String(k)] = norm;
  }
  return out;
}
ratings = normalizeRatings(ratings);




  // 2) Ù‡Ù„Ù¾Ø±: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø±Ø£ÛŒ Ø¯Ù‚ÛŒÙ‚ ÛŒÚ© Ù¾ÛŒØ§Ù… (id ÛŒØ§ server_id Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§)
    // 2) Ù‡Ù„Ù¾Ø±: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø±Ø£ÛŒ Ø¯Ù‚ÛŒÙ‚ ÛŒÚ© Ù¾ÛŒØ§Ù… (id | client_id | server_id Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§)
  // 2) Ù‡Ù„Ù¾Ø±: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø±Ø£ÛŒ Ø¯Ù‚ÛŒÙ‚ ÛŒÚ© Ù¾ÛŒØ§Ù… (id | client_id | clientId | server_id | serverId + Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§)
function findRatingForMessage(m, ratings){
  if (!ratings) return null;
  const candidates = [];

  // Ø®ÙˆØ¯ Ù¾ÛŒØ§Ù…
  if (m.id) candidates.push(m.id);

  // Ù…ØªØ§Ø¯ÛŒØªØ§
  const mm = m.meta || {};
  if (mm.client_id) candidates.push(mm.client_id);
  if (mm.clientId)  candidates.push(mm.clientId);
  if (mm.server_id) candidates.push(mm.server_id);
  if (mm.serverId)  candidates.push(mm.serverId);

  // Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§
  if (Array.isArray(m.versions)) {
    for (const v of m.versions) {
      const vm = v?.meta || {};
      if (vm.client_id) candidates.push(vm.client_id);
      if (vm.clientId)  candidates.push(vm.clientId);
      if (vm.server_id) candidates.push(vm.server_id);
      if (vm.serverId)  candidates.push(vm.serverId);
      if (v?.id)        candidates.push(v.id);
    }
  }

  for (const k of candidates){
    const key = (k || "").toString();
    if (!key) continue;
    const val = ratings[key];
    if (val === "up" || val === "down") return val;
  }
  return null;
}



// Ù‡ÙÙ„Ù¾Ø±: Ù…ØªÙ†/ØªØµÙˆÛŒØ± Ø±Ø§ Ø§Ø² Ù¾ÛŒØ§Ù… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
function textOf(m){
  // 1) Ø§Ú¯Ø± content Ù‡Ø³ØªØŒ Ù‡Ù…Ø§Ù†
  let t = m?.content ?? m?.versions?.[m.active||0]?.content ?? "";
  if (t && typeof t === "string" && t.trim()) return t;

  // 2) Ø§Ú¯Ø± URL ØªØµÙˆÛŒØ± Ø¯Ø± Ù…ØªØ§ Ø¨Ø§Ø´Ø¯ØŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡ Markdown ØªØµÙˆÛŒØ± ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†
  const vm = m?.versions?.[m.active||0]?.meta || m?.meta || {};
  const img = vm.image || vm.image_url || vm.imageUrl || vm.url;
  if (img && typeof img === "string") {
    const alt = vm.title || "image";
    return `![${alt}](${img})`;
  }

  // 3) Ø§Ú¯Ø± Ù‡ÛŒÚ†â€ŒÚ©Ø¯Ø§Ù… Ù†Ø¨ÙˆØ¯ØŒ Ø±Ø´ØªÙ‡ Ø®Ø§Ù„ÛŒ
  return "";
}

// 3) Ø³Ø§Ø®Øª HTML Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
// Ù‡Ù…Ø§Ù† Ù‡ÙÙ„Ù¾Ø± Ù…ØªÙ†
function textOf(m){
  let t = m?.content ?? m?.versions?.[m.active||0]?.content ?? "";
  if (t && typeof t === "string" && t.trim()) return t;
  const vm = m?.versions?.[m.active||0]?.meta || m?.meta || {};
  const img = vm.image || vm.image_url || vm.imageUrl || vm.url;
  if (img && typeof img === "string") {
    const alt = vm.title || "image";
    return `![${alt}](${img})`;
  }
  return "";
}

const msgs = (chat.messages || []).map(m => {
  let rateBadge = "";
  if (m.role === "assistant") {
    const val = findRatingForMessage(m, ratings);
    if (val === "up")   rateBadge = '<span class="tag good">ğŸ‘</span>';
    else if (val === "down") rateBadge = '<span class="tag bad">ğŸ‘</span>';
  }

  // Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÛŒ Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§
  const sid = m.id || (m.meta && m.meta.server_id) ||
              (m.versions?.[m.active||0]?.meta?.server_id) || "-";
  const cid = (m.meta && m.meta.client_id) ||
              (m.versions?.[m.active||0]?.meta?.client_id) || "";
  const idLine = cid
    ? `<span class="mono">SID: ${escapeHtml(sid)} | CID: ${escapeHtml(cid)}</span>`
    : `<span class="mono">SID: ${escapeHtml(sid)}</span>`;

  // Ù…ØªÙ†/Ø¹Ú©Ø³ Ù¾ÛŒØ§Ù… Ø±Ø§ Ø¨ÛŒØ±ÙˆÙ† Ø§Ø² template Ø¨Ø³Ø§Ø²
  const txt = textOf(m);
  return `
  <div class="item ${m.role === "user" ? "user" : ""}">
    <div>
      <div><b>${m.role === "assistant" ? "Ø¨Ø§Øª" : "Ú©Ø§Ø±Ø¨Ø±"}</b> ${rateBadge}</div>
        ${idLine}
        <div class="muted">${fmt(m.ts)}</div>
        <div>${renderAdminContent(txt)}</div>
      </div>
    </div>
  `;
}).join("");







  // 4) ØªØ²Ø±ÛŒÙ‚ Ø¨Ù‡ Ù¾Ù†Ù„ Ø¬Ø²Ø¦ÛŒØ§Øª
  const html = `
  <div class="row" style="justify-content:space-between">
    <div class="flex" style="gap:10px">
      <b>Ú¯ÙØªÚ¯Ùˆ: ${escapeHtml(chatId)}</b>
    </div>
    <div class="muted">${fmt(chat.updatedAt||chat.createdAt)}</div>
  </div>
  <div class="hr" style="margin:12px 0"></div>
  <div style="display:flex;flex-direction:column;gap:12px">
    ${msgs || '<i class="muted">Ù¾ÛŒØ§Ù…ÛŒ Ù†ÛŒØ³Øª</i>'}
  </div>
`;
openModal("Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯ÙØªÚ¯Ùˆ", html);

}


async function delChat(chatId, refreshDetail=false){
  if (!confirm("Ø­Ø°Ù Ø§ÛŒÙ† Ú¯ÙØªâ€ŒÙˆÚ¯ÙˆØŸ")) return;
  await jpost("/admin/deleteChat",{ chatId });
  await loadChatsFor(userList.value);
  if (refreshDetail) chatDetail.innerHTML="";
}

// Export per user
exportUser.onclick = async()=>{
  const uid=userList.value;
  const data = await jget("/admin/export?uid="+encodeURIComponent(uid));
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=`export_${uid}.json`; a.click();
  URL.revokeObjectURL(url);
};


// Analytics
async function loadStats(){
  const s = await jget("/admin/summary");
  statChats.textContent = s.chats||0;
  statMsgs.textContent = s.messages||0;
  statClicks.textContent = s.clicks||0;
  statUsers.textContent = s.users||0;
}
refreshStats.onclick = loadStats;

resetAll.onclick = async()=>{
  if (!confirm("Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ² Ø±ÛŒØ³Øª Ø´ÙˆØ¯ØŸ (ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª)")) return;
  const r = await jpost("/admin/reset",{ confirm:true });
  alert(r?.ok?"Ø±ÛŒØ³Øª Ø´Ø¯":"Ø®Ø·Ø§");
  await loadUsers(); await loadStats();
  chatsTableWrap.innerHTML=""; chatDetail.innerHTML="";
};

exportAll.onclick = async()=>{
  const data = await jget("/admin/export");
  exportBox.textContent = JSON.stringify(data,null,2);
};

// Boot
loadStats();

// ---------------- Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ ----------------
async function loadUsersList(){
  const box = document.getElementById("userList");
  if (!box) return;
  box.innerHTML = "Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦";

  try{
    const r = await fetch(API + "/admin/users");
    const j = await r.json();
    const users = Array.isArray(j?.users) ? j.users : [];
    if (!users.length){
      box.textContent = "Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.";
      return;
    }

    box.innerHTML = "";
    users.forEach(u=>{
      const div = document.createElement("div");
      div.className = "user-item";
      div.dataset.uid = u.uid;

      const right = document.createElement("div");
      right.className = "user-meta";
      right.innerHTML = `
        <b class="mono" style="direction:ltr">${u.uid}</b>
        <small>ØªØ¹Ø¯Ø§Ø¯ Ú¯ÙØªÚ¯Ùˆ: ${u.chats}</small>
      `;

      const left = document.createElement("small");
      left.textContent = u.lastSeen ? new Date(u.lastSeen).toLocaleString('fa-IR') : "-";

      div.appendChild(right);
      div.appendChild(left);

      div.onclick = ()=>{
        document.querySelectorAll(".user-item.active").forEach(x=>x.classList.remove("active"));
        div.classList.add("active");
        loadUserChats(u.uid);
        loadUserProfile(u.uid);
        window.activeUid = u.uid;   // âœ… Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø³Ø±Ø§Ø³Ø±ÛŒ Ù†Ú¯Ù‡ Ø¯Ø§Ø±

      };

      box.appendChild(div);
    });
  }catch(e){
    box.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†";
  }
}

async function loadUserChats(uid){
  const host = document.getElementById("chatsTableWrap");
  if (!host) return;

  host.innerHTML = "Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§â€¦";
  try{
    const r = await fetch(API + `/admin/chats?uid=${encodeURIComponent(uid)}`);
    const j = await r.json();
    const chats = Array.isArray(j?.chats) ? j.chats : [];
// ğŸ” Ù¾Ø± Ú©Ø±Ø¯Ù† Ù¾Ø±Ú†Ù… Ø±Ø£ÛŒâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú¯ÙØªÚ¯Ùˆ
const enriched = await Promise.all(chats.map(async (c) => {
  try{
    const rrate = await jget("/admin/ratings?chatId=" + encodeURIComponent(c.chatId));
    const rr = rrate && rrate.ratings;
    const has = rr && (Array.isArray(rr) ? rr.length > 0 : Object.keys(rr).length > 0);
    return Object.assign({}, c, { hasRatings: !!has });
  }catch{
    return Object.assign({}, c, { hasRatings: false });
  }
}));

    if (!chats.length){
      host.textContent = "Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.";
      return;
    }

    host.innerHTML = "";
    const table = document.createElement("table");
    table.innerHTML = `
      <thead><tr><th>Ø´Ù†Ø§Ø³Ù‡</th><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ø¢Ø®Ø±ÛŒÙ†â€ŒØ¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th><th>Ø§Ú©Ø´Ù†</th></tr></thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector("tbody");
enriched.forEach(c=>{

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${c.chatId}</td>
        <td>${c.title || "-"}</td>
        <td>${c.updatedAt ? new Date(c.updatedAt).toLocaleString('fa-IR') : "-"}</td>
<td>
  <button class="btn ghost" onclick="showChat('${c.chatId}')">Ù†Ù…Ø§ÛŒØ´</button>
  ${c.hasRatings ? '<span title="Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø±Ø£ÛŒ Ø¯Ø§Ø±Ø¯">â˜…</span>' : ''}
</td>

      `;
      tbody.appendChild(tr);
    });
    host.appendChild(table);
  }catch(e){
    host.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§";
  }
}

// Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
document.addEventListener("DOMContentLoaded", loadUsersList);

// DOM refs
const last30Chats = document.getElementById("last30Chats");
const last30Msgs  = document.getElementById("last30Msgs");
const todayChats  = document.getElementById("todayChats");
const todayMsgs   = document.getElementById("todayMsgs");
const todayUsers  = document.getElementById("todayUsers");
const weekChart   = document.getElementById("weekChart");
const modelsBox   = document.getElementById("modelsBox");



  // ÛŒÚ© Ø¯Ø±Ø§ÙˆÙ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ù‡ÙØªÚ¯ÛŒ
  function drawWeek(buckets){
    const ctx = weekChart.getContext("2d");
    ctx.clearRect(0,0,weekChart.width,weekChart.height);

    const w = weekChart.width, h = weekChart.height;
    const pad = 24;
    const space = (w - pad*2) / Math.max(1, buckets.length);
    const bw = space * 0.7;
    const max = Math.max(1, ...buckets);

    // Ù…Ø­ÙˆØ±
    ctx.strokeStyle = "#cbd5e1";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad, h - pad);
    ctx.lineTo(w - pad, h - pad);
    ctx.stroke();

    // Ù…ÛŒÙ„Ù‡â€ŒÙ‡Ø§
    for (let i=0; i<buckets.length; i++){
      const x = pad + i*space + (space - bw)/2;
      const bh = Math.round((h - pad*2) * (buckets[i]/max));
      ctx.fillStyle = "#0f172a";
      ctx.fillRect(x, h - pad - bh, bw, bh);

      // Ø¨Ø±Ú†Ø³Ø¨ Ø±ÙˆØ²Ù‡Ø§
      ctx.fillStyle="#64748b";
      ctx.font="12px IRANYekanX, Tahoma";
      const lbl = ["Ø´","ÛŒ","Ø¯","Ø³","Ú†","Ù¾","Ø¬"][i] || "";
      ctx.fillText(lbl, x + bw/2 - 6, h - pad + 16);
    }
  }

  // Ø¢Ù…Ø§Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø³Ù…Øª Ú©Ù„Ø§ÛŒÙ†Øª (Ø¨Ø§ ÙØ§Ù„Ø¨Ú©)
  async function loadStatsPlus(){
    try{
      // Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§Ø² /admin/analyticsPlus Ø¨Ú¯ÛŒØ±ÛŒÙ…Ø› Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯ØŒ ÙØ§Ù„Ø¨Ú© Ø¨Ù‡ summary
      let j = null;
      try{
        const r = await fetch(API + "/admin/analyticsPlus");
        if (r.ok) j = await r.json();
      }catch{}

      if(!j){
        const s = await (await fetch(API + "/admin/summary")).json();
        // ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ Ú©Ù„ÛŒ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ…Ø› Ù†Ù…ÙˆØ¯Ø§Ø± Ø±Ø§ Ø®Ø§Ù„ÛŒ Ù…ÛŒâ€ŒÚ©Ø´ÛŒÙ…
        last30Chats.textContent = "â€”";
        last30Msgs.textContent  = "â€”";
        todayChats.textContent  = String(s.chats||0);
        todayMsgs.textContent   = String(s.messages||0);
        todayUsers.textContent  = String(s.users||0);
        modelsBox.textContent   = "";
        drawWeek([]); 
        return;
      }

      // Ø§Ú¯Ø± Ø³Ø§Ø®ØªØ§Ø± analyticsPlus Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙˆØ¯:
      last30Chats.textContent = j.last30?.chats ?? "â€”";
      last30Msgs.textContent  = j.last30?.msgs  ?? "â€”";
      todayChats.textContent  = j.today?.chats  ?? "â€”";
      todayMsgs.textContent   = j.today?.msgs   ?? "â€”";
      // helper Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨
function qs(sel){ return document.querySelector(sel); }

// today
qs("#newUsersToday") && (qs("#newUsersToday").innerText = j.today?.new_users ?? "â€”");

// week
qs("#weekChats")  && (qs("#weekChats").innerText  = j.week?.chats ?? "â€”");
qs("#weekMsgs")   && (qs("#weekMsgs").innerText   = j.week?.msgs  ?? "â€”");
qs("#newUsersWeek") && (qs("#newUsersWeek").innerText = j.week?.new_users ?? "â€”");
qs("#activeWeek") && (qs("#activeWeek").innerText = j.week?.active_users ?? "â€”");

// month
qs("#monthChats") && (qs("#monthChats").innerText = j.month?.chats ?? "â€”");
qs("#monthMsgs")  && (qs("#monthMsgs").innerText  = j.month?.msgs  ?? "â€”");
qs("#newUsersMonth") && (qs("#newUsersMonth").innerText = j.month?.new_users ?? "â€”");
qs("#activeMonth") && (qs("#activeMonth").innerText = j.month?.active_users ?? "â€”");

// year
qs("#yearChats")  && (qs("#yearChats").innerText  = j.year?.chats ?? "â€”");
qs("#yearMsgs")   && (qs("#yearMsgs").innerText   = j.year?.msgs  ?? "â€”");
qs("#newUsersYear") && (qs("#newUsersYear").innerText = j.year?.new_users ?? "â€”");
qs("#activeYear") && (qs("#activeYear").innerText = j.year?.active_users ?? "â€”");

      todayUsers.textContent  = j.today?.users  ?? "â€”";

      // Ù…Ø¯Ù„â€ŒÙ‡Ø§
      const models = j.models || {};
      modelsBox.textContent = Object.keys(models).length
        ? Object.entries(models).map(([k,v])=>`${k}: ${v}`).join("\n")
        : "â€”";

      // Ù†Ù…ÙˆØ¯Ø§Ø± Ù‡ÙØªÚ¯ÛŒ
      drawWeek(j.week?.buckets || []);
    }catch(e){
      console.log("loadStatsPlus error:", e);
      drawWeek([]);  // Ù„Ø§Ø§Ù‚Ù„ Ù†Ù…ÙˆØ¯Ø§Ø± Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯ Ùˆ Ø´Ú©Ø³Øª Ù†Ø®ÙˆØ±Ø¯
    }
  }
// ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¯Ø± Ø¨ÙˆØª Ùˆ Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Refresh
loadStatsPlus();
refreshStats.addEventListener("click", ()=>{
  loadStats();    // Ù‚Ø¯ÛŒÙ…ÛŒ
  loadStatsPlus();// Ø¬Ø¯ÛŒØ¯
});

</script>

<!-- Ø¯Ú©Ù…Ù‡ Ùˆ Ù¾Ø§Ù†Ù„ Â«Ù…Ø´Ø§Ù‡Ø¯Ù‡â€ŒÛŒ Ù‡Ù…Ù‡â€ŒÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§Â» -->
<div class="panel" id="allPanel" style="display:none"></div>
<div class="panel" id="livePanel" style="display:none"></div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± -->
<div id="authAdminModal" class="modal" aria-hidden="true" style="display:none">
  <div class="modal-card">
    <h3 style="margin-top:0">Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±</h3>
    <div class="modal-row">
      <div>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: <b id="authAdmUsername" class="mono">â€”</b></div>
      <div id="authAdmMeta" class="muted" style="font-size:12px"></div>
    </div>
    <div class="modal-row">
      <input id="authAdmNewPass" type="password" placeholder="Ù¾Ø³ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯">
    </div>
    <div class="actions">
      <button id="authAdmClose" class="link ghost">Ø¨Ø³ØªÙ†</button>
      <button id="authAdmSave" class="link">Ø«Ø¨Øª Ù¾Ø³ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯</button>
    </div>
  </div>
</div>
<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª (chatModal) -->
<div id="chatModal" class="modal" aria-hidden="true" style="display:none">
  <div class="modal-card" style="max-height:90vh; overflow:auto">

    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
      <h3 id="chatModalTitle" style="margin:0">Ø¬Ø²Ø¦ÛŒØ§Øª</h3>
      <button id="chatModalClose" class="link ghost">Ø¨Ø³ØªÙ†</button>
    </div>
    <div id="chatModalBody" style="max-height:70vh; overflow:auto"></div>

  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø­Ø°Ù Ú¯ÙØªÚ¯Ùˆ -->
<div class="modal" id="delModal" aria-hidden="true">
  <div class="modal-card">
    <h3>Ø­Ø°Ù Ú¯ÙØªÚ¯Ùˆ</h3>
    <p>Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ</p>
    <div class="actions">
      <button class="link ghost" id="delCancel">Ù„ØºÙˆ</button>
      <button class="link ghost" id="delAdminOnly">Ø­Ø°Ù ÙÙ‚Ø· Ø¯Ø± ØµÙØ­Ù‡â€ŒÛŒ Ù…Ø¯ÛŒØ±ÛŒØª</button>
      <button class="link" id="delEverywhere">Ø­Ø°Ù Ù‡Ù… Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ù‡Ù… Ù†Ø²Ø¯ Ú©Ø§Ø±Ø¨Ø±</button>
    </div>
  </div>
</div>

<!-- Ø§Ø³Ù†Ú©â€ŒØ¨Ø§Ø± ÙˆØ§Ú¯Ø±Ø¯ -->
<div class="snack" id="snack">
  <div class="snack-inner">
    <span id="snackText"></span>
    <button id="snackUndo">ÙˆØ§Ú¯Ø±Ø¯</button>
  </div>
</div>

<script>
  const allPanel = document.getElementById("allPanel");
  const btnAll   = document.getElementById("btnAll");
  const delModal = document.getElementById("delModal");
  const delCancel = document.getElementById("delCancel");
  const delAdminOnly = document.getElementById("delAdminOnly");
  const delEverywhere = document.getElementById("delEverywhere");
  const snack = document.getElementById("snack");
  const snackText = document.getElementById("snackText");
  const snackUndo = document.getElementById("snackUndo");
  
  // Ù…Ø®ÙÛŒâ€ŒØ³Ø§Ø²ÛŒ ÙÙ‚Ø· Ø¯Ø± Ø§Ø¯Ù…ÛŒÙ† (Ù„ÙˆÚ©Ø§Ù„)
  const KEY_HIDDEN = "admin_hidden_chats_v1";
  function loadHidden(){ try{return JSON.parse(localStorage.getItem(KEY_HIDDEN)||"[]")}catch{return[]} }
  function saveHidden(x){ localStorage.setItem(KEY_HIDDEN, JSON.stringify(x||[])); }
  
  let ALL = [];         // Ù‡Ù…Ù‡â€ŒÛŒ Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ uid)
  let SELECTED = null;  // Ú†Øª Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù
  let UNDO = null;      // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Â«Ø­Ø°Ù Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØªÂ» Ù‚Ø§Ø¨Ù„ ÙˆØ§Ú¯Ø±Ø¯ Ø§Ø³Øª
  
  function fmt(ts){
    if(!ts) return "-";
    try{
      return new Intl.DateTimeFormat('fa-IR-u-ca-persian', {dateStyle:"medium", timeStyle:"short"}).format(new Date(ts));
    }catch{ return new Date(ts).toLocaleString('fa-IR'); }
  }
  
  // Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø± Ø´Ø¯Ù† Ú†Øªâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø±ÛŒâ€ŒØ§Ú©Øª/Ø±Ø£ÛŒ Ø¯Ø§Ø±Ù†Ø¯
  function hasRatings(ratingsMap){ return ratingsMap && Object.keys(ratingsMap).length > 0; }
  
  // Ø±Ù†Ø¯Ø±
  function renderAll(list){
    const hidden = new Set(loadHidden());
    const wrap = document.createElement("div");
    wrap.innerHTML = `
      <div class="row">
        <h3 style="margin:0">Ù‡Ù…Ù‡â€ŒÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</h3>
        <span class="badge" id="allCount"></span>
      </div>
      <div class="search">
        <input id="allQuery" placeholder="Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù†ØŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ùˆ Ø­ØªÛŒ Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§â€¦">
        <button class="link ghost" id="allRefresh">Ù†ÙˆØ³Ø§Ø²ÛŒ</button>
      </div>
      <div class="list" id="allList"></div>
    `;
    allPanel.innerHTML = "";
    allPanel.appendChild(wrap);
  
    const listEl = document.getElementById("allList");
    const countEl = document.getElementById("allCount");
    const qEl = document.getElementById("allQuery");
    const refreshBtn = document.getElementById("allRefresh");
  
    function draw(rows){
      listEl.innerHTML = "";
      countEl.textContent = `${rows.length} Ú¯ÙØªÚ¯Ùˆ`;
      rows.forEach(r=>{
        if (hidden.has(r.chatId)) return;
        const item = document.createElement("div");
        item.className = "item";
        const left = document.createElement("div");
// Ø³ØªØ§Ø±Ù‡ Ø±Ø§ Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø¨Ø±ÙˆØ¯ Ú©Ù†Ø§Ø± Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
left.innerHTML = `
  <div>
    <b>${r.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"}</b>
    <div class="meta">Ú©Ø§Ø±Ø¨Ø±: ${r.username} | Ø³Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡: ${fmt(r.createdAt)} | Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: ${fmt(r.updatedAt)}</div>
  </div>
`;

const right = document.createElement("div");
right.className = "row";

if (r._hasRatings) {
  const starEl = document.createElement("span");
  starEl.className = "star";     // Ù‡Ù…ÛŒÙ† Ú©Ù„Ø§Ø³ Ø¯Ø± <style> ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡
  starEl.textContent = "â˜…";
  // Ø¨ÛŒØ§Ø± Ø¯Ø±Ø³Øª Ú©Ù†Ø§Ø±Ù Â«Ù†Ù…Ø§ÛŒØ´Â»
  right.appendChild(starEl);
}
const openBtn = document.createElement("button");
openBtn.className = "link ghost";
openBtn.textContent = "Ù†Ù…Ø§ÛŒØ´";
openBtn.onclick = ()=> openChat(r);



const delBtn = document.createElement("button");
delBtn.className = "link";
delBtn.textContent = "Ø­Ø°Ù";
delBtn.onclick = ()=> openDel(r);



// Ø§ÙˆÙ„ Ø¯Ú©Ù…Ù‡Ù” Ù†Ù…Ø§ÛŒØ´ Ø±Ø§ Ù…ÛŒâ€ŒÚ†ÛŒÙ†ÛŒÙ…
right.appendChild(openBtn);

// Ø§Ú¯Ø± Ø±Ø£ÛŒ Ø¯Ø§Ø±Ø¯ØŒ Ø³ØªØ§Ø±Ù‡ Ø±Ø§ Â«Ø¨Ø¹Ø¯ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ùˆ Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø°ÙÂ» Ø¨Ú¯Ø°Ø§Ø±


// Ø¢Ø®Ø± Ù‡Ù… Ø¯Ú©Ù…Ù‡Ù” Ø­Ø°Ù
right.appendChild(delBtn);

item.appendChild(left);
item.appendChild(right);


        listEl.appendChild(item);
      });
    }
  
    function filter(){
      const q = (qEl.value||"").trim().toLowerCase();
      if(!q) return draw(list);
      const hits = list.filter(r=>{
        // Ø¬Ø³Øªâ€ŒÙˆØ¬ÙˆÛŒ Ú¯Ø³ØªØ±Ø¯Ù‡: Ø¹Ù†ÙˆØ§Ù†ØŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ØŒ Ù‡Ù…Ù‡â€ŒÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ùˆ Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§
        const hay = (
          (r.title||"") + " " +
          (r.preview||"") + " " +
          (r._allText || "") + " " +
          (r.chatId||"") + " " +
          (r.username||"")
        ).toLowerCase();
        return hay.includes(q);
      });
      draw(hits);
    }
  
    qEl.oninput = filter;
    refreshBtn.onclick = loadAll;
    draw(list);
  }
  
  async function loadAll(){
  // 1) Ø§ÙˆÙ„ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
  const ru = await fetch(API + "/admin/users");
  const ju = await ru.json();

  const rows = [];
  // 2) Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø±ØŒ Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§
  for (const u of (ju.users||[])){
    try{
const rc = await fetch(API + "/admin/chats?uid=" + encodeURIComponent(u.uid))


      const jc = await rc.json();
      for (const c of (jc.chats||[])){
        // Ø³ØªØ§Ø±Ù‡ Ø±Ø§ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¨Ø§ Ú¯Ø±ÙØªÙ† Ø±ÛŒØªÛŒÙ†Ú¯ Ù‡Ø± Ú†Øª Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ø²Ø´Ø¯Ù† Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… ÛŒØ§ Ø³Ø§Ø¯Ù‡: false
        rows.push({
          uid: u.uid,
          chatId: c.chatId,
          createdAt: c.createdAt,
          updatedAt: c.updatedAt,
          title: c.title,
          preview: (c.preview||""),
          _hasRatings: !!c.hasRatings,   // â† Ù…Ù‡Ù…: Ø§Ø² Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©
          _allText: ""   // Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²ØŒ Ù…ÙˆÙ‚Ø¹ openChat ØªÚ©Ù…ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        });
      }
    }catch{}
  }
  rows.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
  ALL = rows;
  

  // Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ± Ù¾Ù†Ù„â€ŒÙ‡Ø§
  document.getElementById("viewChats").style.display = "none";
  document.getElementById("viewAnalytics").style.display = "none";
  document.getElementById("tabChats").classList.remove("active");
  document.getElementById("tabAnalytics").classList.remove("active");

  allPanel.style.display = "block";
  renderAll(rows);
}

  
  // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ÛŒÚ© Ú¯ÙØªâ€ŒÙˆÚ¯Ùˆ (Ø¯Ø± Ù‡Ù…Ø§Ù† Ù¾Ù†Ù„ØŒ Ø³Ø§Ø¯Ù‡)
  async function openChat(row){
    const r = await fetch(API + "/admin/chat?chatId=" + encodeURIComponent(row.chatId));
const j = await r.json();

    const c = j.chat || {};
    // Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø± (Ù†Ù…Ø§ÛŒØ´ÛŒ): index+1 Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ±ØªÛŒØ¨ ALL (Ø¨Ø±Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒâ€ŒØ§Ø´ Ø¨Ø§ÛŒØ¯ Ø³Ø±ÙˆØ± message-id Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡Ø¯)
    const userCode = 1 + [...new Set(ALL.map(x=>x.uid))].indexOf(row.uid);
  
    const box = document.createElement("div");
    box.className = "panel";
    // helper: Ù†Ú¯Ø§Ø´Øª Ø¯Ø±Ø³Øª msg.id / meta.server_id / Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§
// Ø¨Ø¹Ø¯ Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ const data = await jget("/admin/chat?chatId=...") Ø±Ø§ Ú¯Ø±ÙØªÛŒ:
const chat = j.chat || {};
const ratings = j.ratings || {};


// helper: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø±Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ ÛŒÚ© Ù¾ÛŒØ§Ù… (Ù‡Ù…Ø§Ù† ØªØ§Ø¨Ø¹ Ø¨Ø§Ù„Ø§)

// --- ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ø§ Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±:
function findRatingForMessage(m, ratings){
  if (!ratings) return null;
  const candidates = [];

  if (m.id) candidates.push(m.id);

  const mm = m.meta || {};
  if (mm.client_id) candidates.push(mm.client_id);
  if (mm.clientId)  candidates.push(mm.clientId);
  if (mm.server_id) candidates.push(mm.server_id);
  if (mm.serverId)  candidates.push(mm.serverId);

  if (Array.isArray(m.versions)) {
    for (const v of m.versions) {
      const vm = v?.meta || {};
      if (vm.client_id) candidates.push(vm.client_id);
      if (vm.clientId)  candidates.push(vm.clientId);
      if (vm.server_id) candidates.push(vm.server_id);
      if (vm.serverId)  candidates.push(vm.serverId);
      if (v?.id)        candidates.push(v.id);
    }
  }

  for (const k of candidates){
    const key = (k || "").toString();
    if (!key) continue;
    const val = ratings[key];
    if (val === "up" || val === "down") return val;
  }
  return null;
}





// Ù‡Ù…Ø§Ù† Ù‡ÙÙ„Ù¾Ø± Ù…ØªÙ†
function textOf(m){
  let t = m?.content ?? m?.versions?.[m.active||0]?.content ?? "";
  if (t && typeof t === "string" && t.trim()) return t;
  const vm = m?.versions?.[m.active||0]?.meta || m?.meta || {};
  const img = vm.image || vm.image_url || vm.imageUrl || vm.url;
  if (img && typeof img === "string") {
    const alt = vm.title || "image";
    return `![${alt}](${img})`;
  }
  return "";
}
function escapeHtml(s=""){
  return String(s)
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}

const msgsHtml = (Array.isArray(chat.messages) ? chat.messages : []).map(m => {
  const isBot = (m?.role === "assistant");

  // Ù…ØªÙ†/Ø¹Ú©Ø³ Ø¨Ø§ Ù‡ÙÙ„Ù¾Ø±
  const txt = textOf(m);
  const bodyHtml = `<div>${renderAdminContent(txt)}</div>`;

  // Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§
  const cid = m?.meta?.client_id || "";
  const sid = m?.id || m?.meta?.server_id || "-";
  const idLine = cid
    ? `<div class="mono">SID: ${escapeHtml(sid)} | CID: ${escapeHtml(cid)}</div>`
    : `<div class="mono">SID: ${escapeHtml(sid)}</div>`;

  // Ø¨Ø¬ Ø±Ø£ÛŒ (Ø¯Ù‚ÛŒÙ‚ØŒ Ø¨Ø§ ratings Ù‡Ù…Ø§Ù† Ú†Øª)
  let rateBadge = "";
  if (isBot) {
    const val = findRatingForMessage(m, ratings);
    if (val === "up")   rateBadge = '<span class="tag good">ğŸ‘</span>';
    else if (val === "down") rateBadge = '<span class="tag bad">ğŸ‘</span>';
  }

  return `
  <div class="item ${isBot ? "" : "user"}">

      <div>
        <div><b>${isBot ? "Ø¨Ø§Øª" : "Ú©Ø§Ø±Ø¨Ø±"}</b> ${rateBadge}</div>
        ${idLine}
        ${bodyHtml}
      </div>
      <div class="muted">${fmt(m?.ts || chat?.updatedAt || chat?.createdAt)}</div>
    </div>
  `;
}).join("");





// Ø³Ù¾Ø³ detail.innerHTML ÛŒØ§ allDetail.innerHTML Ø±Ø§ Ø¨Ø§ msgs Ø¨Ú¯Ø°Ø§Ø±



  
    box.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <b>${row.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"}</b>
          <div class="meta">Ú©Ø§Ø±Ø¨Ø±: ${row.uid} (Ú©Ø¯: ${userCode}) | Ø³Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡: ${fmt(c.createdAt)} | Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: ${fmt(c.updatedAt)}</div>
        </div>
        <div class="row">
          <button class="link ghost" id="allClose">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
          <button class="link" onclick='(${openDel.toString()})(${JSON.stringify(row)})'>Ø­Ø°Ù</button>
          
        </div>
      </div>
      <hr style="border:none;border-top:1px dashed #e5e7eb; margin:10px 0">
      ${msgsHtml || "<div class='meta'>Ù¾ÛŒØ§Ù…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>"}

    `;
    allPanel.innerHTML = "";
    allPanel.appendChild(box);
    allPanel.style.display = "block";
    const allCloseBtn = document.getElementById("allClose");
if (allCloseBtn) allCloseBtn.onclick = ()=> renderAll(ALL);

  }
  
  // Ù¾Ù†Ø¬Ø±Ù‡ Ø­Ø°Ù
  function openDel(row){
    SELECTED = row;
    delModal.classList.add("show");
    delModal.setAttribute("aria-hidden","false");
  }
  function closeDel(){
    delModal.classList.remove("show");
    delModal.setAttribute("aria-hidden","true");
  }
  delCancel.onclick = closeDel;
  
  function showSnack(text, onUndo){
    snackText.textContent = text;
    snack.style.display = "flex";
    snackUndo.onclick = ()=>{
      snack.style.display = "none";
      onUndo && onUndo();
    };
    setTimeout(()=> snack.style.display="none", 4000);
  }
  
  // Ø­Ø°Ù ÙÙ‚Ø· Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª (Ù„ÙˆÚ©Ø§Ù„)
  delAdminOnly.onclick = ()=>{
    const h = loadHidden();
    if (SELECTED){
      h.push(SELECTED.chatId);
      saveHidden(h);
      UNDO = ()=>{ saveHidden(loadHidden().filter(x=>x !== SELECTED.chatId)); loadAll(); };
      showSnack("Ø´Ù…Ø§ Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø­Ø°Ù Ú©Ø±Ø¯ÛŒØ¯ | ÙˆØ§Ú¯Ø±Ø¯", UNDO);
      loadAll();
    }
    closeDel();
  };
  
  // Ø­Ø°Ù Ú©Ø§Ù…Ù„ (Ø³Ø±ÙˆØ± + Ú©Ø§Ø±Ø¨Ø±) â€” ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Â«ÙˆØ§Ú¯Ø±Ø¯ Ù†Ø¯Ø§Ø±Ø¯Â» Ú†ÙˆÙ† ÙˆÙˆØ±Ú©Ø± Ø§Ù„Ø§Ù† API Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ù†Ø¯Ø§Ø±Ø¯
  delEverywhere.onclick = async ()=>{
    if (!SELECTED) return;
    try{
      const r = await fetch(API + "/admin/deleteChat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ chatId: SELECTED.chatId })
      });
      const j = await r.json();
      if (j?.ok){
        showSnack("Ú¯ÙØªÚ¯Ùˆ Ø­Ø°Ù Ø´Ø¯ (ØºÛŒØ±Ù‚Ø§Ø¨Ù„ ÙˆØ§Ú¯Ø±Ø¯)", null);
        loadAll();
      } else {
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±: " + (j?.error||""));
      }
    }catch(e){
      alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡");
    }
    closeDel();
  };
  
  // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Â«Ù…Ø´Ø§Ù‡Ø¯Ù‡â€ŒÛŒ Ù‡Ù…Ù‡â€ŒÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§Â»
  btnAll && (btnAll.onclick = loadAll);
  const livePanel = document.getElementById("livePanel");
const btnLive   = document.getElementById("btnLive");
let LIVE_TIMER = null, LIVE_SINCE = 0;

function renderLiveBox(){
  livePanel.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">Ù…Ø§Ù†ÛŒØªÙˆØ± Ø²Ù†Ø¯Ù‡</h3>
      <button class="link ghost" id="liveBack">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>
    <div id="liveBody" class="mono" style="max-height:70vh; overflow:auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px"></div>
  `;
  const back = document.getElementById("liveBack");
  back.onclick = ()=>{
    clearInterval(LIVE_TIMER);
    livePanel.style.display = "none";
    viewChats.style.display = "block";
    tabChats.classList.add("active");
  };
}

async function pollLive(){
  try{
    const r = await fetch(API + "/admin/live?since=" + LIVE_SINCE);
    const j = await r.json();
    const body = document.getElementById("liveBody");
    (j.events||[]).reverse().forEach(ev=>{
      const line = `[${new Date(ev.ts).toLocaleTimeString("fa-IR")}] ${ev.type} ${ev.chatId||""} ${ev.role||""}`;
      const div = document.createElement("div"); div.textContent = line;
      body.prepend(div);
    });
    LIVE_SINCE = j.now || Date.now();
  }catch{}
}

btnLive.onclick = ()=>{
  // Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ± Ù¾Ù†Ù„â€ŒÙ‡Ø§
  document.getElementById("viewChats").style.display = "none";
  document.getElementById("viewAnalytics").style.display = "none";
  document.getElementById("allPanel").style.display = "none";

  livePanel.style.display = "block";
  renderLiveBox();
  clearInterval(LIVE_TIMER);
  LIVE_SINCE = 0;
  pollLive();
  LIVE_TIMER = setInterval(pollLive, 2000);
};
// ==== Ø¯Ú©Ù…Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± (Ø§Ø¯Ù…ÛŒÙ†) ====
const btnUserAuth   = document.getElementById("btnUserAuth");
const authAdmModal  = document.getElementById("authAdminModal");
const authAdmUserEl = document.getElementById("authAdmUsername");
const authAdmMetaEl = document.getElementById("authAdmMeta");
const authAdmNewPass= document.getElementById("authAdmNewPass");
const authAdmClose  = document.getElementById("authAdmClose");
const authAdmSave   = document.getElementById("authAdmSave");

// Ú¯Ø±ÙØªÙ† uid Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ (Ù‡Ù…Ø§Ù† Ù…ØªØºÛŒØ± ÙØ¹Ù„ÛŒ loadUserProfile)
function getSelectedUid(){
  const active = document.querySelector(".user-item.active");
  return active ? active.dataset.uid : null;
}

btnUserAuth.onclick = async ()=>{
  const uid = getSelectedUid();
  if(!uid) return alert("Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");

  authAdmUserEl.textContent = uid;
  authAdmNewPass.value = "";
  authAdmMetaEl.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øªâ€¦";

  try{
    const r = await fetch(API + "/admin/authInfo?uid=" + encodeURIComponent(uid));
    const j = await r.json();
    if(j?.ok){
      const mk = ts => ts ? new Date(ts).toLocaleString("fa-IR") : "-";
      authAdmMetaEl.textContent = `ÙˆØ¶Ø¹ÛŒØª Ù¾Ø³ÙˆØ±Ø¯: ${j.user.hasPassword ? "Ø¯Ø§Ø±Ø¯" : "Ù†Ø¯Ø§Ø±Ø¯"} | Ø³Ø§Ø®Øª: ${mk(j.user.createdAt)} | Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±: ${mk(j.user.updatedAt)}`;
    }else{
      authAdmMetaEl.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª.";
    }
  }catch{
    authAdmMetaEl.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.";
  }

  authAdmModal.style.display = "flex";
  authAdmModal.setAttribute("aria-hidden","false");
};

authAdmClose.onclick = ()=>{
  authAdmModal.style.display = "none";
  authAdmModal.setAttribute("aria-hidden","true");
};

authAdmSave.onclick = async ()=>{
  const uid = getSelectedUid();
  const np = authAdmNewPass.value.trim();
  if(!uid) return alert("Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡.");
  if(!np)  return alert("Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");

  try{
    const r = await fetch(API + "/admin/setPassword", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ uid, new_password: np })
    });
    const j = await r.json();
    if(j?.ok){
      alert("Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯.");
      authAdmClose.click();
    }else{
      alert("Ø®Ø·Ø§: " + (j.error || "Ù†Ø§Ù…Ø´Ø®Øµ"));
    }
  }catch{
    alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø¯Ø± Ø«Ø¨Øª Ø±Ù…Ø².");
  }
};

  </script>
  <!-- Ù…ÙˆØ¯Ø§Ù„ Ù„Ø§Ú¯ÛŒÙ†â€ŒÙ‡Ø§ -->
<div class="modal" id="loginsModal" aria-hidden="true">
  <div class="modal-card">
    <h3>Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±</h3>
    <div id="loginsBody" class="mono" style="max-height:50vh;overflow:auto"></div>
    <div class="actions">
      <button class="link" id="loginsClose">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ù†ÙˆØª Ø®ØµÙˆØµÛŒ -->
<div class="modal" id="notesModal" aria-hidden="true">
  <div class="modal-card">
    <h3>Ù†ÙˆØª Ø®ØµÙˆØµÛŒ Ø§Ø¯Ù…ÛŒÙ†</h3>
    <textarea id="notesText" rows="6" style="width:100%"></textarea>
    <div class="actions">
      <button class="link ghost" id="notesCancel">Ù„ØºÙˆ</button>
      <button class="link" id="notesSave">Ø°Ø®ÛŒØ±Ù‡</button>
    </div>
  </div>
</div>
<!-- Modal: Chat Details -->
<div id="chatModal" style="display:none; position:fixed; inset:0; z-index:9999; align-items:center; justify-content:center; background:rgba(0,0,0,.35)">
  <div id="chatModalBox" style="width:min(900px, 96vw); max-height:90vh; overflow:auto; background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.25);">
    <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #e5e7eb">
      <b id="chatModalTitle">Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯ÙØªÚ¯Ùˆ</b>
      <button id="chatModalClose" class="btn ghost">Ø¨Ø³ØªÙ†</button>
    </div>
    <div id="chatModalBody" style="padding:16px"></div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.1.1/dist/jalaali.min.js"></script>
<script>
(function(){
  // Ø¹Ù†Ø§ØµØ± UI (Ø§Ø² Ù‚Ø¨Ù„ Ø¯Ø± HTML Ø³Ø§Ø®ØªÙ‡â€ŒØ§ÛŒÙ…)
  const jModal   = document.getElementById("jalaliRangeModal");
  const jTitle   = document.getElementById("jTitle");
  const jGrid    = document.getElementById("jGrid");
  const jPrev    = document.getElementById("jPrev");
  const jNext    = document.getElementById("jNext");
  const jCancel  = document.getElementById("jCancel");
  const jOk      = document.getElementById("jOk");
  const btnPick  = document.getElementById("btnPickRange");
  const rangeLbl = document.getElementById("rangeLabel");

  // Ú©Ù…Ú©ÛŒâ€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ® (Ø¨Ø¯ÙˆÙ† ØªØ¯Ø§Ø®Ù„ Ø¨Ø§ Ø¨Ù‚ÛŒÙ‡)
  function toGregorianTs(jy,jm,jd){
    const g = jalaali.toGregorian(jy,jm,jd);
    return new Date(g.gy, g.gm-1, g.gd).getTime();
  }
  function fromDateToJalali(d){
    const j = jalaali.toJalaali(d.getFullYear(), d.getMonth()+1, d.getDate());
    return {jy:j.jy, jm:j.jm, jd:j.jd};
  }
  const pad = n => (n<10?"0":"")+n;

  // ÙˆØ¶Ø¹ÛŒØª Ø§Ù†ØªØ®Ø§Ø¨
  let base = fromDateToJalali(new Date()); // Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒÙ Ø¯Ø³ØªÚ¯Ø§Ù‡
  let selA = null, selB = null;

  function openModal(){ jModal.classList.add("show"); jModal.setAttribute("aria-hidden","false"); }
  function closeModal(){ jModal.classList.remove("show"); jModal.setAttribute("aria-hidden","true"); }

  function renderMonth(jy, jm){
    jTitle.textContent = `${jy}/${pad(jm)}`;
    jGrid.innerHTML = "";

    // Ø±ÙˆØ² Ø§ÙˆÙ„ Ù…Ø§Ù‡
    const g1 = jalaali.toGregorian(jy,jm,1);
    const d1 = new Date(g1.gy, g1.gm-1, g1.gd);
    const wd = (d1.getDay() + 6) % 7; // Ø´Ù†Ø¨Ù‡=0 â€¦ Ø¬Ù…Ø¹Ù‡=6
    const days = jalaali.jalaaliMonthLength(jy, jm);

    // Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Û±Ù…
    for (let i=0;i<wd;i++){
      const c = document.createElement("div");
      c.className = "j-cell dim"; c.textContent = "";
      jGrid.appendChild(c);
    }
    // Ø±ÙˆØ²Ù‡Ø§
    for (let d=1; d<=days; d++){
      const c = document.createElement("div");
      c.className = "j-cell"; c.textContent = d;
      const ts = toGregorianTs(jy,jm,d);
      const inRange = (selA && selB) && (ts>=Math.min(selA,selB) && ts<=Math.max(selA,selB));
      const isEdge  = (selA && ts===selA) || (selB && ts===selB);
      if (inRange) c.classList.add("h");
      if (isEdge)  c.classList.add("sel");
      c.onclick = ()=>{
        if (!selA || (selA && selB)){ selA = ts; selB = null; }
        else { selB = ts; }
        renderMonth(base.jy, base.jm);
      };
      jGrid.appendChild(c);
    }
  }

  // Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù…Ø§Ù‡
  jPrev && (jPrev.onclick = ()=>{
    let {jy,jm} = base; jm--; if (jm<1){ jm=12; jy--; }
    base = {jy,jm, jd:1}; renderMonth(jy,jm);
  });
  jNext && (jNext.onclick = ()=>{
    let {jy,jm} = base; jm++; if (jm>12){ jm=1; jy++; }
    base = {jy,jm, jd:1}; renderMonth(jy,jm);
  });

  jCancel && (jCancel.onclick = ()=> closeModal());
  jOk && (jOk.onclick = async ()=>{
    if (!selA || !selB){ alert("Ø§Ø¨ØªØ¯Ø§ Ø¯Ùˆ ØªØ§Ø±ÛŒØ® (Ø§Ø²/ØªØ§) Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }
    const a = Math.min(selA, selB);
    const b = Math.max(selA, selB) + (24*60*60*1000 - 1); // ØªØ§ Ø§Ù†ØªÙ‡Ø§ÛŒ Ø±ÙˆØ² Ø¯ÙˆÙ…
    const aj = fromDateToJalali(new Date(a));
    const bj = fromDateToJalali(new Date(b));
    rangeLbl && (rangeLbl.textContent = `Ø§Ø² ${aj.jy}/${pad(aj.jm)}/${pad(aj.jd)} ØªØ§ ${bj.jy}/${pad(bj.jm)}/${pad(bj.jd)}`);
    closeModal();
    try{ await loadRangeStats(a,b); }catch{}
  });

  // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ØªÙ‚ÙˆÛŒÙ…
  btnPick && (btnPick.onclick = ()=>{
    base = fromDateToJalali(new Date());
    selA = selB = null;
    renderMonth(base.jy, base.jm);
    openModal();
  });

  // Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÛŒ Ø¢Ù…Ø§Ø± Ø¨Ø§Ø²Ù‡ Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÛŒ /admin/export (Ø³Ù…Øª Ú©Ù„Ø§ÛŒÙ†Øª)
  async function loadRangeStats(tsFrom, tsTo){
    const elChats = document.getElementById("rChats");
    const elMsgs  = document.getElementById("rMsgs");
    const elNew   = document.getElementById("rNewUsers");
    const elAct   = document.getElementById("rActive");
    if (elChats) elChats.textContent = "â€¦";
    if (elMsgs)  elMsgs.textContent  = "â€¦";
    if (elNew)   elNew.textContent   = "â€¦";
    if (elAct)   elAct.textContent   = "â€¦";

    let raw;
    try{
      const r = await fetch(API + "/admin/export");
      raw = await r.json();
    }catch{
      alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡Ù” Ø®Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø± Ø¨Ø§Ø²Ù‡.");
      ["rChats","rMsgs","rNewUsers","rActive"].forEach(id=>{
        const el = document.getElementById(id); if (el) el.textContent = "â€”";
      });
      return;
    }

    const users = Array.isArray(raw?.users)    ? raw.users    : (Array.isArray(raw?.allUsers)    ? raw.allUsers    : []);
    const chats = Array.isArray(raw?.chats)    ? raw.chats    : (Array.isArray(raw?.allChats)    ? raw.allChats    : []);
    const msgs  = Array.isArray(raw?.messages) ? raw.messages : (Array.isArray(raw?.allMessages) ? raw.allMessages : []);

    const inRange = v => { const t = Number(v||0); return !isNaN(t) && t>=tsFrom && t<=tsTo; };

    const cntChats = chats.filter(c => inRange(c.createdAt || c.updatedAt || c.ts)).length;
    const cntMsgs  = msgs.filter(m  => inRange(m.ts || m.createdAt)).length;
    const cntNew   = users.filter(u => inRange(u.createdAt || u.joinedAt || u.firstSeen || u.firstChat)).length;

    const activeByUser = new Set();
    const userOf = x => (x?.username || x?.uid || x?.userId || x?.owner || x?.by || "").toString();
    users.forEach(u => { const last = Number(u.lastSeen || 0); if (inRange(last)) activeByUser.add(u.uid || u.username || u.id); });
    chats.forEach(c => { if (inRange(c.updatedAt || c.createdAt)) activeByUser.add(userOf(c)); });
    msgs.forEach(m  => { if (inRange(m.ts || m.createdAt)) activeByUser.add(userOf(m)); });

    if (elChats) elChats.textContent = String(cntChats);
    if (elMsgs)  elMsgs.textContent  = String(cntMsgs);
    if (elNew)   elNew.textContent   = String(cntNew);
    if (elAct)   elAct.textContent   = String(activeByUser.size);
  }
})();
</script>

</body>
</html>
