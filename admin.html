<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø§Ø¯Ù…ÛŒÙ† Ú†Øªâ€ŒØ¨Ø§Øª</title>
  <style>
    @font-face{
      font-family: "IRANYekanX";
      src: url("./IRANYekanX-Light.woff2") format("woff2");
      font-weight: 300; font-style: normal; font-display: swap;
    }
    :root{
      --bg:#f8f9fb; --card:#fff; --ink:#111; --muted:#6b7280; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.06);
      --accent:#0f172a; --accent-ink:#fff; --bd:#e5e7eb; --chip:#0f172a; --chip-ink:#fff;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);font-family:IRANYekanX, Tahoma, Arial, sans-serif;color:var(--ink)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 14px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .tabs{display:flex;gap:8px;align-items:center}
    .tab{border:1px solid var(--bd);padding:10px 14px;border-radius:12px;cursor:pointer;background:#fff}
    .tab.active{background:var(--accent);color:var(--accent-ink);border-color:transparent}
    .grid{display:grid;gap:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:4px 10px;border-radius:999px;background:#eef2ff}
    .muted{color:var(--muted)}
    input,select,button,textarea{border:1px solid var(--bd);border-radius:10px;padding:8px;font-family:IRANYekanX}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
    .ghost{background:#eef2f7;color:#111}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:right;padding:10px;background:#fff;border:1px solid var(--bd)}
    th{background:#f1f5f9}
    tr td:first-child, tr th:first-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    tr td:last-child, tr th:last-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    .section-title{margin:0 0 8px 0}
    .mono{font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px}
    .hr{height:1px;background:#e5e7eb;margin:12px 0}
    .flex{display:flex;gap:8px;align-items:center}
    .right{justify-content:flex-end}
    .tag{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--chip-ink);padding:4px 10px;border-radius:999px;font-size:12px}
    .good{background:#dcfce7;border:1px solid #86efac}
    .bad{background:#fee2e2;border:1px solid #fecaca}
    .code{white-space:pre-wrap; background:#0f172a;color:#e5e7eb;border-radius:10px;padding:10px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <h2 style="margin:0">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
    <div class="tabs">
      <button class="tab active" id="tabChats">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</button>
      <button class="tab" id="tabAnalytics">Ø¢Ù†Ø§Ù„ÛŒØ²</button>
    </div>
  </div>

  <div class="card" id="viewChats">
    <div class="row">
      <select id="userList"></select>
      <button class="btn" id="refreshUsers">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      <span class="pill" id="userInfo">-</span>
    </div>
    <div class="hr"></div>

    <h3 class="section-title">Ù„ÛŒØ³Øª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</h3>
    <div class="row">
      <input id="searchChat" placeholder="Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù†/Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„â€¦" style="min-width:280px">
      <button class="btn ghost" id="refreshChats">Ù†ÙˆØ³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª</button>
      <button class="btn" id="exportUser">Ø§Ú©Ø³Ù¾ÙˆØ±Øª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±</button>
    </div>
    <div id="chatsTableWrap" style="margin-top:10px;overflow:auto"></div>

    <div class="hr"></div>
    <h3 class="section-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯ÙØªÚ¯Ùˆ</h3>
    <div id="chatDetail"></div>
  </div>

  <div class="card" id="viewAnalytics" style="display:none">
    <h3 class="section-title">Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ</h3>
    <div class="row">
      <div class="tag">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯Ø´Ø¯Ù‡: <b id="statChats" style="margin-inline-start:6px">-</b></div>
      <div class="tag">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: <b id="statMsgs" style="margin-inline-start:6px">-</b></div>
      <div class="tag">Ú©Ù„ÛŒÚ© Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§: <b id="statClicks" style="margin-inline-start:6px">-</b></div>
      <div class="tag">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÛŒÚ©ØªØ§ (Ø¨Ø± Ø§Ø³Ø§Ø³ IP): <b id="statUsers" style="margin-inline-start:6px">-</b></div>
    </div>

    <div class="hr"></div>
    <div class="row right">
      <button class="btn ghost" id="refreshStats">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      <button class="btn" id="resetAll">Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø¢Ù…Ø§Ø± Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
      <button class="btn" id="exportAll">Ø§Ú©Ø³Ù¾ÙˆØ±Øª Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ² (JSON)</button>
    </div>

    <h3 class="section-title" style="margin-top:16px">Ø®Ø±ÙˆØ¬ÛŒ</h3>
    <div id="exportBox" class="code mono"></div>
  </div>
</div>

<script>
const API = location.origin + "/api";
const $  = (id)=>document.getElementById(id);

// Tabs
const tabChats = $("tabChats");
const tabAnalytics = $("tabAnalytics");
const viewChats = $("viewChats");
const viewAnalytics = $("viewAnalytics");
tabChats.onclick = ()=>{ tabChats.classList.add("active"); tabAnalytics.classList.remove("active"); viewChats.style.display="block"; viewAnalytics.style.display="none"; };
tabAnalytics.onclick = ()=>{ tabAnalytics.classList.add("active"); tabChats.classList.remove("active"); viewChats.style.display="none"; viewAnalytics.style.display="block"; };

// UI nodes
const userList = $("userList");
const refreshUsers = $("refreshUsers");
const userInfo = $("userInfo");
const searchChat = $("searchChat");
const refreshChats = $("refreshChats");
const exportUser = $("exportUser");
const chatsTableWrap = $("chatsTableWrap");
const chatDetail = $("chatDetail");

// Analytics nodes
const statChats = $("statChats");
const statMsgs = $("statMsgs");
const statClicks = $("statClicks");
const statUsers = $("statUsers");
const refreshStats = $("refreshStats");
const resetAll = $("resetAll");
const exportAll = $("exportAll");
const exportBox = $("exportBox");

// Helpers
async function jget(path){ const r=await fetch(API+path); return r.json(); }
async function jpost(path, data){ const r=await fetch(API+path,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data||{})}); return r.json(); }
function fmt(ts){ try{ return new Date(ts).toLocaleString("fa-IR") }catch{return "-"} }
function escapeHtml(s=""){ return (s||"").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

// Load users
async function loadUsers(){
  const data = await jget("/admin/users");
  userList.innerHTML = "";
  (data.users||[]).forEach(u=>{
    const opt=document.createElement("option");
    opt.value=u.uid;
    opt.textContent=`${u.uid} â€” ${u.chats} Ú†Øª â€” Ø¢Ø®Ø±ÛŒÙ†â€ŒØ¨Ø§Ø±: ${fmt(u.lastSeen)}`;
    userList.appendChild(opt);
  });
  userInfo.textContent = (data.users?.length||0)+" Ú©Ø§Ø±Ø¨Ø±";
  if (data.users?.length) loadChatsFor(userList.value);
}
refreshUsers.onclick = loadUsers;
userList.onchange = ()=> loadChatsFor(userList.value);

// Chats table
let currentChats = [];
async function loadChatsFor(uid){
  const data = await jget("/admin/chats?uid="+encodeURIComponent(uid));
  currentChats = data.chats||[];
  renderChatsTable(currentChats);
}
function renderChatsTable(list){
  const q=(searchChat.value||"").trim().toLowerCase();
  const filtered = list.filter(c=>{
    const hay = (c.title+" "+(c.preview||"")).toLowerCase();
    return !q || hay.includes(q);
  });
  const rows = filtered.map(c=>`
    <tr>
      <td class="mono">${escapeHtml(c.chatId)}</td>
      <td>${escapeHtml(c.title||"-")}</td>
      <td class="muted">${escapeHtml(c.preview||"")}</td>
      <td class="mono">${fmt(c.updatedAt||c.createdAt)}</td>
      <td>
        <button class="btn ghost" data-view="${c.chatId}">Ù†Ù…Ø§ÛŒØ´</button>
        <button class="btn" data-del="${c.chatId}">Ø­Ø°Ù</button>
      </td>
    </tr>
  `).join("");
  chatsTableWrap.innerHTML = `
    <table>
      <thead><tr><th>Ø´Ù†Ø§Ø³Ù‡</th><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§ÙˆÙ„ÛŒÙ† Ù¾ÛŒØ§Ù…</th><th>Ø¢Ø®Ø±ÛŒÙ†â€ŒØ¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th><th>Ø§Ú©Ø´Ù†</th></tr></thead>
      <tbody>${rows || ""}</tbody>
    </table>`;
  chatsTableWrap.querySelectorAll("[data-view]").forEach(b=> b.onclick=()=> showChat(b.dataset.view));
  chatsTableWrap.querySelectorAll("[data-del]").forEach(b=> b.onclick=()=> delChat(b.dataset.del));
}
searchChat.oninput = ()=> renderChatsTable(currentChats);

async function showChat(chatId){
  const data = await jget("/admin/chat?chatId="+encodeURIComponent(chatId));
  const chat = data.chat || {};
  const ratings = data.ratings || {};
  const msgs = (chat.messages||[]).map(m=>{
    const tag = m.role==="assistant" ? "bot" : "user";
    const rt = ratings[m.id]=== "up" ? '<span class="tag good">ğŸ‘</span>' :
             ratings[m.id]=== "down" ? '<span class="tag bad">ğŸ‘</span>' : '';
    return `
      <div class="row" style="align-items:flex-start">
        <div class="tag">${tag}</div>
        ${rt}
        <div class="muted mono">${fmt(m.ts)}</div>
      </div>
      <div style="margin:6px 0 12px 0; background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px">
        <div style="white-space:pre-wrap">${escapeHtml(m.content||"")}</div>
        ${m.model?`<div class="muted mono" style="margin-top:6px">model: ${escapeHtml(m.model||"")}</div>`:""}
        ${m.web?`<div class="muted mono">web: on</div>`:""}
      </div>
    `;
  }).join("");
  chatDetail.innerHTML = `
    <div class="row">
      <div class="tag">Ú©Ø§Ø±Ø¨Ø±: <b class="mono" style="margin-inline-start:6px">${escapeHtml(chat.uid||"-")}</b></div>
      <div class="tag">Ø§ÛŒØ¬Ø§Ø¯: <b class="mono" style="margin-inline-start:6px">${fmt(chat.createdAt)}</b></div>
      <div class="tag">Ø¢Ø®Ø±ÛŒÙ†: <b class="mono" style="margin-inline-start:6px">${fmt(chat.updatedAt)}</b></div>
      <button class="btn" id="delThis">Ø­Ø°Ù Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ</button>
    </div>
    <div class="hr"></div>
    ${msgs || "<div class='muted'>â€” Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ â€”</div>"}
  `;
  $("delThis").onclick = ()=> delChat(chatId,true);
}
async function delChat(chatId, refreshDetail=false){
  if (!confirm("Ø­Ø°Ù Ø§ÛŒÙ† Ú¯ÙØªâ€ŒÙˆÚ¯ÙˆØŸ")) return;
  await jpost("/admin/deleteChat",{ chatId });
  await loadChatsFor(userList.value);
  if (refreshDetail) chatDetail.innerHTML="";
}

// Export per user
exportUser.onclick = async()=>{
  const uid=userList.value;
  const data = await jget("/admin/export?uid="+encodeURIComponent(uid));
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=`export_${uid}.json`; a.click();
  URL.revokeObjectURL(url);
};

// Analytics
async function loadStats(){
  const s = await jget("/admin/summary");
  statChats.textContent = s.chats||0;
  statMsgs.textContent = s.messages||0;
  statClicks.textContent = s.clicks||0;
  statUsers.textContent = s.users||0;
}
refreshStats.onclick = loadStats;

resetAll.onclick = async()=>{
  if (!confirm("Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ² Ø±ÛŒØ³Øª Ø´ÙˆØ¯ØŸ (ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª)")) return;
  const r = await jpost("/admin/reset",{ confirm:true });
  alert(r?.ok?"Ø±ÛŒØ³Øª Ø´Ø¯":"Ø®Ø·Ø§");
  await loadUsers(); await loadStats();
  chatsTableWrap.innerHTML=""; chatDetail.innerHTML="";
};

exportAll.onclick = async()=>{
  const data = await jget("/admin/export");
  exportBox.textContent = JSON.stringify(data,null,2);
};

// Boot
loadUsers();
loadStats();
</script>
</body>
</html>
