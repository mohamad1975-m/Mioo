<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø§Ø¯Ù…ÛŒÙ† Ú†Øªâ€ŒØ¨Ø§Øª</title>
  <style>
    @font-face{
      font-family: "IRANYekanX";
      src: url("./IRANYekanX-Light.woff2") format("woff2");
      font-weight: 300; font-style: normal; font-display: swap;
    }
    :root{
      --bg:#f8f9fb; --card:#fff; --ink:#111; --muted:#6b7280; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.06);
      --accent:#0f172a; --accent-ink:#fff; --bd:#e5e7eb; --chip:#0f172a; --chip-ink:#fff;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);font-family:IRANYekanX, Tahoma, Arial, sans-serif;color:var(--ink)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 14px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .tabs{display:flex;gap:8px;align-items:center}
    .tab{border:1px solid var(--bd);padding:10px 14px;border-radius:12px;cursor:pointer;background:#fff}
    .tab.active{background:var(--accent);color:var(--accent-ink);border-color:transparent}
    .grid{display:grid;gap:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:4px 10px;border-radius:999px;background:#eef2ff}
    .muted{color:var(--muted)}
    input,select,button,textarea{border:1px solid var(--bd);border-radius:10px;padding:8px;font-family:IRANYekanX}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
    .ghost{background:#eef2f7;color:#111}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:right;padding:10px;background:#fff;border:1px solid var(--bd)}
    th{background:#f1f5f9}
    tr td:first-child, tr th:first-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    tr td:last-child, tr th:last-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    .section-title{margin:0 0 8px 0}
    .mono{font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px}
    .hr{height:1px;background:#e5e7eb;margin:12px 0}
    .flex{display:flex;gap:8px;align-items:center}
    .right{justify-content:flex-end}
    .tag{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--chip-ink);padding:4px 10px;border-radius:999px;font-size:12px}
    .good{background:#dcfce7;border:1px solid #86efac}
    .bad{background:#fee2e2;border:1px solid #fecaca}
    .code{white-space:pre-wrap; background:#0f172a;color:#e5e7eb;border-radius:10px;padding:10px}
  </style>
  <style>
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .link { background:#0f172a; color:#fff; border:0; border-radius:10px; padding:8px 12px; cursor:pointer; font-family:IRANYekanX }
    .ghost{ background:#eef2f7; color:#111 }
    .panel { margin-top:14px; background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:12px }
    .list { max-height:70vh; overflow:auto; display:flex; flex-direction:column; gap:8px }
    .item { border:1px solid #e5e7eb; border-radius:12px; padding:10px; display:flex; justify-content:space-between; align-items:center; gap:10px }
    .meta { color:#64748b; font-size:12px }
    .star { color:#f59e0b; margin-inline-start:6px }
    .badge{ font-size:12px; background:#eef2ff; border-radius:999px; padding:2px 8px; color:#475569 }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .hidden{ display:none }
    .snack{ position:fixed; inset-inline:0; bottom:12px; display:none; justify-content:center; z-index:1000 }
    .snack-inner{ background:#111; color:#fff; padding:10px 14px; border-radius:12px; display:flex; gap:12px; align-items:center }
    .snack button{ background:#fff; color:#111; border:0; border-radius:8px; padding:6px 10px; cursor:pointer; font-family:IRANYekanX }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:1200 }
    .modal.show{ display:flex }
    .modal-card{ background:#fff; border-radius:16px; width:min(600px,96vw); padding:16px }
    .modal-card h3{ margin:0 0 10px 0; font-size:18px }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
    .search { display:flex; gap:8px; align-items:center; margin:10px 0 }
    .search input { flex:1; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; }
  </style>
  
</head>
<body>
<div class="wrap">
  <div class="head">
    <h2 style="margin:0">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
    <div class="tabs">
      
      <button class="tab active" id="tabChats">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</button>
      <button class="tab" id="tabAnalytics">Ø¢Ù†Ø§Ù„ÛŒØ²</button>
      <button class="btn ghost" id="btnAll">Ù…Ø´Ø§Ù‡Ø¯Ù‡Ù” Ù‡Ù…Ù‡Ù” Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</button>
      <button class="btn ghost" id="btnLive">ØµÙØ­Ù‡Ù” Ø²Ù†Ø¯Ù‡</button>

    </div>
  </div>
  

  <div class="card" id="viewChats">
    <div class="row">
      <select id="userList"></select>
      <button class="btn" id="refreshUsers">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      <span class="pill" id="userInfo">-</span>
    </div>
    <div class="hr"></div>
<!-- Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± -->
<div id="profileBox" class="panel" style="margin-top:8px; display:none">
  <div class="row" style="justify-content:space-between">
    <div>
      <div><b>Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±</b></div>
      <div class="muted" id="profMeta">â€”</div>
    </div>
    <div class="row">
      <button class="link ghost" id="btnLogins">ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙˆØ±ÙˆØ¯</button>
      <button class="link ghost" id="btnNotes" title="Ù†ÙˆØª Ø®ØµÙˆØµÛŒ (Ø¢ÛŒÚ©ÙˆÙ† Ù†ÙˆØª Ù¾Ø¯)">ğŸ—’ï¸ Ù†ÙˆØª</button>
      <button class="link" id="btnBan">Ø¨Ù† Ú©Ø±Ø¯Ù†</button>
    </div>
  </div>
</div>

    <h3 class="section-title">Ù„ÛŒØ³Øª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</h3>
    <div class="row">
      <input id="searchChat" placeholder="Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù†/Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„â€¦" style="min-width:280px">
      <button class="btn ghost" id="refreshChats">Ù†ÙˆØ³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª</button>
      <button class="btn" id="exportUser">Ø§Ú©Ø³Ù¾ÙˆØ±Øª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±</button>
    </div>
    <div id="chatsTableWrap" style="margin-top:10px;overflow:auto"></div>

    <div class="hr"></div>
    <h3 class="section-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯ÙØªÚ¯Ùˆ</h3>
    <div id="chatDetail"></div>
  </div>

  <div class="card" id="viewAnalytics" style="display:none">
    <h3 class="section-title">Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ</h3>
    <div class="row">
      <div class="tag">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯Ø´Ø¯Ù‡: <b id="statChats" style="margin-inline-start:6px">-</b></div>
      <div class="tag">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§: <b id="statMsgs" style="margin-inline-start:6px">-</b></div>
      <div class="tag">Ú©Ù„ÛŒÚ© Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§: <b id="statClicks" style="margin-inline-start:6px">-</b></div>
      <div class="tag">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÛŒÚ©ØªØ§ (Ø¨Ø± Ø§Ø³Ø§Ø³ IP): <b id="statUsers" style="margin-inline-start:6px">-</b></div>
      <div class="hr"></div>
<div class="row">
  <div class="tag">Û³Û°â€ŒØ±ÙˆØ² Ø§Ø®ÛŒØ± - Ú¯ÙØªÚ¯Ùˆ: <b id="last30Chats">-</b></div>
  <div class="tag">Û³Û°â€ŒØ±ÙˆØ² Ø§Ø®ÛŒØ± - Ù¾ÛŒØ§Ù…: <b id="last30Msgs">-</b></div>
  <div class="tag">Ø§Ù…Ø±ÙˆØ² - Ú¯ÙØªÚ¯Ùˆ: <b id="todayChats">-</b></div>
  <div class="tag">Ø§Ù…Ø±ÙˆØ² - Ù¾ÛŒØ§Ù…: <b id="todayMsgs">-</b></div>
  <div class="tag">Ø§Ù…Ø±ÙˆØ² - Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: <b id="todayUsers">-</b></div>
</div>

<h3 class="section-title" style="margin-top:12px">ØªÙˆØ²ÛŒØ¹ Ù‡ÙØªÚ¯ÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ (Ø´Ù†Ø¨Ù‡â†’Ø¬Ù…Ø¹Ù‡)</h3>
<canvas id="weekChart" width="900" height="240" style="max-width:100%"></canvas>

<h3 class="section-title" style="margin-top:12px">Ø§Ø³ØªÙØ§Ø¯Ù‡Ù” Ù…Ø¯Ù„â€ŒÙ‡Ø§</h3>
<div id="modelsBox" class="mono" style="white-space:pre-wrap"></div>

    </div>

    <div class="hr"></div>
    <div class="row right">
      <button class="btn ghost" id="refreshStats">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      <button class="btn" id="resetAll">Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø¢Ù…Ø§Ø± Ùˆ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
      <button class="btn" id="exportAll">Ø§Ú©Ø³Ù¾ÙˆØ±Øª Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ² (JSON)</button>
    </div>

    <h3 class="section-title" style="margin-top:16px">Ø®Ø±ÙˆØ¬ÛŒ</h3>
    <div id="exportBox" class="code mono"></div>
  </div>
</div>

<script>
const API = "https://mioo-chat.mohamadgpt19.workers.dev/api";
const $  = (id)=>document.getElementById(id);

// Tabs

const tabChats = $("tabChats");
const tabAnalytics = $("tabAnalytics");
const viewChats = $("viewChats");
const viewAnalytics = $("viewAnalytics");
tabChats.onclick = ()=>{ tabChats.classList.add("active"); tabAnalytics.classList.remove("active"); viewChats.style.display="block"; viewAnalytics.style.display="none"; };
tabAnalytics.onclick = ()=>{ tabAnalytics.classList.add("active"); tabChats.classList.remove("active"); viewChats.style.display="none"; viewAnalytics.style.display="block"; };
// Ø§Ø¶Ø§ÙÙ‡: ÛŒÚ© Ù‡ÙÙ„Ù¾Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ† Ù¾Ù†Ù„ Ù‡Ù…Ù‡â€ŒÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§
function hideAllPanel(){
  const p = document.getElementById("allPanel");
  if (!p) return;
  p.style.display = "none";
  p.innerHTML = "";
}

// Ù‚Ø¨Ù„ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ Ø§ÛŒÙ† Ø´Ú©Ù„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†ÛŒØ¯:
tabChats.onclick = ()=>{
  tabChats.classList.add("active");
  tabAnalytics.classList.remove("active");
  viewChats.style.display="block";
  viewAnalytics.style.display="none";
  hideAllPanel();         // â† Ù…Ù‡Ù…
};
tabAnalytics.onclick = ()=>{
  tabAnalytics.classList.add("active");
  tabChats.classList.remove("active");
  viewAnalytics.style.display="block";
  viewChats.style.display="none";
  hideAllPanel();         // â† Ù…Ù‡Ù…
};

// UI nodes
const userList = $("userList");
const refreshUsers = $("refreshUsers");
const userInfo = $("userInfo");
const searchChat = $("searchChat");
const refreshChats = $("refreshChats");
const exportUser = $("exportUser");
const chatsTableWrap = $("chatsTableWrap");
const chatDetail = $("chatDetail");

// --- Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±
const profileBox = document.getElementById("profileBox");
const profMeta   = document.getElementById("profMeta");
const btnLogins  = document.getElementById("btnLogins");
const btnNotes   = document.getElementById("btnNotes");
const btnBan     = document.getElementById("btnBan");


// Analytics nodes
const statChats = $("statChats");
const statMsgs = $("statMsgs");
const statClicks = $("statClicks");
const statUsers = $("statUsers");
const refreshStats = $("refreshStats");
const resetAll = $("resetAll");
const exportAll = $("exportAll");
const exportBox = $("exportBox");

// Helpers
async function jget(path){ const r=await fetch(API+path); return r.json(); }
async function jpost(path, data){ const r=await fetch(API+path,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data||{})}); return r.json(); }
function fmt(ts){ try{ return new Date(ts).toLocaleString("fa-IR") }catch{return "-"} }
function escapeHtml(s=""){ return (s||"").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

// Load users
async function loadUsers(){
  const data = await jget("/admin/users");
  userList.innerHTML = "";
  (data.users||[]).forEach(u=>{
    const opt=document.createElement("option");
    opt.value=u.uid;
    opt.textContent=`${u.uid} â€” ${u.chats} Ú†Øª â€” Ø¢Ø®Ø±ÛŒÙ†â€ŒØ¨Ø§Ø±: ${fmt(u.lastSeen)}`;
    userList.appendChild(opt);
  });
  userInfo.textContent = (data.users?.length||0)+" Ú©Ø§Ø±Ø¨Ø±";
  if (data.users?.length) loadChatsFor(userList.value);
  if (data.users?.length) loadUserProfile(userList.value);

}

async function loadUserProfile(uid){
  profileBox.style.display = "none";
    // Ú¯Ø±ÙØªÙ† Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ (ÙˆÙ‚ØªÛŒ DOM Ù‚Ø·Ø¹Ø§Ù‹ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª)
    const loginsModal = document.getElementById("loginsModal");
  const loginsBody  = document.getElementById("loginsBody");
  const loginsClose = document.getElementById("loginsClose");
  const notesModal  = document.getElementById("notesModal");
  const notesText   = document.getElementById("notesText");
  const notesCancel = document.getElementById("notesCancel");
  const notesSave   = document.getElementById("notesSave");

  try{
    const r = await fetch(API + "/admin/userProfile?uid=" + encodeURIComponent(uid));
    const j = await r.json();
    const fmtDT = (ts)=> ts? new Date(ts).toLocaleString("fa-IR"): "-";
    profMeta.textContent =
      `Ø¯Ø³ØªÚ¯Ø§Ù‡: ${j.device||"-"} | Ø§ÙˆÙ„ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ: ${fmtDT(j.firstChat)} | Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯: ${fmtDT(j.lastLogin)} | ÙˆØ¶Ø¹ÛŒØª: ${j.banned?"Ø¨Ù†â€ŒØ´Ø¯Ù‡":"Ø¹Ø§Ø¯ÛŒ"}`;
    profileBox.style.display = "block";

    // Ø¯Ú©Ù…Ù‡ Ù„Ø§Ú¯ÛŒÙ†â€ŒÙ‡Ø§
    btnLogins.onclick = ()=>{
      loginsBody.innerHTML = (j.logins||[]).map(ts=>`- ${fmtDT(ts)}`).join("<br>") || "â€” Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ â€”";
      loginsModal.classList.add("show"); loginsModal.setAttribute("aria-hidden","false");
    };
    loginsClose.onclick = ()=>{ loginsModal.classList.remove("show"); loginsModal.setAttribute("aria-hidden","true"); };

    // Ù†ÙˆØª
    btnNotes.onclick = ()=>{
      notesText.value = j.notes||"";
      notesModal.classList.add("show"); notesModal.setAttribute("aria-hidden","false");
    };
    notesCancel.onclick = ()=>{ notesModal.classList.remove("show"); notesModal.setAttribute("aria-hidden","true"); };
    notesSave.onclick = async ()=>{
      await fetch(API + "/admin/notes", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ uid, notes: notesText.value||"" })
      });
      notesModal.classList.remove("show"); notesModal.setAttribute("aria-hidden","true");
      alert("Ù†ÙˆØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
    };

    // Ø¨Ù†/Ø¢Ù†Ø¨Ù†
    btnBan.textContent = j.banned ? "Ø¢Ù†Ø¨Ù† Ú©Ø±Ø¯Ù†" : "Ø¨Ù† Ú©Ø±Ø¯Ù†";
    btnBan.onclick = async ()=>{
      const on = !j.banned;
      const rr = await fetch(API + "/admin/ban", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ uid, on })
      });
      const ok = (await rr.json())?.ok;
      if (ok){ loadUserProfile(uid); } else alert("Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù†");
    };

  }catch{}
}

refreshUsers.onclick = loadUsers;
userList.onchange = ()=>{
  loadChatsFor(userList.value);
  loadUserProfile(userList.value);
};


// Chats table
let currentChats = [];
async function loadChatsFor(uid){
  const data = await jget("/admin/chats?uid="+encodeURIComponent(uid));
  currentChats = data.chats||[];
  renderChatsTable(currentChats);
}
function renderChatsTable(list){
  const q=(searchChat.value||"").trim().toLowerCase();
  const filtered = list.filter(c=>{
    const hay = (c.title+" "+(c.preview||"")+" "+(c.chatId||"")).toLowerCase();
    return !q || hay.includes(q);
  });
  const rows = filtered.map(c=>`
    <tr>
      <td class="mono">${escapeHtml(c.chatId)}</td>
      <td>${escapeHtml(c.title||"-")}</td>
      <td class="muted">${escapeHtml(c.preview||"")}</td>
      <td class="mono">${fmt(c.updatedAt||c.createdAt)}</td>
      <td>
        <button class="btn ghost" data-view="${c.chatId}">Ù†Ù…Ø§ÛŒØ´</button>
        <button class="btn" data-del="${c.chatId}">Ø­Ø°Ù</button>
      </td>
    </tr>
  `).join("");
  chatsTableWrap.innerHTML = `
    <table>
      <thead><tr><th>Ø´Ù†Ø§Ø³Ù‡</th><th>Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§ÙˆÙ„ÛŒÙ† Ù¾ÛŒØ§Ù…</th><th>Ø¢Ø®Ø±ÛŒÙ†â€ŒØ¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</th><th>Ø§Ú©Ø´Ù†</th></tr></thead>
      <tbody>${rows || ""}</tbody>
    </table>`;
  chatsTableWrap.querySelectorAll("[data-view]").forEach(b=> b.onclick=()=> showChat(b.dataset.view));
  chatsTableWrap.querySelectorAll("[data-del]").forEach(b=> b.onclick=()=> delChat(b.dataset.del));
}
searchChat.oninput = ()=> renderChatsTable(currentChats);

async function showChat(chatId){
  const data = await jget("/admin/chat?chatId="+encodeURIComponent(chatId));
  const chat = data.chat || {};
  const ratings = data.ratings || {};
  const msgs = (chat.messages||[]).map(m=>{
    const tag = m.role==="assistant" ? "bot" : "user";
    // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¬ÙˆØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÛŒØ§Ø± Ø±Ø£ÛŒ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
    let rateBadge = '';
    if (m.role === "assistant"){
      const key = m.id;
      const val = ratings[key] || ratings[m.meta?.server_id];
      rateBadge = val==="up" ? '<span class="tag good">ğŸ‘</span>'
               : val==="down" ? '<span class="tag bad">ğŸ‘</span>' : '';
    }

    return `
      <div class="row" style="align-items:flex-start">
        <div class="tag">${tag}</div>
        ${rt}
        <div class="muted mono">${fmt(m.ts)}</div>
      </div>
      <div style="margin:6px 0 12px 0; background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px">
        <div style="white-space:pre-wrap">${escapeHtml(m.content||"")}</div>
        ${m.model?`<div class="muted mono" style="margin-top:6px">model: ${escapeHtml(m.model||"")}</div>`:""}
        ${m.web?`<div class="muted mono">web: on</div>`:""}
      </div>
    `;
  }).join("");
  chatDetail.innerHTML = `
    <div class="row">
      <div class="tag">Ú©Ø§Ø±Ø¨Ø±: <b class="mono" style="margin-inline-start:6px">${escapeHtml(chat.uid||"-")}</b></div>
      <div class="tag">Ø§ÛŒØ¬Ø§Ø¯: <b class="mono" style="margin-inline-start:6px">${fmt(chat.createdAt)}</b></div>
      <div class="tag">Ø¢Ø®Ø±ÛŒÙ†: <b class="mono" style="margin-inline-start:6px">${fmt(chat.updatedAt)}</b></div>
      <button class="btn" id="delThis">Ø­Ø°Ù Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ</button>
    </div>
    <div class="hr"></div>
    ${msgs || "<div class='muted'>â€” Ù¾ÛŒØ§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ â€”</div>"}
  `;
  $("delThis").onclick = ()=> delChat(chatId,true);
}
async function delChat(chatId, refreshDetail=false){
  if (!confirm("Ø­Ø°Ù Ø§ÛŒÙ† Ú¯ÙØªâ€ŒÙˆÚ¯ÙˆØŸ")) return;
  await jpost("/admin/deleteChat",{ chatId });
  await loadChatsFor(userList.value);
  if (refreshDetail) chatDetail.innerHTML="";
}

// Export per user
exportUser.onclick = async()=>{
  const uid=userList.value;
  const data = await jget("/admin/export?uid="+encodeURIComponent(uid));
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=`export_${uid}.json`; a.click();
  URL.revokeObjectURL(url);
};


// Analytics
async function loadStats(){
  const s = await jget("/admin/summary");
  statChats.textContent = s.chats||0;
  statMsgs.textContent = s.messages||0;
  statClicks.textContent = s.clicks||0;
  statUsers.textContent = s.users||0;
}
refreshStats.onclick = loadStats;

resetAll.onclick = async()=>{
  if (!confirm("Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ² Ø±ÛŒØ³Øª Ø´ÙˆØ¯ØŸ (ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª)")) return;
  const r = await jpost("/admin/reset",{ confirm:true });
  alert(r?.ok?"Ø±ÛŒØ³Øª Ø´Ø¯":"Ø®Ø·Ø§");
  await loadUsers(); await loadStats();
  chatsTableWrap.innerHTML=""; chatDetail.innerHTML="";
};

exportAll.onclick = async()=>{
  const data = await jget("/admin/export");
  exportBox.textContent = JSON.stringify(data,null,2);
};

// Boot
loadUsers();
loadStats();

// DOM refs
const last30Chats = document.getElementById("last30Chats");
const last30Msgs  = document.getElementById("last30Msgs");
const todayChats  = document.getElementById("todayChats");
const todayMsgs   = document.getElementById("todayMsgs");
const todayUsers  = document.getElementById("todayUsers");
const weekChart   = document.getElementById("weekChart");
const modelsBox   = document.getElementById("modelsBox");

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡
async function loadStatsPlus(){
  try{
    const r = await fetch(API + "/admin/analyticsPlus");
    const j = await r.json();
    last30Chats.textContent = j?.last30?.chats ?? 0;
    last30Msgs.textContent  = j?.last30?.msgs ?? 0;
    todayChats.textContent  = j?.today?.chats ?? 0;
    todayMsgs.textContent   = j?.today?.msgs ?? 0;
    todayUsers.textContent  = j?.today?.users ?? 0;

    // Ù…Ø¯Ù„â€ŒÙ‡Ø§
    const models = j?.models || {};
    const lines = Object.keys(models).sort((a,b)=> (models[b]-models[a])).map(k=> `${k}: ${models[k]}`);
    modelsBox.textContent = lines.join("\n") || "-";

    // Ù†Ù…ÙˆØ¯Ø§Ø± Ù‡ÙØªÚ¯ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø§ Canvas
    let buckets = j?.week?.buckets ?? [0,0,0,0,0,0,0];
if (!Array.isArray(buckets) && buckets && typeof buckets==='object'){
  // ØªØ±ØªÛŒØ¨: Ø´Ù†Ø¨Ù‡..Ø¬Ù…Ø¹Ù‡  => Ø§Ù†Ø¯ÛŒØ³â€ŒÙ‡Ø§ÛŒ 0..6
  buckets = [0,1,2,3,4,5,6].map(i => Number(buckets[i]||0));
}

    const ctx = weekChart.getContext("2d");
    ctx.clearRect(0,0,weekChart.width,weekChart.height);
    const w = weekChart.width, h = weekChart.height;
    const pad = 24;
    const bw = (w - pad*2) / buckets.length * 0.7;
    const space = (w - pad*2) / buckets.length;
    const max = Math.max(1, ...buckets);
    // Ù…Ø­ÙˆØ±
    ctx.strokeStyle = "#cbd5e1"; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
    // Ù…ÛŒÙ„Ù‡â€ŒÙ‡Ø§
    ctx.fillStyle = "#0f172a";
    for (let i=0;i<buckets.length;i++){
      const x = pad + i*space + (space-bw)/2;
      const val = buckets[i];
      const bh = Math.round((h - pad*2) * (val/max));
      ctx.fillRect(x, h-pad-bh, bw, bh);
      // Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§
      ctx.fillStyle="#64748b"; ctx.font="12px IRANYekanX, Tahoma";
      const lbl = ["Ø´","ÛŒ","Ø¯","Ø³","Ú†","Ù¾","Ø¬"][i];
      ctx.fillText(lbl, x+bw/2-6, h-pad+16);
      ctx.fillStyle="#0f172a";
    }
  }catch(e){ console.log(e); }
}

// ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¯Ø± Ø¨ÙˆØª Ùˆ Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Refresh
loadStatsPlus();
refreshStats.addEventListener("click", ()=>{
  loadStats();    // Ù‚Ø¯ÛŒÙ…ÛŒ
  loadStatsPlus();// Ø¬Ø¯ÛŒØ¯
});

</script>

<!-- Ø¯Ú©Ù…Ù‡ Ùˆ Ù¾Ø§Ù†Ù„ Â«Ù…Ø´Ø§Ù‡Ø¯Ù‡â€ŒÛŒ Ù‡Ù…Ù‡â€ŒÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§Â» -->
<div class="panel" id="allPanel" style="display:none"></div>
<div class="panel" id="livePanel" style="display:none"></div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø­Ø°Ù Ú¯ÙØªÚ¯Ùˆ -->
<div class="modal" id="delModal" aria-hidden="true">
  <div class="modal-card">
    <h3>Ø­Ø°Ù Ú¯ÙØªÚ¯Ùˆ</h3>
    <p>Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ</p>
    <div class="actions">
      <button class="link ghost" id="delCancel">Ù„ØºÙˆ</button>
      <button class="link ghost" id="delAdminOnly">Ø­Ø°Ù ÙÙ‚Ø· Ø¯Ø± ØµÙØ­Ù‡â€ŒÛŒ Ù…Ø¯ÛŒØ±ÛŒØª</button>
      <button class="link" id="delEverywhere">Ø­Ø°Ù Ù‡Ù… Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ù‡Ù… Ù†Ø²Ø¯ Ú©Ø§Ø±Ø¨Ø±</button>
    </div>
  </div>
</div>

<!-- Ø§Ø³Ù†Ú©â€ŒØ¨Ø§Ø± ÙˆØ§Ú¯Ø±Ø¯ -->
<div class="snack" id="snack">
  <div class="snack-inner">
    <span id="snackText"></span>
    <button id="snackUndo">ÙˆØ§Ú¯Ø±Ø¯</button>
  </div>
</div>

<script>
  const allPanel = document.getElementById("allPanel");
  const btnAll   = document.getElementById("btnAll");
  const delModal = document.getElementById("delModal");
  const delCancel = document.getElementById("delCancel");
  const delAdminOnly = document.getElementById("delAdminOnly");
  const delEverywhere = document.getElementById("delEverywhere");
  const snack = document.getElementById("snack");
  const snackText = document.getElementById("snackText");
  const snackUndo = document.getElementById("snackUndo");
  
  // Ù…Ø®ÙÛŒâ€ŒØ³Ø§Ø²ÛŒ ÙÙ‚Ø· Ø¯Ø± Ø§Ø¯Ù…ÛŒÙ† (Ù„ÙˆÚ©Ø§Ù„)
  const KEY_HIDDEN = "admin_hidden_chats_v1";
  function loadHidden(){ try{return JSON.parse(localStorage.getItem(KEY_HIDDEN)||"[]")}catch{return[]} }
  function saveHidden(x){ localStorage.setItem(KEY_HIDDEN, JSON.stringify(x||[])); }
  
  let ALL = [];         // Ù‡Ù…Ù‡â€ŒÛŒ Ú†Øªâ€ŒÙ‡Ø§ (Ø¨Ø§ uid)
  let SELECTED = null;  // Ú†Øª Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù
  let UNDO = null;      // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª Â«Ø­Ø°Ù Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØªÂ» Ù‚Ø§Ø¨Ù„ ÙˆØ§Ú¯Ø±Ø¯ Ø§Ø³Øª
  
  function fmt(ts){
    if(!ts) return "-";
    try{
      return new Intl.DateTimeFormat('fa-IR-u-ca-persian', {dateStyle:"medium", timeStyle:"short"}).format(new Date(ts));
    }catch{ return new Date(ts).toLocaleString('fa-IR'); }
  }
  
  // Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø± Ø´Ø¯Ù† Ú†Øªâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø±ÛŒâ€ŒØ§Ú©Øª/Ø±Ø£ÛŒ Ø¯Ø§Ø±Ù†Ø¯
  function hasRatings(ratingsMap){ return ratingsMap && Object.keys(ratingsMap).length > 0; }
  
  // Ø±Ù†Ø¯Ø±
  function renderAll(list){
    const hidden = new Set(loadHidden());
    const wrap = document.createElement("div");
    wrap.innerHTML = `
      <div class="row">
        <h3 style="margin:0">Ù‡Ù…Ù‡â€ŒÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</h3>
        <span class="badge" id="allCount"></span>
      </div>
      <div class="search">
        <input id="allQuery" placeholder="Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù†ØŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ùˆ Ø­ØªÛŒ Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§â€¦">
        <button class="link ghost" id="allRefresh">Ù†ÙˆØ³Ø§Ø²ÛŒ</button>
      </div>
      <div class="list" id="allList"></div>
    `;
    allPanel.innerHTML = "";
    allPanel.appendChild(wrap);
  
    const listEl = document.getElementById("allList");
    const countEl = document.getElementById("allCount");
    const qEl = document.getElementById("allQuery");
    const refreshBtn = document.getElementById("allRefresh");
  
    function draw(rows){
      listEl.innerHTML = "";
      countEl.textContent = `${rows.length} Ú¯ÙØªÚ¯Ùˆ`;
      rows.forEach(r=>{
        if (hidden.has(r.chatId)) return;
        const item = document.createElement("div");
        item.className = "item";
        const left = document.createElement("div");
// Ø³ØªØ§Ø±Ù‡ Ø±Ø§ Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø¨Ø±ÙˆØ¯ Ú©Ù†Ø§Ø± Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
left.innerHTML = `
  <div>
    <b>${r.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"}</b>
    <div class="meta">Ú©Ø§Ø±Ø¨Ø±: ${r.uid} | Ø³Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡: ${fmt(r.createdAt)} | Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: ${fmt(r.updatedAt)}</div>
  </div>
`;

const right = document.createElement("div");
right.className = "row";

const openBtn = document.createElement("button");
openBtn.className = "link ghost";
openBtn.textContent = "Ù†Ù…Ø§ÛŒØ´";
openBtn.onclick = ()=> openChat(r);

const delBtn = document.createElement("button");
delBtn.className = "link";
delBtn.textContent = "Ø­Ø°Ù";
delBtn.onclick = ()=> openDel(r);

if (r._hasRatings) {
  const starEl = document.createElement("span");
  starEl.className = "star";     // Ù‡Ù…ÛŒÙ† Ú©Ù„Ø§Ø³ Ø¯Ø± <style> ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡
  starEl.textContent = "â˜…";
  // Ø¨ÛŒØ§Ø± Ø¯Ø±Ø³Øª Ú©Ù†Ø§Ø±Ù Â«Ù†Ù…Ø§ÛŒØ´Â»
  right.appendChild(starEl);
}
// Ø§ÙˆÙ„ Ø¯Ú©Ù…Ù‡Ù” Ù†Ù…Ø§ÛŒØ´ Ø±Ø§ Ù…ÛŒâ€ŒÚ†ÛŒÙ†ÛŒÙ…
right.appendChild(openBtn);

// Ø§Ú¯Ø± Ø±Ø£ÛŒ Ø¯Ø§Ø±Ø¯ØŒ Ø³ØªØ§Ø±Ù‡ Ø±Ø§ Â«Ø¨Ø¹Ø¯ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ùˆ Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø°ÙÂ» Ø¨Ú¯Ø°Ø§Ø±


// Ø¢Ø®Ø± Ù‡Ù… Ø¯Ú©Ù…Ù‡Ù” Ø­Ø°Ù
right.appendChild(delBtn);

item.appendChild(left);
item.appendChild(right);

        listEl.appendChild(item);
      });
    }
  
    function filter(){
      const q = (qEl.value||"").trim().toLowerCase();
      if(!q) return draw(list);
      const hits = list.filter(r=>{
        // Ø¬Ø³Øªâ€ŒÙˆØ¬ÙˆÛŒ Ú¯Ø³ØªØ±Ø¯Ù‡: Ø¹Ù†ÙˆØ§Ù†ØŒ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ØŒ Ù‡Ù…Ù‡â€ŒÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ùˆ Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§
        const hay = (
          (r.title||"") + " " +
          (r.preview||"") + " " +
          (r._allText || "") + " " +
          (r.chatId||"") + " " +
          (r.uid||"")
        ).toLowerCase();
        return hay.includes(q);
      });
      draw(hits);
    }
  
    qEl.oninput = filter;
    refreshBtn.onclick = loadAll;
    draw(list);
  }
  
  async function loadAll(){
  // 1) Ø§ÙˆÙ„ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
  const ru = await fetch(API + "/admin/users");
  const ju = await ru.json();

  const rows = [];
  // 2) Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø±ØŒ Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§
  for (const u of (ju.users||[])){
    try{
      const rc = await fetch(API + "/admin/chats?uid=" + encodeURIComponent(u.uid));
      const jc = await rc.json();
      for (const c of (jc.chats||[])){
        // Ø³ØªØ§Ø±Ù‡ Ø±Ø§ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¨Ø§ Ú¯Ø±ÙØªÙ† Ø±ÛŒØªÛŒÙ†Ú¯ Ù‡Ø± Ú†Øª Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ø²Ø´Ø¯Ù† Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… ÛŒØ§ Ø³Ø§Ø¯Ù‡: false
        rows.push({
          uid: u.uid,
          chatId: c.chatId,
          createdAt: c.createdAt,
          updatedAt: c.updatedAt,
          title: c.title,
          preview: (c.preview||""),
          _hasRatings: false,
          _allText: ""   // Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²ØŒ Ù…ÙˆÙ‚Ø¹ openChat ØªÚ©Ù…ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        });
      }
    }catch{}
  }
  rows.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
  ALL = rows;

  // Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ± Ù¾Ù†Ù„â€ŒÙ‡Ø§
  document.getElementById("viewChats").style.display = "none";
  document.getElementById("viewAnalytics").style.display = "none";
  document.getElementById("tabChats").classList.remove("active");
  document.getElementById("tabAnalytics").classList.remove("active");

  allPanel.style.display = "block";
  renderAll(rows);
}

  
  // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ÛŒÚ© Ú¯ÙØªâ€ŒÙˆÚ¯Ùˆ (Ø¯Ø± Ù‡Ù…Ø§Ù† Ù¾Ù†Ù„ØŒ Ø³Ø§Ø¯Ù‡)
  async function openChat(row){
    const r = await fetch(API + "/admin/chat?chatId=" + encodeURIComponent(row.chatId));
const j = await r.json();

    const c = j.chat || {};
    const ratings = j.ratings || {};
    // Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø± (Ù†Ù…Ø§ÛŒØ´ÛŒ): index+1 Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ±ØªÛŒØ¨ ALL (Ø¨Ø±Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒâ€ŒØ§Ø´ Ø¨Ø§ÛŒØ¯ Ø³Ø±ÙˆØ± message-id Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡Ø¯)
    const userCode = 1 + [...new Set(ALL.map(x=>x.uid))].indexOf(row.uid);
  
    const box = document.createElement("div");
    box.className = "panel";
    const msgs = (c.messages||[]).map((m,i)=>{
  const codeId = `${userCode}-${i+1}`;
  const rt = ratings[m.id]==="up" ? ' <span class="tag good">ğŸ‘</span>' :
            ratings[m.id]==="down" ? ' <span class="tag bad">ğŸ‘</span>' : '';
  return `
    <div style="border:1px solid #e5e7eb; border-radius:10px; padding:8px; margin-bottom:8px">
      <div class="meta">${m.role === "assistant" ? "Ø¯Ø³ØªÛŒØ§Ø±" : "Ú©Ø§Ø±Ø¨Ø±"} ${rt} | Ø´Ù†Ø§Ø³Ù‡: ${codeId} <span style="opacity:.6">(${m.id})</span> | ${fmt(m.ts)} ${m.model?(" | Ù…Ø¯Ù„: "+m.model):""} ${m.web? " | ÙˆØ¨": ""}</div>
      <div>${(m.content||"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
    </div>
  `;
}).join("");

  
    box.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <b>${row.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"}</b>
          <div class="meta">Ú©Ø§Ø±Ø¨Ø±: ${row.uid} (Ú©Ø¯: ${userCode}) | Ø³Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡: ${fmt(c.createdAt)} | Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: ${fmt(c.updatedAt)}</div>
        </div>
        <div class="row">
          <button class="link ghost" id="allClose">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
          <button class="link" onclick='(${openDel.toString()})(${JSON.stringify(row)})'>Ø­Ø°Ù</button>
          
        </div>
      </div>
      <hr style="border:none;border-top:1px dashed #e5e7eb; margin:10px 0">
      ${msgs || "<div class='meta'>Ù¾ÛŒØ§Ù…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>"}
    `;
    allPanel.innerHTML = "";
    allPanel.appendChild(box);
    allPanel.style.display = "block";
    const allCloseBtn = document.getElementById("allClose");
if (allCloseBtn) allCloseBtn.onclick = ()=> renderAll(ALL);

  }
  
  // Ù¾Ù†Ø¬Ø±Ù‡ Ø­Ø°Ù
  function openDel(row){
    SELECTED = row;
    delModal.classList.add("show");
    delModal.setAttribute("aria-hidden","false");
  }
  function closeDel(){
    delModal.classList.remove("show");
    delModal.setAttribute("aria-hidden","true");
  }
  delCancel.onclick = closeDel;
  
  function showSnack(text, onUndo){
    snackText.textContent = text;
    snack.style.display = "flex";
    snackUndo.onclick = ()=>{
      snack.style.display = "none";
      onUndo && onUndo();
    };
    setTimeout(()=> snack.style.display="none", 4000);
  }
  
  // Ø­Ø°Ù ÙÙ‚Ø· Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª (Ù„ÙˆÚ©Ø§Ù„)
  delAdminOnly.onclick = ()=>{
    const h = loadHidden();
    if (SELECTED){
      h.push(SELECTED.chatId);
      saveHidden(h);
      UNDO = ()=>{ saveHidden(loadHidden().filter(x=>x !== SELECTED.chatId)); loadAll(); };
      showSnack("Ø´Ù…Ø§ Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø­Ø°Ù Ú©Ø±Ø¯ÛŒØ¯ | ÙˆØ§Ú¯Ø±Ø¯", UNDO);
      loadAll();
    }
    closeDel();
  };
  
  // Ø­Ø°Ù Ú©Ø§Ù…Ù„ (Ø³Ø±ÙˆØ± + Ú©Ø§Ø±Ø¨Ø±) â€” ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Â«ÙˆØ§Ú¯Ø±Ø¯ Ù†Ø¯Ø§Ø±Ø¯Â» Ú†ÙˆÙ† ÙˆÙˆØ±Ú©Ø± Ø§Ù„Ø§Ù† API Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ù†Ø¯Ø§Ø±Ø¯
  delEverywhere.onclick = async ()=>{
    if (!SELECTED) return;
    try{
      const r = await fetch(API + "/admin/deleteChat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ chatId: SELECTED.chatId })
      });
      const j = await r.json();
      if (j?.ok){
        showSnack("Ú¯ÙØªÚ¯Ùˆ Ø­Ø°Ù Ø´Ø¯ (ØºÛŒØ±Ù‚Ø§Ø¨Ù„ ÙˆØ§Ú¯Ø±Ø¯)", null);
        loadAll();
      } else {
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±: " + (j?.error||""));
      }
    }catch(e){
      alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡");
    }
    closeDel();
  };
  
  // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Â«Ù…Ø´Ø§Ù‡Ø¯Ù‡â€ŒÛŒ Ù‡Ù…Ù‡â€ŒÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§Â»
  btnAll && (btnAll.onclick = loadAll);
  const livePanel = document.getElementById("livePanel");
const btnLive   = document.getElementById("btnLive");
let LIVE_TIMER = null, LIVE_SINCE = 0;

function renderLiveBox(){
  livePanel.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">Ù…Ø§Ù†ÛŒØªÙˆØ± Ø²Ù†Ø¯Ù‡</h3>
      <button class="link ghost" id="liveBack">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>
    <div id="liveBody" class="mono" style="max-height:70vh; overflow:auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px"></div>
  `;
  const back = document.getElementById("liveBack");
  back.onclick = ()=>{
    clearInterval(LIVE_TIMER);
    livePanel.style.display = "none";
    viewChats.style.display = "block";
    tabChats.classList.add("active");
  };
}

async function pollLive(){
  try{
    const r = await fetch(API + "/admin/live?since=" + LIVE_SINCE);
    const j = await r.json();
    const body = document.getElementById("liveBody");
    (j.events||[]).reverse().forEach(ev=>{
      const line = `[${new Date(ev.ts).toLocaleTimeString("fa-IR")}] ${ev.type} ${ev.chatId||""} ${ev.role||""}`;
      const div = document.createElement("div"); div.textContent = line;
      body.prepend(div);
    });
    LIVE_SINCE = j.now || Date.now();
  }catch{}
}

btnLive.onclick = ()=>{
  // Ø¨Ø³ØªÙ† Ø³Ø§ÛŒØ± Ù¾Ù†Ù„â€ŒÙ‡Ø§
  document.getElementById("viewChats").style.display = "none";
  document.getElementById("viewAnalytics").style.display = "none";
  document.getElementById("allPanel").style.display = "none";

  livePanel.style.display = "block";
  renderLiveBox();
  clearInterval(LIVE_TIMER);
  LIVE_SINCE = 0;
  pollLive();
  LIVE_TIMER = setInterval(pollLive, 2000);
};

  </script>
  <!-- Ù…ÙˆØ¯Ø§Ù„ Ù„Ø§Ú¯ÛŒÙ†â€ŒÙ‡Ø§ -->
<div class="modal" id="loginsModal" aria-hidden="true">
  <div class="modal-card">
    <h3>Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±</h3>
    <div id="loginsBody" class="mono" style="max-height:50vh;overflow:auto"></div>
    <div class="actions">
      <button class="link" id="loginsClose">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ù†ÙˆØª Ø®ØµÙˆØµÛŒ -->
<div class="modal" id="notesModal" aria-hidden="true">
  <div class="modal-card">
    <h3>Ù†ÙˆØª Ø®ØµÙˆØµÛŒ Ø§Ø¯Ù…ÛŒÙ†</h3>
    <textarea id="notesText" rows="6" style="width:100%"></textarea>
    <div class="actions">
      <button class="link ghost" id="notesCancel">Ù„ØºÙˆ</button>
      <button class="link" id="notesSave">Ø°Ø®ÛŒØ±Ù‡</button>
    </div>
  </div>
</div>

</body>
</html>
